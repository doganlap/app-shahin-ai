@page
@using Microsoft.Extensions.Localization
@using Grc.Localization
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@model Grc.Web.Pages.Evidence.IndexModel
@inject IStringLocalizer<GrcResource> L
@section styles {
    <abp-style-bundle>
        <abp-style src="/Pages/Evidence/Index.css" />
    </abp-style-bundle>
}

<abp-card>
    <abp-card-header>
        <abp-row>
            <abp-column size-md="_8">
                <h2>
                    <i class="fas fa-folder-open text-primary"></i>
                    @L["Menu:Evidence"]
                </h2>
                <p class="text-muted">@L["Evidence:Description"]</p>
            </abp-column>
            <abp-column size-md="_4" class="text-end">
                <abp-button button-type="Primary" icon="fas fa-upload" id="UploadButton" text="@L["Upload"]" size="Large" />
            </abp-column>
        </abp-row>
    </abp-card-header>
    <abp-card-body>
        <!-- Filter Bar -->
        <abp-row class="mb-3">
            <abp-column size-md="_4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="SearchInput" placeholder="@L["SearchEvidence"]..." />
                </div>
            </abp-column>
            <abp-column size-md="_3">
                <select id="FileTypeFilter" class="form-select">
                    <option value="">@L["AllFileTypes"]</option>
                    <option value="pdf">PDF Documents</option>
                    <option value="image">Images</option>
                    <option value="doc">Word Documents</option>
                    <option value="excel">Excel Spreadsheets</option>
                </select>
            </abp-column>
            <abp-column size-md="_3">
                <select id="DateFilter" class="form-select">
                    <option value="">@L["AllDates"]</option>
                    <option value="today">@L["Today"]</option>
                    <option value="week">@L["ThisWeek"]</option>
                    <option value="month">@L["ThisMonth"]</option>
                </select>
            </abp-column>
            <abp-column size-md="_2" class="text-end">
                <abp-button button-type="Info" icon="fas fa-filter" id="ApplyFiltersButton" text="@L["Filter"]" />
            </abp-column>
        </abp-row>

        <!-- Evidence Grid -->
        <abp-row id="EvidenceGrid">
            @foreach (var evidence in Model.Evidences)
            {
                <abp-column size-md="_4" size-lg="_3" class="mb-3">
                    <div class="card evidence-card h-100">
                        <div class="card-body">
                            <div class="text-center mb-3">
                                @{
                                    var iconClass = evidence.FileType.Contains("pdf") ? "fa-file-pdf text-danger" :
                                                   evidence.FileType.Contains("image") ? "fa-file-image text-info" :
                                                   evidence.FileType.Contains("word") ? "fa-file-word text-primary" :
                                                   evidence.FileType.Contains("excel") || evidence.FileType.Contains("spreadsheet") ? "fa-file-excel text-success" :
                                                   "fa-file text-secondary";
                                }
                                <i class="fas @iconClass fa-4x"></i>
                            </div>
                            <h6 class="card-title text-truncate" title="@evidence.FileName">@evidence.FileName</h6>
                            <p class="card-text small text-muted">@evidence.Description</p>
                            <div class="evidence-meta">
                                <small class="text-muted d-block">
                                    <i class="fas fa-file-alt"></i> @evidence.FileSize.ToString("F2") MB
                                </small>
                                <small class="text-muted d-block">
                                    <i class="fas fa-user"></i> @evidence.UploadedBy
                                </small>
                                <small class="text-muted d-block">
                                    <i class="fas fa-calendar"></i> @evidence.UploadDate.ToString("MMM dd, yyyy")
                                </small>
                                @if (!string.IsNullOrEmpty(evidence.LinkedTo))
                                {
                                    <small class="text-muted d-block">
                                        <i class="fas fa-link"></i> @evidence.LinkedTo
                                    </small>
                                }
                            </div>
                            <div class="mt-2">
                                @foreach (var tag in evidence.Tags.Take(3))
                                {
                                    <span class="badge bg-secondary me-1">@tag</span>
                                }
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-sm btn-primary view-btn" data-id="@evidence.Id">
                                    <i class="fas fa-eye"></i> @L["View"]
                                </button>
                                <button class="btn btn-sm btn-success download-btn" data-id="@evidence.Id">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="@evidence.Id">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </abp-column>
            }
        </abp-row>

        @if (!Model.Evidences.Any())
        {
            <abp-row>
                <abp-column>
                    <div class="text-center py-5">
                        <i class="fas fa-folder-open fa-5x text-muted mb-3"></i>
                        <h4>@L["NoEvidence"]</h4>
                        <p class="text-muted">@L["NoEvidence:Message"]</p>
                        <abp-button button-type="Primary" icon="fas fa-upload" id="UploadButtonEmpty" text="@L["UploadFirstEvidence"]" size="Large" />
                    </div>
                </abp-column>
            </abp-row>
        }
    </abp-card-body>
</abp-card>

<!-- Upload Modal -->
<abp-modal id="UploadModal" size="Large">
    <abp-modal-header title="@L["UploadEvidence"]"></abp-modal-header>
    <abp-modal-body>
        <form id="UploadForm" enctype="multipart/form-data">
            <abp-input asp-for="@(new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem().Value)" 
                       id="FileInput" 
                       type="file" 
                       label="@L["SelectFile"]" 
                       required="true" />
            
            <div class="mb-3">
                <label class="form-label">@L["Description"]</label>
                <textarea id="DescriptionInput" class="form-control" rows="3" placeholder="@L["EnterDescription"]..."></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">@L["LinkToAssessment"] (@L["Optional"])</label>
                <select id="AssessmentSelect" class="form-select">
                    <option value="">@L["None"]</option>
                    <option value="assessment1">NCA-ECC Assessment</option>
                    <option value="assessment2">SAMA-CSF Assessment</option>
                    <option value="assessment3">ISO 27001 Audit</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">@L["Tags"] (@L["Optional"])</label>
                <input type="text" id="TagsInput" class="form-control" placeholder="@L["EnterTags"]..." />
                <small class="text-muted">@L["SeparateTagsWithCommas"]</small>
            </div>

            <!-- Drag & Drop Zone -->
            <div id="DropZone" class="drop-zone text-center p-5 border border-2 border-dashed rounded">
                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                <h5>@L["DragDropFiles"]</h5>
                <p class="text-muted">@L["Or"] <label for="FileInput" class="text-primary" style="cursor: pointer;">@L["ClickToSelect"]</label></p>
                <small class="text-muted">@L["MaxFileSize"]: 50 MB</small>
            </div>

            <!-- Upload Progress -->
            <div id="UploadProgress" class="mt-3" style="display: none;">
                <div class="progress">
                    <div id="ProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"></div>
                </div>
                <small id="ProgressText" class="text-muted"></small>
            </div>
        </form>
    </abp-modal-body>
    <abp-modal-footer buttons="@(AbpModalButtons.Save | AbpModalButtons.Close)"></abp-modal-footer>
</abp-modal>

@section scripts {
    <abp-script-bundle>
        <abp-script src="/Pages/Evidence/Index.js" />
    </abp-script-bundle>
}

