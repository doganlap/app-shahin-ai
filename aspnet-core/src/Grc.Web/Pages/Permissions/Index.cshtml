@page
@model Grc.Web.Pages.Permissions.IndexModel
@inject IHtmlLocalizer<Grc.Localization.GrcResource> L
@{
    ViewBag.Title = L["Menu:Permissions"];
}

@section styles {
    <style>
        .permission-group {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .permission-group-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        .permission-group-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        .permission-group-body {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .permission-group-body.show {
            max-height: 2000px;
        }
        .permission-item {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .permission-item:last-child {
            border-bottom: none;
        }
        .permission-item:hover {
            background-color: #f8f9fa;
        }
        .permission-item.parent-permission {
            background-color: #fff3cd;
            font-weight: 600;
        }
        .permission-name {
            flex: 1;
        }
        .permission-name small {
            color: #6c757d;
            display: block;
            font-size: 0.75rem;
        }
        .group-stats {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .group-stats .granted {
            color: #28a745;
            font-weight: bold;
        }
        .role-card {
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .role-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
        }
        .role-card.active {
            border-color: #007bff;
            background-color: #e7f1ff;
        }
        .stats-badge {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 26px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #28a745;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        .search-box {
            position: relative;
        }
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        .search-box input {
            padding-left: 38px;
        }
    </style>
}

@section scripts {
    <script>
        $(function() {
            // Toggle permission groups
            $('.permission-group-header').on('click', function() {
                var $body = $(this).next('.permission-group-body');
                var $icon = $(this).find('.toggle-icon');
                $body.toggleClass('show');
                $icon.toggleClass('fa-chevron-down fa-chevron-up');
            });

            // Select all in group
            $('.select-all-group').on('click', function(e) {
                e.stopPropagation();
                var groupName = $(this).data('group');
                var $checkboxes = $('[data-group="' + groupName + '"] input[type="checkbox"]');
                var allChecked = $checkboxes.filter(':checked').length === $checkboxes.length;
                $checkboxes.prop('checked', !allChecked);
                updateGroupStats(groupName);
            });

            // Update stats on checkbox change
            $('input[name="grantedPermissions"]').on('change', function() {
                var groupName = $(this).closest('[data-group]').data('group');
                updateGroupStats(groupName);
                updateTotalStats();
            });

            function updateGroupStats(groupName) {
                var $group = $('[data-group-header="' + groupName + '"]');
                var $checkboxes = $('[data-group="' + groupName + '"] input[type="checkbox"]');
                var total = $checkboxes.length;
                var granted = $checkboxes.filter(':checked').length;
                $group.find('.granted-count').text(granted);
            }

            function updateTotalStats() {
                var $checkboxes = $('input[name="grantedPermissions"]');
                var total = $checkboxes.length;
                var granted = $checkboxes.filter(':checked').length;
                $('#grantedCount').text(granted);
            }

            // Search permissions
            $('#permissionSearch').on('keyup', function() {
                var searchText = $(this).val().toLowerCase();
                $('.permission-item').each(function() {
                    var text = $(this).text().toLowerCase();
                    $(this).toggle(text.includes(searchText));
                });
                // Show groups that have visible items
                $('.permission-group').each(function() {
                    var hasVisible = $(this).find('.permission-item:visible').length > 0;
                    $(this).toggle(hasVisible);
                });
            });

            // Form submission
            $('#permissionsForm').on('submit', function(e) {
                e.preventDefault();
                var $btn = $(this).find('button[type="submit"]');
                var originalText = $btn.html();
                $btn.html('<i class="fas fa-spinner fa-spin"></i> Saving...').prop('disabled', true);

                $.ajax({
                    url: $(this).attr('action'),
                    method: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.success) {
                            abp.notify.success(response.message);
                        } else {
                            abp.notify.error(response.message);
                        }
                    },
                    error: function() {
                        abp.notify.error('An error occurred while saving permissions.');
                    },
                    complete: function() {
                        $btn.html(originalText).prop('disabled', false);
                    }
                });
            });

            // Expand first group by default
            $('.permission-group-body').first().addClass('show');
            $('.permission-group-header').first().find('.toggle-icon').removeClass('fa-chevron-down').addClass('fa-chevron-up');
        });
    </script>
}

<abp-card>
    <abp-card-header>
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-shield-alt text-primary"></i> @L["Menu:Permissions"]</h2>
            @if (Model.SelectedRoleId != null)
            {
                <div class="text-muted">
                    <span class="badge bg-primary fs-6">@Model.TotalPermissionCount total</span>
                    <span class="badge bg-success fs-6" id="grantedCount">@Model.GrantedPermissionCount</span> granted
                </div>
            }
        </div>
    </abp-card-header>
    <abp-card-body>
        <div class="row">
            <!-- Roles Panel -->
            <div class="col-lg-3 col-md-4 mb-4">
                <h5 class="mb-3"><i class="fas fa-users-cog"></i> Roles</h5>
                <div class="list-group">
                    @foreach (var role in Model.Roles)
                    {
                        <a href="?SelectedRoleId=@role.Id" 
                           class="list-group-item list-group-item-action role-card @(Model.SelectedRoleId == role.Id ? "active" : "")">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-user-tag me-2"></i>
                                    <strong>@role.Name</strong>
                                </div>
                                <span class="badge bg-@(role.PermissionCount > 0 ? "success" : "secondary") rounded-pill">
                                    @role.PermissionCount
                                </span>
                            </div>
                        </a>
                    }
                </div>
            </div>

            <!-- Permissions Panel -->
            <div class="col-lg-9 col-md-8">
                @if (Model.SelectedRoleId != null && Model.SelectedRoleName != null)
                {
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-key"></i> Permissions for <strong class="text-primary">@Model.SelectedRoleName</strong></h5>
                    </div>

                    <!-- Search Box -->
                    <div class="search-box mb-3">
                        <i class="fas fa-search"></i>
                        <input type="text" id="permissionSearch" class="form-control" placeholder="Search permissions...">
                    </div>

                    <form id="permissionsForm" method="post" asp-page-handler="UpdatePermissions">
                        <input type="hidden" name="roleId" value="@Model.SelectedRoleId" />
                        @Html.AntiForgeryToken()

                        <!-- Grouped Permissions -->
                        @foreach (var group in Model.GroupedPermissions.OrderBy(g => g.Key))
                        {
                            <div class="permission-group" data-group="@group.Key">
                                <div class="permission-group-header" data-group-header="@group.Key">
                                    <div>
                                        <i class="@group.Value.Icon me-2"></i>
                                        @group.Value.DisplayName
                                        <span class="group-stats ms-2">
                                            (<span class="granted-count granted">@group.Value.GrantedCount</span> / @group.Value.TotalCount)
                                        </span>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-primary select-all-group me-2" 
                                                data-group="@group.Key" title="Toggle all">
                                            <i class="fas fa-check-double"></i>
                                        </button>
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </div>
                                </div>
                                <div class="permission-group-body" data-group="@group.Key">
                                    @foreach (var permission in group.Value.Permissions)
                                    {
                                        <div class="permission-item @(permission.IsParent ? "parent-permission" : "")">
                                            <div class="permission-name">
                                                @permission.DisplayName
                                                <small>@permission.Name</small>
                                            </div>
                                            <label class="toggle-switch">
                                                <input type="checkbox" 
                                                       name="grantedPermissions" 
                                                       value="@permission.Name"
                                                       @(permission.IsGranted ? "checked" : "") />
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <div class="mt-4 d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Save Permissions
                            </button>
                            <a href="?SelectedRoleId=@Model.SelectedRoleId" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-undo"></i> Reset
                            </a>
                        </div>
                    </form>
                }
                else
                {
                    <div class="text-center text-muted p-5">
                        <i class="fas fa-hand-point-left fa-4x mb-4 text-primary"></i>
                        <h4>Select a Role</h4>
                        <p>Choose a role from the left panel to manage its permissions.</p>
                    </div>
                }
            </div>
        </div>
    </abp-card-body>
</abp-card>

