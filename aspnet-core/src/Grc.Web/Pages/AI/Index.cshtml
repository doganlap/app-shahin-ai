@page
@using Microsoft.Extensions.Localization
@using Grc.Localization
@model Grc.Web.Pages.AI.IndexModel
@inject IStringLocalizer<GrcResource> L

<style>
    .ai-card {
        border-radius: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .ai-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .chat-container {
        height: 400px;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }
    .chat-message {
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 85%;
    }
    .chat-message.user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
    }
    .chat-message.ai {
        background: white;
        border: 1px solid #e0e0e0;
    }
    .insight-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
    }
    .analysis-result {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
    }
    .risk-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 600;
    }
    .risk-low { background: #d4edda; color: #155724; }
    .risk-medium { background: #fff3cd; color: #856404; }
    .risk-high { background: #f8d7da; color: #721c24; }
    .risk-critical { background: #721c24; color: white; }
    .loading-spinner {
        display: none;
    }
    .loading .loading-spinner {
        display: inline-block;
    }
    .model-select {
        max-width: 200px;
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="insight-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1"><i class="fas fa-brain"></i> AI-Powered GRC Insights</h2>
                        <p class="mb-0 opacity-75">Leverage AI for compliance analysis, risk assessment, and recommendations</p>
                    </div>
                    <div>
                        <select id="modelSelect" class="form-select model-select">
                            <option value="qwen2.5:32b">Qwen 2.5 (32B)</option>
                            <option value="llama3.1:70b">Llama 3.1 (70B)</option>
                            <option value="grc-specialist:latest">GRC Specialist</option>
                            <option value="mistral:latest">Mistral (Fast)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- AI Chat -->
        <div class="col-lg-6 mb-4">
            <div class="card ai-card h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-comments text-primary"></i> GRC AI Assistant</h5>
                </div>
                <div class="card-body">
                    <div id="chatContainer" class="chat-container mb-3">
                        <div class="chat-message ai">
                            <strong>AI Assistant</strong><br>
                            Hello! I'm your GRC AI assistant. I can help you with:
                            <ul class="mb-0 mt-2">
                                <li>Compliance questions (SAMA, NCA, ISO 27001)</li>
                                <li>Risk assessment guidance</li>
                                <li>Control implementation advice</li>
                                <li>Policy and procedure recommendations</li>
                            </ul>
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="chatInput" class="form-control" placeholder="Ask anything about GRC..." />
                        <button id="sendChat" class="btn btn-primary">
                            <span class="loading-spinner spinner-border spinner-border-sm me-1"></span>
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Analysis Tools -->
        <div class="col-lg-6 mb-4">
            <div class="card ai-card h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-magic text-success"></i> Quick Analysis Tools</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-search-plus fa-2x text-primary mb-2"></i>
                                    <h6>Compliance Gap Analysis</h6>
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#gapAnalysisModal">
                                        Analyze
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-shield-alt fa-2x text-warning mb-2"></i>
                                    <h6>Risk Assessment</h6>
                                    <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#riskModal">
                                        Assess
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-tasks fa-2x text-success mb-2"></i>
                                    <h6>Control Implementation</h6>
                                    <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#controlModal">
                                        Guide
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-pie fa-2x text-info mb-2"></i>
                                    <h6>Framework Analysis</h6>
                                    <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#frameworkModal">
                                        Analyze
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Results -->
    <div class="row">
        <div class="col-12">
            <div id="analysisResults" class="card ai-card" style="display: none;">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check text-success"></i> Analysis Results</h5>
                    <span id="riskBadge" class="risk-badge"></span>
                </div>
                <div class="card-body">
                    <div id="analysisContent"></div>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-lightbulb text-warning"></i> Recommendations</h6>
                            <ul id="recommendationsList" class="list-group list-group-flush"></ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-check-circle text-success"></i> Action Items</h6>
                            <ul id="actionItemsList" class="list-group list-group-flush"></ul>
                        </div>
                    </div>
                    <div class="mt-3 text-muted small">
                        <i class="fas fa-robot"></i> Model: <span id="modelUsed"></span> |
                        <i class="fas fa-coins"></i> Tokens: <span id="tokensUsed"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gap Analysis Modal -->
<div class="modal fade" id="gapAnalysisModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-search-plus"></i> Compliance Gap Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Framework</label>
                    <select id="gapFramework" class="form-select">
                        <option value="NCA-ECC">NCA Essential Cybersecurity Controls</option>
                        <option value="SAMA-CSF">SAMA Cyber Security Framework</option>
                        <option value="ISO-27001">ISO 27001</option>
                        <option value="PDPL">Personal Data Protection Law</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Current Status</label>
                    <textarea id="gapStatus" class="form-control" rows="3" placeholder="Describe your current compliance status..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Implemented Controls (comma separated)</label>
                    <input type="text" id="gapControls" class="form-control" placeholder="e.g., AC-1, AC-2, AU-1" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="runGapAnalysis">
                    <span class="loading-spinner spinner-border spinner-border-sm me-1"></span>
                    Analyze
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Risk Assessment Modal -->
<div class="modal fade" id="riskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-shield-alt"></i> Risk Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Risk Description</label>
                    <textarea id="riskDescription" class="form-control" rows="3" placeholder="Describe the risk..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Asset Type</label>
                    <select id="riskAssetType" class="form-select">
                        <option value="Information System">Information System</option>
                        <option value="Data">Data / Database</option>
                        <option value="Network">Network Infrastructure</option>
                        <option value="Application">Application</option>
                        <option value="Physical">Physical Asset</option>
                        <option value="Personnel">Personnel / HR</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Threat Scenario</label>
                    <textarea id="riskThreat" class="form-control" rows="2" placeholder="Describe the threat scenario..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="runRiskAssessment">
                    <span class="loading-spinner spinner-border spinner-border-sm me-1"></span>
                    Assess Risk
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Control Implementation Modal -->
<div class="modal fade" id="controlModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-tasks"></i> Control Implementation Guide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Control ID</label>
                    <input type="text" id="controlId" class="form-control" placeholder="e.g., NCA-ECC-1-1-1" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Control Title</label>
                    <input type="text" id="controlTitle" class="form-control" placeholder="e.g., Access Control Policy" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Control Requirement</label>
                    <textarea id="controlRequirement" class="form-control" rows="3" placeholder="Describe the control requirement..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Organization Type</label>
                    <select id="controlOrgType" class="form-select">
                        <option value="Financial Institution">Financial Institution</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Government">Government</option>
                        <option value="Technology">Technology Company</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Retail">Retail</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="runControlGuide">
                    <span class="loading-spinner spinner-border spinner-border-sm me-1"></span>
                    Get Guide
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Framework Analysis Modal -->
<div class="modal fade" id="frameworkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-chart-pie"></i> Framework Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Framework</label>
                    <select id="frameworkCode" class="form-select">
                        <option value="NCA-ECC" data-name="NCA Essential Cybersecurity Controls">NCA-ECC</option>
                        <option value="SAMA-CSF" data-name="SAMA Cyber Security Framework">SAMA-CSF</option>
                        <option value="ISO-27001" data-name="ISO 27001">ISO 27001</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Total Controls</label>
                    <input type="number" id="frameworkTotal" class="form-control" value="114" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Implemented Controls</label>
                    <input type="number" id="frameworkImplemented" class="form-control" value="45" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="runFrameworkAnalysis">
                    <span class="loading-spinner spinner-border spinner-border-sm me-1"></span>
                    Analyze
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
<script>
    $(function() {
        var apiBase = '/api/app/ai-insights';

        // Chat functionality
        $('#chatInput').keypress(function(e) {
            if (e.which === 13) {
                $('#sendChat').click();
            }
        });

        $('#sendChat').click(function() {
            var message = $('#chatInput').val().trim();
            if (!message) return;

            var model = $('#modelSelect').val();
            var $btn = $(this);

            // Add user message
            $('#chatContainer').append(
                '<div class="chat-message user"><strong>You</strong><br>' + escapeHtml(message) + '</div>'
            );
            $('#chatInput').val('');
            scrollChat();

            $btn.addClass('loading').prop('disabled', true);

            $.ajax({
                url: apiBase + '/chat',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    message: message,
                    context: 'GRC compliance platform',
                    model: model
                }),
                success: function(result) {
                    $('#chatContainer').append(
                        '<div class="chat-message ai"><strong>AI Assistant</strong><br>' +
                        formatResponse(result.response) + '</div>'
                    );
                    scrollChat();
                },
                error: function() {
                    $('#chatContainer').append(
                        '<div class="chat-message ai text-danger"><strong>Error</strong><br>Failed to get response. Please try again.</div>'
                    );
                },
                complete: function() {
                    $btn.removeClass('loading').prop('disabled', false);
                }
            });
        });

        // Gap Analysis
        $('#runGapAnalysis').click(function() {
            var $btn = $(this);
            $btn.addClass('loading').prop('disabled', true);

            $.ajax({
                url: apiBase + '/analyze-compliance-gap',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    frameworkCode: $('#gapFramework').val(),
                    currentStatus: $('#gapStatus').val(),
                    implementedControls: $('#gapControls').val().split(',').map(s => s.trim())
                }),
                success: function(result) {
                    showAnalysisResults(result);
                    $('#gapAnalysisModal').modal('hide');
                },
                error: handleError,
                complete: function() {
                    $btn.removeClass('loading').prop('disabled', false);
                }
            });
        });

        // Risk Assessment
        $('#runRiskAssessment').click(function() {
            var $btn = $(this);
            $btn.addClass('loading').prop('disabled', true);

            $.ajax({
                url: apiBase + '/generate-risk-assessment',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    riskDescription: $('#riskDescription').val(),
                    assetType: $('#riskAssetType').val(),
                    threatScenario: $('#riskThreat').val()
                }),
                success: function(result) {
                    showAnalysisResults(result);
                    $('#riskModal').modal('hide');
                },
                error: handleError,
                complete: function() {
                    $btn.removeClass('loading').prop('disabled', false);
                }
            });
        });

        // Control Implementation
        $('#runControlGuide').click(function() {
            var $btn = $(this);
            $btn.addClass('loading').prop('disabled', true);

            $.ajax({
                url: apiBase + '/suggest-control-implementation',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    controlId: $('#controlId').val(),
                    controlTitle: $('#controlTitle').val(),
                    controlRequirement: $('#controlRequirement').val(),
                    organizationType: $('#controlOrgType').val()
                }),
                success: function(result) {
                    showAnalysisResults(result);
                    $('#controlModal').modal('hide');
                },
                error: handleError,
                complete: function() {
                    $btn.removeClass('loading').prop('disabled', false);
                }
            });
        });

        // Framework Analysis
        $('#runFrameworkAnalysis').click(function() {
            var $btn = $(this);
            $btn.addClass('loading').prop('disabled', true);

            var $selected = $('#frameworkCode option:selected');

            $.ajax({
                url: apiBase + '/analyze-framework',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    frameworkCode: $('#frameworkCode').val(),
                    frameworkName: $selected.data('name'),
                    totalControls: parseInt($('#frameworkTotal').val()),
                    implementedControls: parseInt($('#frameworkImplemented').val())
                }),
                success: function(result) {
                    showAnalysisResults(result);
                    $('#frameworkModal').modal('hide');
                },
                error: handleError,
                complete: function() {
                    $btn.removeClass('loading').prop('disabled', false);
                }
            });
        });

        function showAnalysisResults(result) {
            if (!result.success) {
                abp.message.error(result.analysis || 'Analysis failed');
                return;
            }

            $('#analysisContent').html(formatResponse(result.analysis));

            var riskClass = 'risk-' + (result.riskLevel || 'medium').toLowerCase();
            $('#riskBadge').removeClass('risk-low risk-medium risk-high risk-critical')
                          .addClass(riskClass)
                          .text(result.riskLevel || 'Medium');

            var $recs = $('#recommendationsList').empty();
            (result.recommendations || []).forEach(function(rec) {
                $recs.append('<li class="list-group-item"><i class="fas fa-chevron-right text-primary me-2"></i>' + escapeHtml(rec) + '</li>');
            });

            var $actions = $('#actionItemsList').empty();
            (result.actionItems || []).forEach(function(item) {
                $actions.append('<li class="list-group-item"><i class="fas fa-check text-success me-2"></i>' + escapeHtml(item) + '</li>');
            });

            $('#modelUsed').text(result.model || 'Unknown');
            $('#tokensUsed').text(result.tokensUsed || 0);

            $('#analysisResults').slideDown();
            $('html, body').animate({ scrollTop: $('#analysisResults').offset().top - 100 }, 500);
        }

        function handleError(xhr) {
            abp.message.error('Failed to perform analysis. Please try again.');
        }

        function scrollChat() {
            var container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatResponse(text) {
            if (!text) return '';
            // Convert markdown-like formatting
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>');
        }
    });
</script>
}
