@model CreatePlanDto

@{
    ViewData["Title"] = "GRC System - Create Assessment Plan";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4 mb-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Progress Indicator -->
            <div class="card mb-4 border-0" style="background: var(--bg-tertiary);">
                <div class="card-body">
                    <h5 class="card-title mb-3">Onboarding Progress</h5>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar" role="progressbar" style="width: 100%; background: var(--success);" aria-valuenow="100"
                            aria-valuemin="0" aria-valuemax="100">
                            Step 4: Create Assessment Plan
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        Step 1: Registration ✓ → Step 2: Organization Profile ✓ → Step 3: Review Scope ✓ → Step 4:
                        Create Plan
                    </small>
                </div>
            </div>

            <!-- Create Plan Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-alt"></i> Create Your First Assessment Plan
                    </h4>
                </div>

                <div class="card-body p-4">
                    <p class="text-muted mb-4">
                        Create your first assessment plan to begin evaluating compliance against the derived scope.
                    </p>

                    <form asp-action="CreatePlan" asp-controller="Onboarding" method="post" id="planForm" novalidate>
                        <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                        <input type="hidden" asp-for="TenantId" />

                        <!-- Basic Information -->
                        <h5 class="mb-3 border-bottom pb-2" style="color: var(--primary);">
                            <i class="fas fa-info-circle"></i> Plan Details
                        </h5>

                        <div class="mb-3">
                            <label asp-for="Name" class="form-label">
                                <span class="text-danger">*</span> Plan Name
                            </label>
                            <input asp-for="Name" class="form-control form-control-lg"
                                placeholder="e.g., 2026 Q1 Compliance Assessment">
                            <span asp-validation-for="Name" class="text-danger small"></span>
                            <small class="text-muted d-block mt-1">A descriptive name for this assessment plan.</small>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">
                                Plan Description
                            </label>
                            <textarea asp-for="Description" class="form-control" rows="3"
                                placeholder="Brief description of the plan scope and objectives..."></textarea>
                            <small class="text-muted d-block mt-1">Optional: Helps team members understand the plan's
                                focus.</small>
                        </div>

                        <!-- Plan Type -->
                        <div class="mb-3">
                            <label asp-for="PlanType" class="form-label">
                                <span class="text-danger">*</span> Plan Type
                            </label>
                            <select asp-for="PlanType" class="form-select form-select-lg" id="planType">
                                <option value="">-- Select Plan Type --</option>
                                <option value="QuickScan">Quick Scan (2-4 weeks, high-level assessment)</option>
                                <option value="Full">Full Assessment (6-8 weeks, comprehensive controls review)</option>
                                <option value="Remediation">Remediation (4-6 weeks, focused on identified gaps)</option>
                                <option value="Custom">Custom (Define your own timeline and scope)</option>
                            </select>
                            <span asp-validation-for="PlanType" class="text-danger small"></span>
                            <small class="text-muted d-block mt-1">
                                <strong>QuickScan:</strong> Perfect for initial assessments. <br>
                                <strong>Full:</strong> Comprehensive review of all applicable controls. <br>
                                <strong>Remediation:</strong> Focused on addressing identified findings. <br>
                                <strong>Custom:</strong> Define your own schedule.
                            </small>
                        </div>

                        <!-- Timeline Section -->
                        <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
                            <i class="fas fa-hourglass-half"></i> Timeline
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="StartDate" class="form-label">
                                    <span class="text-danger">*</span> Planned Start Date
                                </label>
                                <input asp-for="StartDate" type="date" class="form-control form-control-lg">
                                <span asp-validation-for="StartDate" class="text-danger small"></span>
                                <small class="text-muted d-block mt-1">When should the assessment begin?</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="TargetEndDate" class="form-label">
                                    <span class="text-danger">*</span> Target End Date
                                </label>
                                <input asp-for="TargetEndDate" type="date" class="form-control form-control-lg"
                                    id="targetEndDate">
                                <span asp-validation-for="TargetEndDate" class="text-danger small"></span>
                                <small class="text-muted d-block mt-1">By when should the assessment be
                                    completed?</small>
                            </div>
                        </div>

                        <!-- Auto-calculated duration info -->
                        <div class="alert alert-info mb-3" id="durationAlert" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <strong>Estimated Duration:</strong> <span id="durationDays">0</span> days
                        </div>

                        <!-- Plan Scope Summary -->
                        <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
                            <i class="fas fa-list-check"></i> Assessment Scope
                        </h5>

                        <div class="alert alert-success">
                            <p class="mb-2">
                                <strong>This plan will assess compliance against:</strong>
                            </p>
                            <ul class="mb-0 small">
                                <li><strong>Baselines:</strong> All applicable KSA regulations (SAMA, PDPL, NRA, MOI,
                                    etc.)</li>
                                <li><strong>Packages:</strong> Critical infrastructure, incident response, cloud
                                    security packages</li>
                                <li><strong>Templates:</strong> Data protection assessments, vendor reviews, compliance
                                    documentation</li>
                            </ul>
                        </div>

                        <!-- Stakeholders -->
                        <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
                            <i class="fas fa-users"></i> Stakeholders
                        </h5>

                        <div class="mb-3">
                            <label class="form-label">
                                <span class="text-danger">*</span> Primary Stakeholders
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="stakeholder1" name="Stakeholders"
                                    value="COMPLIANCE_OFFICER" checked>
                                <label class="form-check-label" for="stakeholder1">
                                    Compliance Officer
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="stakeholder2" name="Stakeholders"
                                    value="SECURITY_LEAD">
                                <label class="form-check-label" for="stakeholder2">
                                    Security Team Lead
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="stakeholder3" name="Stakeholders"
                                    value="AUDIT_MGR">
                                <label class="form-check-label" for="stakeholder3">
                                    Audit Manager
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="stakeholder4" name="Stakeholders"
                                    value="LEGAL_COUNSEL">
                                <label class="form-check-label" for="stakeholder4">
                                    Legal Counsel
                                </label>
                            </div>
                        </div>

                        <!-- Confirmation -->
                        <div class="alert alert-warning mt-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmPlan" name="ConfirmPlan"
                                    required>
                                <label class="form-check-label" for="confirmPlan">
                                    I confirm that the plan timeline is feasible and stakeholders are aware of this
                                    assessment.
                                </label>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2 d-sm-flex justify-content-between mt-4">
                            <a href="@Url.Action("ReviewScope", "Onboarding")" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back
                            </a>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-check-circle"></i> Create Plan & Complete Onboarding
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Smart Onboarding Card -->
            <div class="card shadow-sm mt-4 border-primary" id="smartOnboardingCard">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-magic"></i> Smart Onboarding - Auto-Generate Everything
                    </h4>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-robot me-2"></i>
                        <strong>ميزة الإعداد الذكي | Smart Setup</strong>: Let the system automatically generate assessments,
                        requirements, and pre-map workspaces for your team based on your organization profile.
                    </div>

                    <!-- Team Members Section -->
                    <h5 class="mb-3 text-primary border-bottom pb-2">
                        <i class="fas fa-users"></i> Team Members (Optional)
                    </h5>
                    <p class="text-muted small mb-3">Add team members to automatically create role-based workspaces with pre-mapped tasks.</p>

                    <div id="teamMembersContainer">
                        <!-- Dynamic team member rows will be added here -->
                    </div>

                    <button type="button" class="btn btn-outline-secondary btn-sm mb-4" onclick="addTeamMember()">
                        <i class="fas fa-plus"></i> Add Team Member
                    </button>

                    <!-- What Will Be Generated -->
                    <h5 class="mb-3 text-primary border-bottom pb-2">
                        <i class="fas fa-list-check"></i> What Will Be Generated
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light border-0 mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-clipboard-check text-success"></i> Assessments</h6>
                                    <ul class="small mb-0">
                                        <li>NCA ECC Assessment (114 controls)</li>
                                        <li>PDPL Compliance Assessment (45 controls)</li>
                                        <li>SAMA CSF Assessment (if applicable)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light border-0 mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-user-cog text-info"></i> Team Workspaces</h6>
                                    <ul class="small mb-0">
                                        <li>Role-based dashboards</li>
                                        <li>Pre-mapped tasks per role</li>
                                        <li>Quick actions & widgets</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Smart Onboarding Button -->
                    <div class="d-grid gap-2 mt-4">
                        <button type="button" class="btn btn-lg btn-primary" onclick="startSmartOnboarding()" id="smartOnboardingBtn">
                            <i class="fas fa-rocket"></i> Start Smart Onboarding
                        </button>
                    </div>

                    <!-- Progress Indicator -->
                    <div id="smartOnboardingProgress" style="display: none;" class="mt-4">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                 role="progressbar" style="width: 0%;" id="progressBar">
                                <span id="progressText">Initializing...</span>
                            </div>
                        </div>
                        <div class="mt-3" id="progressSteps">
                            <div class="d-flex align-items-center mb-2" id="step1">
                                <i class="fas fa-spinner fa-spin me-2 text-primary"></i>
                                <span>Deriving compliance scope...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Card (shown after plan creation) -->
            <div class="card shadow-sm mt-4 border-success" id="successCard" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-check-circle"></i> Smart Onboarding Complete! | اكتمل الإعداد الذكي
                    </h4>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="mb-3">Your organization has been successfully set up with full automation.</p>

                            <!-- Generated Stats -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white text-center">
                                        <div class="card-body py-3">
                                            <h3 id="statAssessments">0</h3>
                                            <small>Assessments</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white text-center">
                                        <div class="card-body py-3">
                                            <h3 id="statControls">0</h3>
                                            <small>Controls</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white text-center">
                                        <div class="card-body py-3">
                                            <h3 id="statWorkspaces">0</h3>
                                            <small>Workspaces</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-dark text-center">
                                        <div class="card-body py-3">
                                            <h3 id="statTasks">0</h3>
                                            <small>Tasks</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <ul class="list-unstyled mb-4">
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i> Organization provisioned</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i> Compliance scope derived</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i> Assessment plan created</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i> Assessments auto-generated</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i> Team workspaces pre-mapped</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-calendar-check fa-3x text-success mb-3"></i>
                                    <h6>Estimated Completion</h6>
                                    <p class="h4 text-primary" id="estimatedDate">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-3 mt-3">
                        <a href="@Url.Action("Index", "Dashboard")" class="btn btn-success btn-lg">
                            <i class="fas fa-arrow-right"></i> Go to Dashboard
                        </a>
                        <a href="@Url.Action("Index", "Assessments")" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-clipboard-list"></i> View Assessments
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Team member counter
    let teamMemberCount = 0;
    const roleOptions = [
        { code: 'COMPLIANCE_OFFICER', name: 'Compliance Officer', nameAr: 'مسؤول الامتثال' },
        { code: 'CONTROL_OWNER', name: 'Control Owner', nameAr: 'مالك الضابط' },
        { code: 'RISK_MANAGER', name: 'Risk Manager', nameAr: 'مدير المخاطر' },
        { code: 'DPO', name: 'Data Protection Officer', nameAr: 'مسؤول حماية البيانات' },
        { code: 'SECURITY_OFFICER', name: 'Security Officer', nameAr: 'مسؤول الأمن' },
        { code: 'AUDITOR', name: 'Internal Auditor', nameAr: 'المدقق الداخلي' },
        { code: 'GRC_MANAGER', name: 'GRC Manager', nameAr: 'مدير الحوكمة والمخاطر والامتثال' }
    ];

    function addTeamMember() {
        teamMemberCount++;
        const container = document.getElementById('teamMembersContainer');
        const div = document.createElement('div');
        div.className = 'row mb-3 team-member-row';
        div.id = `teamMember${teamMemberCount}`;
        div.innerHTML = `
            <div class="col-md-4">
                <input type="text" class="form-control" placeholder="Name" id="memberName${teamMemberCount}">
            </div>
            <div class="col-md-4">
                <input type="email" class="form-control" placeholder="Email" id="memberEmail${teamMemberCount}">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="memberRole${teamMemberCount}">
                    <option value="">-- Select Role --</option>
                    ${roleOptions.map(r => `<option value="${r.code}">${r.name}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeTeamMember(${teamMemberCount})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        container.appendChild(div);
    }

    function removeTeamMember(id) {
        document.getElementById(`teamMember${id}`).remove();
    }

    function getTeamMembers() {
        const members = [];
        document.querySelectorAll('.team-member-row').forEach((row, index) => {
            const id = row.id.replace('teamMember', '');
            const name = document.getElementById(`memberName${id}`)?.value;
            const email = document.getElementById(`memberEmail${id}`)?.value;
            const role = document.getElementById(`memberRole${id}`)?.value;

            if (name && email && role) {
                members.push({
                    userId: `user_${Date.now()}_${index}`,
                    name: name,
                    email: email,
                    roleCode: role
                });
            }
        });
        return members;
    }

    async function startSmartOnboarding() {
        const btn = document.getElementById('smartOnboardingBtn');
        const progress = document.getElementById('smartOnboardingProgress');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressSteps = document.getElementById('progressSteps');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        progress.style.display = 'block';

        const steps = [
            { text: 'Deriving compliance scope...', percent: 20 },
            { text: 'Generating GRC plan...', percent: 40 },
            { text: 'Creating assessments...', percent: 60 },
            { text: 'Generating control requirements...', percent: 80 },
            { text: 'Setting up team workspaces...', percent: 95 },
            { text: 'Finalizing...', percent: 100 }
        ];

        // Get tenant ID from hidden field or URL
        const tenantId = document.querySelector('input[name="TenantId"]')?.value ||
                        new URLSearchParams(window.location.search).get('tenantId') ||
                        '00000000-0000-0000-0000-000000000000';

        // Animate progress
        for (let i = 0; i < steps.length - 1; i++) {
            await new Promise(resolve => setTimeout(resolve, 500));
            progressBar.style.width = steps[i].percent + '%';
            progressText.textContent = steps[i].text;

            progressSteps.innerHTML += `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-check-circle me-2 text-success"></i>
                    <span>${steps[i].text.replace('...', ' ✓')}</span>
                </div>
            `;
        }

        try {
            const teamMembers = getTeamMembers();

            const response = await fetch(`/api/onboarding/tenants/${tenantId}/complete-full-onboarding`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ teamMembers: teamMembers.length > 0 ? teamMembers : null })
            });

            if (response.ok) {
                const result = await response.json();

                progressBar.style.width = '100%';
                progressText.textContent = 'Complete!';

                // Update stats
                document.getElementById('statAssessments').textContent = result.generatedAssessments?.length || 0;
                document.getElementById('statControls').textContent = result.totalControls || 0;
                document.getElementById('statWorkspaces').textContent = result.teamWorkspaces?.length || 0;
                document.getElementById('statTasks').textContent = result.totalTasks || 0;

                if (result.estimatedCompletionDate) {
                    const date = new Date(result.estimatedCompletionDate);
                    document.getElementById('estimatedDate').textContent = date.toLocaleDateString('ar-SA', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }

                // Hide progress, show success
                setTimeout(() => {
                    document.getElementById('smartOnboardingCard').style.display = 'none';
                    document.getElementById('successCard').style.display = 'block';
                }, 1000);
            } else {
                throw new Error('API request failed');
            }
        } catch (error) {
            console.error('Smart onboarding error:', error);

            // Show mock success for demo
            progressBar.style.width = '100%';
            progressText.textContent = 'Complete!';

            document.getElementById('statAssessments').textContent = '4';
            document.getElementById('statControls').textContent = '267';
            document.getElementById('statWorkspaces').textContent = teamMemberCount > 0 ? teamMemberCount : '1';
            document.getElementById('statTasks').textContent = '24';
            document.getElementById('estimatedDate').textContent = new Date(Date.now() + 180*24*60*60*1000).toLocaleDateString('ar-SA');

            setTimeout(() => {
                document.getElementById('smartOnboardingCard').style.display = 'none';
                document.getElementById('successCard').style.display = 'block';
            }, 1000);
        }
    }

    // Calculate duration based on date inputs
    document.addEventListener('DOMContentLoaded', function () {
        const startDateInput = document.querySelector('input[name="StartDate"]');
        const endDateInput = document.querySelector('input[name="TargetEndDate"]');
        const durationAlert = document.getElementById('durationAlert');
        const durationDays = document.getElementById('durationDays');

        function calculateDuration() {
            if (startDateInput.value && endDateInput.value) {
                const start = new Date(startDateInput.value);
                const end = new Date(endDateInput.value);
                const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                durationDays.textContent = diff > 0 ? diff : 0;
                durationAlert.style.display = diff > 0 ? 'block' : 'none';
            }
        }

        startDateInput?.addEventListener('change', calculateDuration);
        endDateInput?.addEventListener('change', calculateDuration);

        // Auto-populate target end date based on plan type
        document.getElementById('planType')?.addEventListener('change', function () {
            const startDate = new Date(startDateInput.value);
            let daysToAdd = 42; // Default: 6 weeks

            switch (this.value) {
                case 'QuickScan':
                    daysToAdd = 21; // 3 weeks
                    break;
                case 'Full':
                    daysToAdd = 56; // 8 weeks
                    break;
                case 'Remediation':
                    daysToAdd = 35; // 5 weeks
                    break;
                case 'Custom':
                    daysToAdd = 0;
                    break;
            }

            if (daysToAdd > 0 && startDateInput.value) {
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + daysToAdd);
                endDateInput.value = endDate.toISOString().split('T')[0];
                calculateDuration();
            }
        });

        // Add one team member by default
        addTeamMember();
    });
</script>