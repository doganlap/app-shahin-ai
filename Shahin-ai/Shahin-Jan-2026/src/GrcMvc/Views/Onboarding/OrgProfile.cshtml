@model OrganizationProfileDto

@{
    ViewData["Title"] = "GRC System - Organization Profile";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4 mb-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Progress Indicator -->
            <div class="card mb-4 border-0" style="background: var(--bg-tertiary);">
                <div class="card-body">
                    <h5 class="card-title mb-3">Onboarding Progress</h5>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar" role="progressbar" style="width: 50%; background: var(--success);" aria-valuenow="50"
                            aria-valuemin="0" aria-valuemax="100">
                            Step 2: Organization Profile
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        Step 1: Registration ✓ → Step 2: Organization Profile → Step 3: Review Scope → Step 4: Create
                        Plan
                    </small>
                </div>
            </div>

            <!-- Organization Profile Card -->
            <div class="card shadow-sm">
                <div class="card-header" style="background: var(--primary); color: var(--light);">
                    <h4 class="mb-0">
                        <i class="fas fa-building"></i> Organization Profile
                    </h4>
                </div>

                <div class="card-body p-4">
                    <form asp-action="SaveOrgProfile" asp-controller="Onboarding" method="post" id="profileForm"
                        novalidate>
                        <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                        <input type="hidden" asp-for="TenantId" />

                        <!-- Basic Information -->
                        <h5 class="mb-3 border-bottom pb-2" style="color: var(--primary);">
                            <i class="fas fa-info-circle"></i> Basic Information
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="OrganizationType" class="form-label">
                                    <span class="text-danger">*</span> Organization Type
                                </label>
                                <select asp-for="OrganizationType" class="form-select">
                                    <option value="">-- Select Type --</option>
                                    <option value="Government">Government Agency</option>
                                    <option value="Banking">Banking & Financial Services</option>
                                    <option value="Insurance">Insurance</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Telecom">Telecommunications</option>
                                    <option value="Energy">Energy & Utilities</option>
                                    <option value="Technology">Technology / Software</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Retail">Retail & E-Commerce</option>
                                    <option value="Education">Education</option>
                                    <option value="Other">Other</option>
                                </select>
                                <span asp-validation-for="OrganizationType" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Sector" class="form-label">
                                    <span class="text-danger">*</span> Sector
                                </label>
                                <input asp-for="Sector" class="form-control"
                                    placeholder="e.g., Banking, Healthcare, Technology">
                                <span asp-validation-for="Sector" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Geographic & Operational -->
                        <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
                            <i class="fas fa-globe"></i> Geographic & Operational
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Country" class="form-label">
                                    <span class="text-danger">*</span> Primary Country
                                </label>
                                <select asp-for="Country" class="form-select">
                                    <option value="">-- Select Country --</option>
                                    <option value="SA">Saudi Arabia</option>
                                    <option value="AE">United Arab Emirates</option>
                                    <option value="QA">Qatar</option>
                                    <option value="KW">Kuwait</option>
                                    <option value="BH">Bahrain</option>
                                    <option value="OM">Oman</option>
                                    <option value="Other">Other</option>
                                </select>
                                <span asp-validation-for="Country" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="HostingModel" class="form-label">
                                    <span class="text-danger">*</span> Data Hosting Model
                                </label>
                                <select asp-for="HostingModel" class="form-select">
                                    <option value="">-- Select Model --</option>
                                    <option value="OnPremise">On-Premise (Local Data Centers)</option>
                                    <option value="Cloud">Cloud (AWS, Azure, GCP)</option>
                                    <option value="Hybrid">Hybrid (Mix of On-Premise & Cloud)</option>
                                </select>
                                <span asp-validation-for="HostingModel" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Data & Security -->
                        <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
                            <i class="fas fa-shield-alt"></i> Data & Security
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="DataTypes" class="form-label">
                                    <span class="text-danger">*</span> Data Types Processed
                                </label>
                                <select asp-for="DataTypes" class="form-select" multiple size="4">
                                    <option value="personal_data">Personal Data (Names, IDs, etc.)</option>
                                    <option value="financial_data">Financial Data (Banking, Transactions)</option>
                                    <option value="health_data">Health Data (Medical Records)</option>
                                    <option value="biometric_data">Biometric Data (Fingerprints, Facial)</option>
                                    <option value="geolocation_data">Geolocation Data</option>
                                    <option value="other">Other Sensitive Data</option>
                                </select>
                                <span asp-validation-for="DataTypes" class="text-danger small"></span>
                                <small class="text-muted d-block mt-1">Hold Ctrl/Cmd to select multiple.</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Size" class="form-label">
                                    <span class="text-danger">*</span> Organization Size
                                </label>
                                <select asp-for="Size" class="form-select">
                                    <option value="">-- Select Size --</option>
                                    <option value="Startup">Startup (1-50 employees)</option>
                                    <option value="Small">Small (51-250 employees)</option>
                                    <option value="Medium">Medium (251-1000 employees)</option>
                                    <option value="Large">Large (1000+ employees)</option>
                                </select>
                                <span asp-validation-for="Size" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Maturity & Compliance -->
                        <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
                            <i class="fas fa-chart-line"></i> Maturity & Compliance
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Maturity" class="form-label">
                                    <span class="text-danger">*</span> Compliance Maturity Level
                                </label>
                                <select asp-for="Maturity" class="form-select">
                                    <option value="">-- Select Level --</option>
                                    <option value="Initial">Initial (No formal processes)</option>
                                    <option value="Repeatable">Repeatable (Some documented processes)</option>
                                    <option value="Defined">Defined (Documented & standardized)</option>
                                    <option value="Managed">Managed (Measured & monitored)</option>
                                    <option value="Optimized">Optimized (Continuous improvement)</option>
                                </select>
                                <span asp-validation-for="Maturity" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <span class="text-danger">*</span> Is Critical Infrastructure?
                                </label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="isCritical"
                                        name="IsCriticalInfrastructure">
                                    <label class="form-check-label" for="isCritical">
                                        Yes, our organization is considered critical infrastructure
                                    </label>
                                </div>
                                <small class="text-muted d-block mt-1">Applies stricter regulatory requirements (NRA,
                                    MOI).</small>
                            </div>
                        </div>

                        <!-- Third-Party Services -->
                        <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
                            <i class="fas fa-handshake"></i> Third-Party Services
                        </h5>

                        <div class="mb-3">
                            <label asp-for="Vendors" class="form-label">
                                Key Third-Party Vendors / Services
                            </label>
                            <textarea asp-for="Vendors" class="form-control" rows="3"
                                placeholder="List major vendors (e.g., AWS, Azure, ServiceNow, Salesforce)"></textarea>
                            <small class="text-muted d-block mt-1">Comma-separated or one per line.</small>
                        </div>

                        <!-- Expert-Derived Frameworks (Auto-populated based on sector) -->
                        <div id="derivedFrameworksSection" class="mt-4" style="display: none;">
                            <h5 class="mb-3 text-success border-bottom pb-2">
                                <i class="fas fa-magic"></i> الأطر التنظيمية المطبقة تلقائياً | Auto-Derived Frameworks
                            </h5>
                            <div class="alert alert-info">
                                <i class="fas fa-robot me-2"></i>
                                <strong>Expert-Driven Mapping:</strong> Based on your sector selection, the following regulatory frameworks
                                will automatically apply to your organization. No manual selection needed!
                            </div>

                            <div id="frameworksList" class="row">
                                <!-- Frameworks will be populated dynamically -->
                            </div>

                            <div class="card mt-3" id="implementationGuidance" style="display: none; background: var(--bg-tertiary);">
                                <div class="card-body">
                                    <h6><i class="fas fa-lightbulb text-warning"></i> Implementation Guidance</h6>
                                    <p id="guidanceText" class="mb-2 small"></p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Estimated Timeline:</strong> <span id="estimatedMonths" class="badge" style="background: var(--primary);"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Priority Focus:</strong> <span id="priorityFocus" class="text-muted small"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3" id="regulatoryDeadlines" style="display: none;">
                                <h6><i class="fas fa-calendar-alt text-danger"></i> Regulatory Deadlines</h6>
                                <ul id="deadlinesList" class="small mb-0"></ul>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2 d-sm-flex justify-content-between mt-4">
                            <a href="@Url.Action("Signup", "Onboarding")" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-arrow-right"></i> Continue to Review Scope
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Expert-driven sector blueprints (mirrors backend ExpertFrameworkMappingService)
    const sectorBlueprints = {
        'Banking': {
            name: 'Banking & Financial Services',
            nameAr: 'الخدمات المصرفية والمالية',
            frameworks: [
                { code: 'SAMA-CSF', name: 'SAMA Cybersecurity Framework', priority: 1, mandatory: true, reason: 'Required for all SAMA-regulated financial institutions', controls: 98 },
                { code: 'NCA-ECC', name: 'NCA Essential Cybersecurity Controls', priority: 2, mandatory: true, reason: 'National requirement for critical infrastructure', controls: 114 },
                { code: 'PDPL', name: 'Personal Data Protection Law', priority: 3, mandatory: true, reason: 'Customer data processing requirements', controls: 45 },
                { code: 'SAMA-AML', name: 'SAMA Anti-Money Laundering', priority: 4, mandatory: true, reason: 'Financial crime prevention', controls: 67 },
                { code: 'PCI-DSS', name: 'Payment Card Industry DSS', priority: 5, mandatory: false, reason: 'If processing card payments', controls: 78 }
            ],
            guidance: 'Focus on transaction security, customer data protection, and regulatory reporting. SAMA inspections occur annually.',
            estimatedMonths: 9,
            priorities: ['Access Control', 'Cryptography', 'Incident Response', 'Business Continuity'],
            deadlines: ['SAMA CSF: Immediate compliance required', 'PDPL: Full compliance by end of year']
        },
        'Healthcare': {
            name: 'Healthcare & Medical',
            nameAr: 'الرعاية الصحية والطبية',
            frameworks: [
                { code: 'NCA-ECC', name: 'NCA Essential Cybersecurity Controls', priority: 1, mandatory: true, reason: 'Healthcare is critical infrastructure', controls: 114 },
                { code: 'PDPL', name: 'Personal Data Protection Law', priority: 1, mandatory: true, reason: 'Patient health data is sensitive personal data', controls: 45 },
                { code: 'SFDA', name: 'SFDA Medical Device Regulations', priority: 2, mandatory: true, reason: 'Medical device cybersecurity requirements', controls: 89 },
                { code: 'MOH-HIS', name: 'MOH Health Information Standards', priority: 3, mandatory: true, reason: 'Health information exchange requirements', controls: 56 }
            ],
            guidance: 'Prioritize patient data protection and medical device security. MOH conducts periodic inspections.',
            estimatedMonths: 12,
            priorities: ['Data Protection', 'Access Control', 'Medical Device Security', 'Patient Privacy'],
            deadlines: ['PDPL: Immediate for health data', 'SFDA: Device registration required']
        },
        'Government': {
            name: 'Government & Public Sector',
            nameAr: 'القطاع الحكومي والعام',
            frameworks: [
                { code: 'NCA-ECC', name: 'NCA Essential Cybersecurity Controls', priority: 1, mandatory: true, reason: 'Mandatory for all government entities', controls: 114 },
                { code: 'NCA-CSCC', name: 'NCA Critical Systems Controls', priority: 1, mandatory: true, reason: 'Government systems are critical infrastructure', controls: 50 },
                { code: 'DGA-CLOUD', name: 'DGA Cloud First Policy', priority: 2, mandatory: true, reason: 'Government cloud adoption requirements', controls: 35 },
                { code: 'PDPL', name: 'Personal Data Protection Law', priority: 3, mandatory: true, reason: 'Citizen data protection', controls: 45 },
                { code: 'NDMO', name: 'NDMO Data Governance Standards', priority: 3, mandatory: true, reason: 'National data management requirements', controls: 42 }
            ],
            guidance: 'Focus on data classification, sovereign cloud, and NCA compliance. NCA conducts mandatory annual assessments.',
            estimatedMonths: 6,
            priorities: ['Data Classification', 'Access Control', 'Cryptography', 'Incident Response'],
            deadlines: ['NCA ECC: Immediate', 'NCA CSCC: Within 6 months', 'Cloud First: Ongoing migration']
        },
        'Telecom': {
            name: 'Telecommunications',
            nameAr: 'الاتصالات',
            frameworks: [
                { code: 'CST-CRF', name: 'CST Cybersecurity Regulatory Framework', priority: 1, mandatory: true, reason: 'CST-regulated entity requirement', controls: 85 },
                { code: 'NCA-ECC', name: 'NCA Essential Cybersecurity Controls', priority: 1, mandatory: true, reason: 'Telecom is critical infrastructure', controls: 114 },
                { code: 'NCA-CSCC', name: 'NCA Critical Systems Controls', priority: 2, mandatory: true, reason: 'Critical national infrastructure', controls: 50 },
                { code: 'PDPL', name: 'Personal Data Protection Law', priority: 3, mandatory: true, reason: 'Subscriber data protection', controls: 45 }
            ],
            guidance: 'Focus on network infrastructure security and service continuity. CST conducts regular inspections.',
            estimatedMonths: 9,
            priorities: ['Network Security', 'Infrastructure Protection', 'Incident Response', 'Business Continuity'],
            deadlines: ['CST CRF: Immediate', 'NCA: Within 6 months']
        },
        'Energy': {
            name: 'Energy & Utilities',
            nameAr: 'الطاقة والمرافق',
            frameworks: [
                { code: 'NCA-ECC', name: 'NCA Essential Cybersecurity Controls', priority: 1, mandatory: true, reason: 'Critical national infrastructure', controls: 114 },
                { code: 'NCA-CSCC', name: 'NCA Critical Systems Controls', priority: 1, mandatory: true, reason: 'OT/ICS systems protection', controls: 50 },
                { code: 'HCIS', name: 'HCIS Industrial Cybersecurity', priority: 2, mandatory: true, reason: 'Industrial control systems security', controls: 72 },
                { code: 'PDPL', name: 'Personal Data Protection Law', priority: 3, mandatory: true, reason: 'Customer data protection', controls: 45 }
            ],
            guidance: 'Priority on OT/ICS segmentation and industrial control system security. Critical infrastructure audits by NCA.',
            estimatedMonths: 12,
            priorities: ['OT Security', 'Physical Security', 'Incident Response', 'Network Segmentation'],
            deadlines: ['NCA CSCC: Immediate for critical systems', 'HCIS: Within 12 months']
        },
        'Retail': {
            name: 'Retail & E-Commerce',
            nameAr: 'التجزئة والتجارة الإلكترونية',
            frameworks: [
                { code: 'PDPL', name: 'Personal Data Protection Law', priority: 1, mandatory: true, reason: 'Customer data processing', controls: 45 },
                { code: 'NCA-ECC', name: 'NCA Essential Cybersecurity Controls', priority: 2, mandatory: true, reason: 'Basic cybersecurity requirements', controls: 114 },
                { code: 'PCI-DSS', name: 'Payment Card Industry DSS', priority: 2, mandatory: true, reason: 'Card payment processing', controls: 78 },
                { code: 'MOCI-ECOM', name: 'MOCI E-Commerce Regulations', priority: 3, mandatory: true, reason: 'E-commerce compliance', controls: 28 }
            ],
            guidance: 'Focus on PCI compliance and customer data protection. MOCI and CITC oversight.',
            estimatedMonths: 6,
            priorities: ['Payment Security', 'Customer Data Protection', 'Website Security'],
            deadlines: ['PDPL: Immediate', 'PCI-DSS: Ongoing']
        },
        'Technology': {
            name: 'Technology & Software',
            nameAr: 'التقنية والبرمجيات',
            frameworks: [
                { code: 'NCA-ECC', name: 'NCA Essential Cybersecurity Controls', priority: 1, mandatory: true, reason: 'Basic cybersecurity requirements', controls: 114 },
                { code: 'PDPL', name: 'Personal Data Protection Law', priority: 2, mandatory: true, reason: 'User data processing', controls: 45 },
                { code: 'CST-CLOUD', name: 'CST Cloud Regulations', priority: 3, mandatory: false, reason: 'If providing cloud services', controls: 38 },
                { code: 'ISO27001', name: 'ISO 27001 Information Security', priority: 4, mandatory: false, reason: 'Recommended for enterprise clients', controls: 114 }
            ],
            guidance: 'Focus on secure SDLC and application security. Consider SOC 2 for enterprise clients.',
            estimatedMonths: 6,
            priorities: ['Secure Development', 'Access Control', 'Data Protection'],
            deadlines: ['NCA ECC: Within 6 months', 'PDPL: Immediate']
        }
    };

    // Map organization type to sector
    function mapTypeToSector(orgType) {
        const mapping = {
            'Government': 'Government',
            'Banking': 'Banking',
            'Insurance': 'Banking',
            'Healthcare': 'Healthcare',
            'Telecom': 'Telecom',
            'Energy': 'Energy',
            'Technology': 'Technology',
            'Manufacturing': 'Energy',
            'Retail': 'Retail',
            'Education': 'Government',
            'Other': 'Technology'
        };
        return mapping[orgType] || 'Technology';
    }

    // Update derived frameworks based on selection
    function updateDerivedFrameworks() {
        const orgType = document.getElementById('OrganizationType')?.value;
        const sectorInput = document.getElementById('Sector')?.value;

        // Determine sector from org type or manual sector input
        let sector = orgType ? mapTypeToSector(orgType) : null;
        if (sectorInput) {
            // Try to match sector input to known sectors
            const sectorLower = sectorInput.toLowerCase();
            if (sectorLower.includes('bank') || sectorLower.includes('financ')) sector = 'Banking';
            else if (sectorLower.includes('health') || sectorLower.includes('medical')) sector = 'Healthcare';
            else if (sectorLower.includes('government') || sectorLower.includes('public')) sector = 'Government';
            else if (sectorLower.includes('telecom')) sector = 'Telecom';
            else if (sectorLower.includes('energy') || sectorLower.includes('oil') || sectorLower.includes('utility')) sector = 'Energy';
            else if (sectorLower.includes('retail') || sectorLower.includes('commerce')) sector = 'Retail';
            else if (sectorLower.includes('tech') || sectorLower.includes('software')) sector = 'Technology';
        }

        const section = document.getElementById('derivedFrameworksSection');
        const frameworksList = document.getElementById('frameworksList');
        const guidance = document.getElementById('implementationGuidance');
        const deadlines = document.getElementById('regulatoryDeadlines');

        if (!sector || !sectorBlueprints[sector]) {
            section.style.display = 'none';
            return;
        }

        const blueprint = sectorBlueprints[sector];
        section.style.display = 'block';

        // Render frameworks
        let html = '';
        blueprint.frameworks.forEach(fw => {
            const mandatoryBadge = fw.mandatory
                ? '<span class="badge bg-danger ms-1">Mandatory</span>'
                : '<span class="badge bg-secondary ms-1">Optional</span>';

            html += `
                <div class="col-md-6 mb-3">
                    <div class="card h-100 ${fw.mandatory ? 'border-primary' : 'border-secondary'}">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-shield-alt text-${fw.mandatory ? 'primary' : 'secondary'}"></i>
                                ${fw.name} ${mandatoryBadge}
                            </h6>
                            <p class="card-text small text-muted">${fw.reason}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge text-dark" style="background: var(--bg-tertiary);">${fw.code}</span>
                                <small class="text-muted">${fw.controls} controls</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        frameworksList.innerHTML = html;

        // Show guidance
        document.getElementById('guidanceText').textContent = blueprint.guidance;
        document.getElementById('estimatedMonths').textContent = blueprint.estimatedMonths + ' months';
        document.getElementById('priorityFocus').textContent = blueprint.priorities.join(', ');
        guidance.style.display = 'block';

        // Show deadlines
        let deadlinesHtml = '';
        blueprint.deadlines.forEach(d => {
            deadlinesHtml += `<li><i class="fas fa-exclamation-triangle text-warning me-1"></i>${d}</li>`;
        });
        document.getElementById('deadlinesList').innerHTML = deadlinesHtml;
        deadlines.style.display = 'block';

        // Auto-fill sector field if empty
        const sectorField = document.getElementById('Sector');
        if (!sectorField.value && orgType) {
            sectorField.value = blueprint.name;
        }
    }

    // Attach event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const orgTypeSelect = document.getElementById('OrganizationType');
        const sectorInput = document.getElementById('Sector');
        const criticalCheckbox = document.getElementById('isCritical');

        orgTypeSelect?.addEventListener('change', updateDerivedFrameworks);
        sectorInput?.addEventListener('blur', updateDerivedFrameworks);
        criticalCheckbox?.addEventListener('change', function() {
            // If critical infrastructure, add NCA-CSCC automatically
            updateDerivedFrameworks();
        });

        // Initial check
        if (orgTypeSelect?.value) {
            updateDerivedFrameworks();
        }
    });
</script>