@model GrcMvc.Services.Interfaces.DataQualityDashboardDto
@{
    ViewData["Title"] = "لوحة جودة البيانات";
    ViewData["TitleEn"] = "Data Quality Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-database text-primary me-2"></i>
                لوحة جودة البيانات
            </h1>
            <p class="text-muted mb-0">مراقبة نضارة واكتمال وتناسق البيانات</p>
        </div>
        <div class="d-flex gap-2">
            @if (Model != null)
            {
                var qualityColor = Model.OverallScore.QualityLevel switch
                {
                    "Excellent" => "success",
                    "Good" => "info",
                    "Fair" => "warning",
                    _ => "danger"
                };
                <span class="badge bg-@qualityColor fs-6">
                    <i class="fas fa-star me-1"></i>
                    @Model.OverallScore.QualityLevel - @Model.OverallScore.OverallScore%
                </span>
            }
            <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                <i class="fas fa-sync-alt me-1"></i>
                تحديث
            </button>
        </div>
    </div>

    @if (Model == null)
    {
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            لا تتوفر بيانات
        </div>
    }
    else
    {
        <!-- Quality Score Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm text-center h-100">
                    <div class="card-body">
                        <div class="display-6 text-primary mb-2">@Model.OverallScore.OverallScore%</div>
                        <h6 class="text-muted mb-0">الدرجة الإجمالية</h6>
                        <span class="badge bg-@(Model.OverallScore.QualityLevel == "Excellent" ? "success" : Model.OverallScore.QualityLevel == "Good" ? "info" : Model.OverallScore.QualityLevel == "Fair" ? "warning" : "danger") mt-2">
                            @Model.OverallScore.QualityLevel
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">الاكتمال</span>
                            <strong>@Model.OverallScore.CompletenessScore%</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: @Model.OverallScore.CompletenessScore%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">النضارة</span>
                            <strong>@Model.OverallScore.FreshnessScore%</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" style="width: @Model.OverallScore.FreshnessScore%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">التناسق</span>
                            <strong>@Model.OverallScore.ConsistencyScore%</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: @Model.OverallScore.ConsistencyScore%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Data Freshness -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-clock text-info me-2"></i>
                            نضارة البيانات
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        @if (Model.Freshness.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>نوع الكيان</th>
                                            <th>إجمالي</th>
                                            <th>قديمة</th>
                                            <th>الحالة</th>
                                            <th>آخر تحديث</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.Freshness)
                                        {
                                            var levelClass = item.FreshnessLevel switch
                                            {
                                                "Fresh" => "success",
                                                "Stale" => "warning",
                                                "Critical" => "danger",
                                                _ => "secondary"
                                            };
                                            <tr>
                                                <td>
                                                    <strong>@item.EntityTypeAr</strong>
                                                    <br><small class="text-muted">@item.EntityType</small>
                                                </td>
                                                <td>@item.TotalRecords</td>
                                                <td>
                                                    @if (item.StaleRecords > 0)
                                                    {
                                                        <span class="badge bg-warning text-dark">@item.StaleRecords</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-success">0</span>
                                                    }
                                                </td>
                                                <td>
                                                    <span class="badge bg-@levelClass">@item.FreshnessLevel</span>
                                                </td>
                                                <td>
                                                    @if (item.LastUpdated.HasValue)
                                                    {
                                                        <span>@item.LastUpdated.Value.ToString("dd/MM/yyyy")</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-database fa-3x mb-2"></i>
                                <p>لا توجد بيانات نضارة</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Orphan Records -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-unlink text-warning me-2"></i>
                            السجلات اليتيمة
                        </h5>
                        <span class="badge bg-warning text-dark">@Model.OrphanRecords.TotalOrphans</span>
                    </div>
                    <div class="card-body">
                        @if (Model.OrphanRecords.TotalOrphans > 0)
                        {
                            <!-- By Type Summary -->
                            <div class="row g-2 mb-4">
                                @foreach (var type in Model.OrphanRecords.ByType)
                                {
                                    var impactClass = type.ImpactLevel == "High" ? "danger" : type.ImpactLevel == "Medium" ? "warning" : "info";
                                    <div class="col-auto">
                                        <span class="badge bg-@impactClass">
                                            @type.EntityType: @type.Count
                                        </span>
                                    </div>
                                }
                            </div>

                            <!-- Top Orphans -->
                            @if (Model.OrphanRecords.TopOrphans.Any())
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var orphan in Model.OrphanRecords.TopOrphans.Take(5))
                                    {
                                        <div class="list-group-item px-0">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>@orphan.Name</strong>
                                                    <br><small class="text-muted">@orphan.EntityType - مفقود: @orphan.MissingRelation</small>
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-muted d-block">@orphan.CreatedAt.ToString("dd/MM/yyyy")</small>
                                                    <small class="text-info">@orphan.SuggestedAction</small>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-check-circle fa-3x text-success mb-2"></i>
                                <p>لا توجد سجلات يتيمة</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Missing Mappings -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-project-diagram text-danger me-2"></i>
                            الروابط المفقودة
                        </h5>
                        <span class="badge bg-danger">@Model.MissingMappings.Count</span>
                    </div>
                    <div class="card-body p-0">
                        @if (Model.MissingMappings.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>نوع الرابط</th>
                                            <th>الكيان المصدر</th>
                                            <th>الهدف المتوقع</th>
                                            <th>التأثير</th>
                                            <th>التوصية</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var mapping in Model.MissingMappings)
                                        {
                                            var impactClass = mapping.Impact switch
                                            {
                                                "High" => "danger",
                                                "Medium" => "warning",
                                                _ => "info"
                                            };
                                            <tr>
                                                <td>
                                                    <span class="badge bg-secondary">@mapping.MappingType</span>
                                                </td>
                                                <td>
                                                    <strong>@mapping.SourceEntityName</strong>
                                                    <br><small class="text-muted">@mapping.SourceEntityType</small>
                                                </td>
                                                <td>@mapping.ExpectedTarget</td>
                                                <td>
                                                    <span class="badge bg-@impactClass">@mapping.Impact</span>
                                                </td>
                                                <td>
                                                    <small class="text-info">@mapping.Recommendation</small>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-link fa-3x text-success mb-2"></i>
                                <p>جميع الروابط مكتملة</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Consistency Issues -->
        @if (Model.ConsistencyIssues.Any())
        {
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                مشاكل التناسق
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>نوع المشكلة</th>
                                            <th>الوصف</th>
                                            <th>السجلات المتأثرة</th>
                                            <th>الأهمية</th>
                                            <th>الحل</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var issue in Model.ConsistencyIssues)
                                        {
                                            <tr>
                                                <td><strong>@issue.IssueType</strong></td>
                                                <td>@issue.Description</td>
                                                <td>@issue.AffectedRecords</td>
                                                <td>
                                                    <span class="badge bg-@(issue.Severity == "High" ? "danger" : issue.Severity == "Medium" ? "warning" : "info")">
                                                        @issue.Severity
                                                    </span>
                                                </td>
                                                <td><small class="text-info">@issue.Resolution</small></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>
