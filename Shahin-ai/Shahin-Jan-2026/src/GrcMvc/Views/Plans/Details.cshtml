@model GrcMvc.Models.DTOs.PlanDto

@{
    ViewData["Title"] = "Plan Details";
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>@Model.Name</h1>
                    <p class="text-muted">Plan Code: <strong>@Model.PlanCode</strong></p>
                </div>
                <div>
                    <a href="@Url.Action("Edit", new { planId = Model.Id })" class="btn btn-warning me-2">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    <a href="@Url.Action("List")" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title text-muted">Status</h6>
                    @{
                        var statusBadgeClass = Model.Status switch
                        {
                            "Draft" => "bg-secondary",
                            "Active" => "bg-primary",
                            "Paused" => "bg-warning",
                            "Completed" => "bg-success",
                            _ => "bg-info"
                        };
                    }
                    <p>
                        <span class="badge @statusBadgeClass" style="font-size: 1.1em;">@Model.Status</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title text-muted">Progress</h6>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: @Model.ProgressPercentage%" 
                             aria-valuenow="@Model.ProgressPercentage" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            @Model.ProgressPercentage%
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title text-muted">Duration</h6>
                    <p>
                        <strong>@Model.StartDate.ToString("MMM d, yyyy")</strong><br />
                        to<br />
                        <strong>@Model.TargetEndDate.ToString("MMM d, yyyy")</strong>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title text-muted">Type</h6>
                    <p><span class="badge bg-light text-dark">@Model.PlanType</span></p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Plan Description -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-file-text"></i> Description
                    </h5>
                </div>
                <div class="card-body">
                    @if (string.IsNullOrEmpty(Model.Description))
                    {
                        <p class="text-muted">No description provided</p>
                    }
                    else
                    {
                        <p>@Model.Description</p>
                    }
                </div>
            </div>

            <!-- Phases Section -->
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-diagram-3"></i> Plan Phases
                    </h5>
                    <a href="@Url.Action("Phases", new { planId = Model.Id })" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus"></i> Manage Phases
                    </a>
                </div>
                <div class="card-body">
                    @if (Model.Phases == null || Model.Phases.Count == 0)
                    {
                        <p class="text-muted">No phases defined for this plan</p>
                    }
                    else
                    {
                        <div class="list-group">
                            @foreach (var phase in Model.Phases)
                            {
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">@phase.Name</h6>
                                            <p class="mb-2 small text-muted">@phase.Description</p>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-info" role="progressbar" 
                                                     style="width: @(phase.ProgressPercentage ?? 0)%">
                                                    @(phase.ProgressPercentage ?? 0)%
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ms-3">
                                            <span class="badge bg-secondary">@phase.Status</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Actions -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning"></i> Actions
                    </h5>
                </div>
                <div class="card-body d-grid gap-2">
                    @if (Model.Status == "Draft")
                    {
                        <button class="btn btn-success" onclick="updateStatus('Active')">
                            <i class="bi bi-play-circle"></i> Activate Plan
                        </button>
                    }
                    else if (Model.Status == "Active")
                    {
                        <button class="btn btn-warning" onclick="updateStatus('Paused')">
                            <i class="bi bi-pause-circle"></i> Pause Plan
                        </button>
                    }
                    else if (Model.Status == "Paused")
                    {
                        <button class="btn btn-success" onclick="updateStatus('Active')">
                            <i class="bi bi-play-circle"></i> Resume Plan
                        </button>
                    }

                    @if (Model.Status != "Completed")
                    {
                        <button class="btn btn-info" onclick="updateStatus('Completed')">
                            <i class="bi bi-check-circle"></i> Mark Complete
                        </button>
                    }

                    <hr />

                    <a href="@Url.Action("Phases", new { planId = Model.Id })" class="btn btn-outline-primary">
                        <i class="bi bi-diagram-3"></i> Manage Phases
                    </a>
                </div>
            </div>

            <!-- Metadata -->
            <div class="card bg-light">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Details
                    </h5>
                </div>
                <div class="card-body small">
                    <div class="mb-3">
                        <strong>Plan ID:</strong><br />
                        <code>@Model.Id</code>
                    </div>
                    <div class="mb-3">
                        <strong>Created:</strong><br />
                        @Model.CreatedAt.ToString("MMM d, yyyy HH:mm")
                    </div>
                    <div class="mb-3">
                        <strong>Modified:</strong><br />
                        @Model.ModifiedAt?.ToString("MMM d, yyyy HH:mm")
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function updateStatus(newStatus) {
        if (!confirm(`Are you sure you want to change the status to ${newStatus}?`)) {
            return;
        }

        try {
            const response = await fetch('@Url.Action("UpdatePlanStatusAsync", "Plans", new { planId = Model.Id })', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (response.ok) {
                alert(`Plan status updated to ${newStatus}`);
                window.location.reload();
            } else {
                alert('Error updating plan status');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
</script>
