@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<SharedResource> L
@model IEnumerable<GrcMvc.Models.DTOs.RiskDto>
@{
    ViewData["Title"] = L["Risk_Report_Title"].Value;
    Layout = "_Layout";

    var highRisks = ViewBag.HighRiskCount ?? 0;
    var mediumRisks = ViewBag.MediumRiskCount ?? 0;
    var lowRisks = ViewBag.LowRiskCount ?? 0;
    var totalRisks = Model.Count();
}

<div class="container-fluid">
    <div class="row mb-3 d-print-none">
        <div class="col">
            <h2><i class="bi bi-file-earmark-bar-graph"></i> @L["Risk_Report_Title"]</h2>
        </div>
        <div class="col text-end">
            <button onclick="window.print()" class="btn btn-outline-primary">
                <i class="bi bi-printer"></i> @L["Risk_PrintReport"]
            </button>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> @L["BackToList"]
            </a>
        </div>
    </div>

    <!-- Executive Summary -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h4 class="mb-0">@L["Risk_ExecutiveSummary"]</h4>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3 border-end">
                    <h5>@L["Risk_TotalRisks"]</h5>
                    <div class="display-4">@totalRisks</div>
                </div>
                <div class="col-md-3 border-end">
                    <h5>@L["Risk_HighPriority"]</h5>
                    <div class="display-4 text-danger">@highRisks</div>
                </div>
                <div class="col-md-3 border-end">
                    <h5>@L["Risk_MediumPriority"]</h5>
                    <div class="display-4 text-warning">@mediumRisks</div>
                </div>
                <div class="col-md-3">
                    <h5>@L["Risk_LowPriority"]</h5>
                    <div class="display-4 text-success">@lowRisks</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section (Hidden in print if needed, or styled) -->
    <div class="row mb-4 break-inside-avoid">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    @L["Risk_DistributionByCategory"]
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    @L["Risk_RiskStatus"]
                </div>
                <div class="card-body">
                    <canvas id="statusChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Risk Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">@L["Risk_DetailedRiskRegister"]</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>@L["Risk"]</th>
                            <th>@L["Category"]</th>
                            <th>@L["Risk_InherentScore"]</th>
                            <th>@L["Risk_ResidualScore"]</th>
                            <th>@L["Status"]</th>
                            <th>@L["Owner"]</th>
                            <th>@L["DueDate"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.OrderByDescending(r => r.InherentRisk))
                        {
                            <tr>
                                <td>
                                    <strong>@item.Name</strong>
                                    <div class="small text-muted d-print-none">@item.Description</div>
                                </td>
                                <td>@item.Category</td>
                                <td class="text-center">
                                    <span class="badge @GetScoreBadgeClass(item.InherentRisk)">@item.InherentRisk</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge @GetScoreBadgeClass(item.ResidualRisk)">@item.ResidualRisk</span>
                                </td>
                                <td>@item.Status</td>
                                <td>@item.Owner</td>
                                <td>@(item.DueDate?.ToShortDateString() ?? "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row mt-4 text-muted small d-print-block d-none">
        <div class="col-12 text-center">
            <p>@L["Risk_GeneratedOn"] @DateTime.UtcNow.ToString("f") @L["Risk_ByGRCSystem"]</p>
        </div>
    </div>
</div>

@functions {
    private string GetScoreBadgeClass(int score)
    {
        return score switch
        {
            >= 15 => "bg-danger",
            >= 8 => "bg-warning",
            _ => "bg-success"
        };
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Prepare Data
            var categories = {};
            var statuses = {};

            @foreach(var item in Model) {
                <text>
                if(!categories['@item.Category']) categories['@item.Category'] = 0;
                categories['@item.Category']++;

                if(!statuses['@item.Status']) statuses['@item.Status'] = 0;
                statuses['@item.Status']++;
                </text>
            }

            // Category Chart
            new Chart(document.getElementById('categoryChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        label: '@L["Risk_Risks"]',
                        data: Object.values(categories),
                        backgroundColor: '#4e73df'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });

            // Status Chart
            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statuses),
                    datasets: [{
                        data: Object.values(statuses),
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
                    }]
                }
            });
        });
    </script>
}
