@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<SharedResource> L
@{
    ViewData["Title"] = L["Analytics"];
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">@L["Analytics"]</h1>
            <p class="text-muted mb-0">GRC Metrics & Insights</p>
        </div>
        <button class="btn btn-outline-primary" onclick="refreshAllData()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-primary bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-shield-check text-primary fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Compliance Score</h6>
                            <h3 class="mb-0" id="complianceScore">--</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-danger bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Open Risks</h6>
                            <h3 class="mb-0" id="openRisks">--</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-success bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-clipboard-check text-success fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Assessments</h6>
                            <h3 class="mb-0" id="assessmentCount">--</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-info bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-list-check text-info fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Controls</h6>
                            <h3 class="mb-0" id="controlCount">--</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-3 mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0"><i class="bi bi-graph-up me-2"></i>Compliance Trend</h5>
                </div>
                <div class="card-body">
                    <canvas id="complianceTrendChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0"><i class="bi bi-pie-chart me-2"></i>Risk Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="riskDistributionChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Heatmap & Top Actions -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0"><i class="bi bi-grid-3x3 me-2"></i>Risk Heatmap</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center mb-0">
                            <thead><tr><th></th><th>Very Low</th><th>Low</th><th>Medium</th><th>High</th><th>Very High</th></tr></thead>
                            <tbody id="heatmapBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0"><i class="bi bi-lightning me-2"></i>Priority Actions</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="topActionsList">
                        <div class="list-group-item text-center text-muted py-4">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Framework Comparison -->
    <div class="row g-3">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0"><i class="bi bi-bar-chart me-2"></i>Framework Comparison</h5>
                </div>
                <div class="card-body">
                    <canvas id="frameworkComparisonChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        let charts = {};

        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadDashboardData();
        });

        function initCharts() {
            charts.trend = new Chart(document.getElementById('complianceTrendChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Compliance %', data: [], borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } } }
            });

            charts.risk = new Chart(document.getElementById('riskDistributionChart'), {
                type: 'doughnut',
                data: { labels: ['Critical', 'High', 'Medium', 'Low'], datasets: [{ data: [0,0,0,0], backgroundColor: ['#dc3545','#fd7e14','#ffc107','#198754'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            charts.framework = new Chart(document.getElementById('frameworkComparisonChart'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Compliance %', data: [], backgroundColor: '#0d6efd' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } } }
            });

            renderHeatmap([]);
        }

        async function loadDashboardData() {
            try {
                const [summary, trend, risk, actions, frameworks] = await Promise.all([
                    fetch('/api/analyticsdashboard/executive-summary').then(r => r.ok ? r.json() : {}),
                    fetch('/api/analyticsdashboard/compliance-trends?months=12').then(r => r.ok ? r.json() : []),
                    fetch('/api/dashboard/risk').then(r => r.ok ? r.json() : {}),
                    fetch('/api/analyticsdashboard/top-actions?limit=5').then(r => r.ok ? r.json() : []),
                    fetch('/api/analyticsdashboard/framework-comparison').then(r => r.ok ? r.json() : [])
                ]);

                document.getElementById('complianceScore').textContent = (summary.complianceScore || 0).toFixed(1) + '%';
                document.getElementById('openRisks').textContent = summary.openRisks || 0;
                document.getElementById('assessmentCount').textContent = summary.totalAssessments || 0;
                document.getElementById('controlCount').textContent = summary.totalControls || 0;

                if (trend.length) {
                    charts.trend.data.labels = trend.map(t => t.month || t.date);
                    charts.trend.data.datasets[0].data = trend.map(t => t.score || t.complianceScore);
                    charts.trend.update();
                }

                charts.risk.data.datasets[0].data = [risk.critical||0, risk.high||0, risk.medium||0, risk.low||0];
                charts.risk.update();

                renderTopActions(actions);

                if (frameworks.length) {
                    charts.framework.data.labels = frameworks.map(f => f.name || f.frameworkCode);
                    charts.framework.data.datasets[0].data = frameworks.map(f => f.complianceScore || f.score);
                    charts.framework.update();
                }
            } catch (e) { console.error('Error:', e); }
        }

        function renderHeatmap(data) {
            const levels = ['Very High','High','Medium','Low','Very Low'];
            const colors = { 0:'#198754', 1:'#20c997', 2:'#ffc107', 3:'#fd7e14', 4:'#dc3545' };
            let html = '';
            for (let i = 4; i >= 0; i--) {
                html += `<tr><th>${levels[4-i]}</th>`;
                for (let j = 0; j < 5; j++) {
                    const cell = data?.find(c => c.likelihood === j && c.impact === i);
                    const count = cell?.count || 0;
                    const sev = Math.min(4, Math.floor((i+j)/2));
                    html += `<td style="background:${count ? colors[sev] : '#f8f9fa'};color:${count && sev > 1 ? 'white' : 'black'}">${count}</td>`;
                }
                html += '</tr>';
            }
            document.getElementById('heatmapBody').innerHTML = html;
        }

        function renderTopActions(actions) {
            const el = document.getElementById('topActionsList');
            if (!actions?.length) { el.innerHTML = '<div class="list-group-item text-muted text-center py-4">No priority actions</div>'; return; }
            el.innerHTML = actions.map(a => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between">
                        <div><span class="badge bg-${getPriorityColor(a.priority)} me-2">${a.priority||'Medium'}</span><strong>${a.title||a.description}</strong></div>
                        <small class="text-muted">${a.dueDate ? new Date(a.dueDate).toLocaleDateString() : ''}</small>
                    </div>
                </div>`).join('');
        }

        function getPriorityColor(p) { return {'critical':'danger','high':'warning','medium':'info'}[(p||'').toLowerCase()] || 'secondary'; }
        function refreshAllData() { loadDashboardData(); }
    </script>
}
