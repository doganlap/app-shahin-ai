@model CaseStudyDetailViewModel
@using Microsoft.AspNetCore.Mvc.Localization
@using GrcMvc.Services
@using GrcMvc.Services.Interfaces
@inject IHtmlLocalizer<SharedResource> L
@inject IAppInfoService AppInfo
@inject IHtmlSanitizerService HtmlSanitizer
@{
    var isArabic = System.Threading.Thread.CurrentThread.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = (isArabic ? Model.TitleAr : Model.Title) + " | " + AppInfo.Name;
    ViewData["Description"] = isArabic ? Model.SummaryAr : Model.Summary;
    Layout = "_LandingLayout";
    
    // SECURITY: Sanitize user-generated HTML content to prevent XSS attacks
    var challengeHtml = HtmlSanitizer.SanitizeHtml(isArabic ? Model.ChallengeAr ?? Model.Challenge : Model.Challenge);
    var solutionHtml = HtmlSanitizer.SanitizeHtml(isArabic ? Model.SolutionAr ?? Model.Solution : Model.Solution);
    var resultsHtml = HtmlSanitizer.SanitizeHtml(isArabic ? Model.ResultsAr ?? Model.Results : Model.Results);
    var customerQuoteHtml = HtmlSanitizer.SanitizeHtml(isArabic ? Model.CustomerQuoteAr ?? Model.CustomerQuote : Model.CustomerQuote);
}

<style>
    .case-study-hero {
        background: linear-gradient(135deg, var(--darker) 0%, #1a0a0a 100%);
        padding: 8rem 0 4rem;
        position: relative;
    }

    .case-study-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 80%;
        height: 200%;
        background: radial-gradient(circle, rgba(220, 38, 38, 0.08) 0%, transparent 70%);
        pointer-events: none;
    }

    .case-study-content {
        padding: 4rem 0;
        background: var(--dark);
    }

    .case-study-meta {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        margin-bottom: 3rem;
        padding: 2rem;
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
    }

    .meta-item {
        flex: 1;
        min-width: 200px;
        text-align: center;
    }

    .meta-label {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .meta-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
    }

    .content-section {
        margin-bottom: 4rem;
        padding: 3rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .content-section h2 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--darker);
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 3px solid var(--primary);
    }

    .content-section p {
        font-size: 1.1rem;
        line-height: 1.8;
        color: #333;
        margin-bottom: 1.5rem;
    }

    .customer-quote {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 3rem;
        border-left: 5px solid var(--primary);
        border-radius: 12px;
        margin: 3rem 0;
        position: relative;
    }

    .customer-quote::before {
        content: '"';
        position: absolute;
        top: 1rem;
        left: 1.5rem;
        font-size: 5rem;
        font-weight: 700;
        color: var(--primary);
        opacity: 0.2;
    }

    .quote-text {
        font-size: 1.3rem;
        font-style: italic;
        color: var(--darker);
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 1;
    }

    .quote-author {
        font-size: 1rem;
        font-weight: 600;
        color: #666;
    }

    .quote-author-title {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .related-case-studies {
        padding: 4rem 0;
        background: var(--darker);
    }

    .related-card {
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 2rem;
        transition: all 0.3s ease;
        height: 100%;
    }

    .related-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
        box-shadow: 0 8px 24px rgba(220, 38, 38, 0.2);
    }

    .related-card h4 {
        font-size: 1.2rem;
        color: var(--light);
        margin-bottom: 1rem;
    }

    .related-card p {
        font-size: 0.95rem;
        color: var(--text-muted);
        margin-bottom: 1.5rem;
    }

    .related-card .badge {
        background: var(--primary);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--light);
        text-decoration: none;
        margin-bottom: 2rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .back-link:hover {
        color: var(--primary);
        transform: translateX(-5px);
    }

    @@media (max-width: 768px) {
        .case-study-meta {
            flex-direction: column;
        }

        .content-section {
            padding: 2rem;
        }

        .customer-quote {
            padding: 2rem;
        }

        .quote-text {
            font-size: 1.1rem;
        }
    }
</style>

<!-- Hero Section -->
<section class="case-study-hero">
    <div class="container">
        <a href="/case-studies" class="back-link">
            <i class="bi bi-arrow-left"></i>
            <span>@(isArabic ? "العودة إلى دراسات الحالة" : "Back to Case Studies")</span>
        </a>
        <div class="fade-up">
            <div class="section-badge mb-3">
                <i class="bi bi-building"></i>
                <span>@(isArabic ? Model.IndustryAr ?? Model.Industry : Model.Industry)</span>
            </div>
            <h1 class="section-title text-white">
                @(isArabic ? Model.TitleAr ?? Model.Title : Model.Title)
            </h1>
            <p class="section-subtitle text-white-50">
                @(isArabic ? Model.SummaryAr ?? Model.Summary : Model.Summary)
            </p>
        </div>
    </div>
</section>

<!-- Key Metrics -->
<section class="case-study-content">
    <div class="container">
        <div class="case-study-meta fade-up">
            @if (!string.IsNullOrEmpty(Model.TimeToCompliance))
            {
                <div class="meta-item">
                    <div class="meta-label">
                        @(isArabic ? "وقت الامتثال" : "Time to Compliance")
                    </div>
                    <div class="meta-value">@Model.TimeToCompliance</div>
                </div>
            }
            @if (!string.IsNullOrEmpty(Model.ImprovementMetric))
            {
                <div class="meta-item">
                    <div class="meta-label">
                        @(isArabic ? Model.ImprovementLabelAr ?? Model.ImprovementLabel ?? "التحسين" : Model.ImprovementLabel ?? "Improvement")
                    </div>
                    <div class="meta-value">@Model.ImprovementMetric</div>
                </div>
            }
            @if (!string.IsNullOrEmpty(Model.ComplianceScore))
            {
                <div class="meta-item">
                    <div class="meta-label">
                        @(isArabic ? "درجة الامتثال" : "Compliance Score")
                    </div>
                    <div class="meta-value">@Model.ComplianceScore</div>
                </div>
            }
            @if (!string.IsNullOrEmpty(Model.FrameworkCode))
            {
                <div class="meta-item">
                    <div class="meta-label">
                        @(isArabic ? "الإطار" : "Framework")
                    </div>
                    <div class="meta-value">@Model.FrameworkCode</div>
                </div>
            }
        </div>

        <!-- Challenge Section -->
        @if (!string.IsNullOrEmpty(Model.Challenge) || !string.IsNullOrEmpty(Model.ChallengeAr))
        {
            <div class="content-section fade-up">
                <h2>
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    @(isArabic ? "التحدي" : "The Challenge")
                </h2>
                @* XSS FIX: Content sanitized using HtmlSanitizerService - safe to use Html.Raw *@
                <p>@Html.Raw(challengeHtml)</p>
            </div>
        }

        <!-- Solution Section -->
        @if (!string.IsNullOrEmpty(Model.Solution) || !string.IsNullOrEmpty(Model.SolutionAr))
        {
            <div class="content-section fade-up">
                <h2>
                    <i class="bi bi-lightbulb me-2"></i>
                    @(isArabic ? "الحل" : "The Solution")
                </h2>
                @* XSS FIX: Content sanitized using HtmlSanitizerService - safe to use Html.Raw *@
                <p>@Html.Raw(solutionHtml)</p>
            </div>
        }

        <!-- Results Section -->
        @if (!string.IsNullOrEmpty(Model.Results) || !string.IsNullOrEmpty(Model.ResultsAr))
        {
            <div class="content-section fade-up">
                <h2>
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    @(isArabic ? "النتائج" : "The Results")
                </h2>
                @* XSS FIX: Content sanitized using HtmlSanitizerService - safe to use Html.Raw *@
                <p>@Html.Raw(resultsHtml)</p>
            </div>
        }

        <!-- Customer Quote -->
        @if (!string.IsNullOrEmpty(Model.CustomerQuote) || !string.IsNullOrEmpty(Model.CustomerQuoteAr))
        {
            <div class="customer-quote fade-up">
                @* XSS FIX: Content sanitized using HtmlSanitizerService - safe to use Html.Raw *@
                <p class="quote-text">
                    @Html.Raw(customerQuoteHtml)
                </p>
                @if (!string.IsNullOrEmpty(Model.CustomerName))
                {
                    <div class="quote-author">— @Model.CustomerName</div>
                    @if (!string.IsNullOrEmpty(Model.CustomerTitle))
                    {
                        <div class="quote-author-title">
                            @(isArabic ? Model.CustomerTitleAr ?? Model.CustomerTitle : Model.CustomerTitle)
                        </div>
                    }
                }
            </div>
        }
    </div>
</section>

<!-- Related Case Studies -->
@if (Model.RelatedCaseStudies.Any())
{
    <section class="related-case-studies">
        <div class="container">
            <div class="text-center mb-5 fade-up">
                <h2 class="section-title text-white">
                    @(isArabic ? "دراسات حالة ذات صلة" : "Related Case Studies")
                </h2>
            </div>
            <div class="row g-4">
                @foreach (var related in Model.RelatedCaseStudies)
                {
                    <div class="col-md-4">
                        <div class="related-card fade-up">
                            <span class="badge mb-3">
                                @(isArabic ? related.IndustryAr ?? related.Industry : related.Industry)
                            </span>
                            <h4>@(isArabic ? related.TitleAr ?? related.Title : related.Title)</h4>
                            <p>@(isArabic ? related.SummaryAr ?? related.Summary : related.Summary)</p>
                            <a href="/case-studies/@related.Slug" class="btn btn-outline">
                                @(isArabic ? "اقرأ المزيد" : "Read More")
                                <i class="bi bi-arrow-@(isArabic ? "left" : "right")"></i>
                            </a>
                        </div>
                    </div>
                }
            </div>
        </div>
    </section>
}

<!-- CTA Section -->
<section style="padding: 4rem 0; background: var(--dark); text-align: center;">
    <div class="container">
        <div class="fade-up">
            <h2 class="text-white mb-4">
                @(isArabic ? "هل تريد تحقيق نتائج مماثلة؟" : "Want to Achieve Similar Results?")
            </h2>
            <p class="text-white-50 mb-4">
                @(isArabic ? "ابدأ رحلتك نحو الامتثال اليوم" : "Start your compliance journey today")
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <a href="/trial" class="btn btn-primary btn-lg">
                    <i class="bi bi-rocket-takeoff"></i>
                    @(isArabic ? "ابدأ تجربة مجانية" : "Start Free Trial")
                </a>
                <a href="/contact" class="btn btn-outline btn-lg">
                    <i class="bi bi-calendar-check"></i>
                    @(isArabic ? "احجز عرض توضيحي" : "Book a Demo")
                </a>
            </div>
        </div>
    </div>
</section>
