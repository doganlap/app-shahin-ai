@model StepAOrganizationIdentityDto
@using GrcMvc.Models.DTOs
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer L
@{
    ViewData["Title"] = L["Onboarding_StepA_Title"];
    Layout = "~/Views/Shared/_Layout.cshtml";
    var summary = ViewData["WizardSummary"] as WizardSummaryDto;
    var tenantId = summary?.TenantId ?? Guid.Empty;
}

<div class="d-flex wizard-container">
    <!-- Sidebar -->
    @await Html.PartialAsync("_WizardSidebar", summary)

    <!-- Main Content -->
    <div class="flex-grow-1 p-4 wizard-main-content">
        <!-- Language Toggle -->
        @await Html.PartialAsync("_LanguageToggle")

        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-building text-primary me-2"></i>
                        @L["Onboarding_StepA_Heading"]
                    </h2>
                    <p class="text-muted mb-0">
                        @L["Onboarding_StepA_Questions"] |
                        <span class="question-counter">@L["Onboarding_TotalQuestions"]</span>
                    </p>
                </div>
                <span class="badge bg-primary fs-6">@L["Onboarding_StepIndicator", 1, 12]</span>
            </div>

            <form asp-action="StepA" asp-route-tenantId="@tenantId" method="post" id="stepAForm">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="All" class="alert alert-danger" role="alert" style="display: none;"></div>

                <!-- Section: Legal Name -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-id-card me-2"></i>@L["Onboarding_StepA_LegalName_Header"]</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="OrganizationLegalNameEn" class="form-label">
                                    <span class="text-danger">*</span> @L["Onboarding_StepA_LegalNameEn_Label"]
                                </label>
                                <input asp-for="OrganizationLegalNameEn" class="form-control"
                                       placeholder="@L["Onboarding_StepA_LegalNameEn_Placeholder"]" required>
                                <span asp-validation-for="OrganizationLegalNameEn" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="OrganizationLegalNameAr" class="form-label">
                                    @L["Onboarding_StepA_LegalNameAr_Label"]
                                </label>
                                <input asp-for="OrganizationLegalNameAr" class="form-control" dir="rtl"
                                       placeholder="@L["Onboarding_StepA_LegalNameAr_Placeholder"]">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label asp-for="TradeName" class="form-label">
                                @L["Onboarding_StepA_TradeName_Label"]
                            </label>
                            <input asp-for="TradeName" class="form-control"
                                   placeholder="@L["Onboarding_StepA_TradeName_Placeholder"]">
                        </div>
                    </div>
                </div>

                <!-- Section: Geographic Information -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-globe me-2"></i>@L["Onboarding_StepA_Geographic_Header"]</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="CountryOfIncorporation" class="form-label">
                                    <span class="text-danger">*</span> @L["Onboarding_StepA_Country_Label"]
                                </label>
                                <select asp-for="CountryOfIncorporation" class="form-select" required>
                                    <option value="">@L["Onboarding_SelectCountry"]</option>
                                    <option value="SA">@L["Country_SA"]</option>
                                    <option value="AE">@L["Country_AE"]</option>
                                    <option value="QA">@L["Country_QA"]</option>
                                    <option value="KW">@L["Country_KW"]</option>
                                    <option value="BH">@L["Country_BH"]</option>
                                    <option value="OM">@L["Country_OM"]</option>
                                    <option value="EG">@L["Country_EG"]</option>
                                    <option value="JO">@L["Country_JO"]</option>
                                </select>
                                <span asp-validation-for="CountryOfIncorporation" class="text-danger small"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="PrimaryHqLocation" class="form-label">
                                    @L["Onboarding_StepA_HqLocation_Label"]
                                </label>
                                <input asp-for="PrimaryHqLocation" class="form-control"
                                       placeholder="@L["Onboarding_StepA_HqLocation_Placeholder"]">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="DefaultTimezone" class="form-label">
                                    @L["Onboarding_StepA_Timezone_Label"]
                                </label>
                                <select asp-for="DefaultTimezone" class="form-select">
                                    <option value="Asia/Riyadh">Asia/Riyadh (GMT+3)</option>
                                    <option value="Asia/Dubai">Asia/Dubai (GMT+4)</option>
                                    <option value="Asia/Qatar">Asia/Qatar (GMT+3)</option>
                                    <option value="Asia/Kuwait">Asia/Kuwait (GMT+3)</option>
                                    <option value="Africa/Cairo">Africa/Cairo (GMT+2)</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@L["Onboarding_StepA_OperatingCountries_Label"]</label>
                            <div class="row">
                                @{
                                    var countries = new[] {
                                        ("SA", "Saudi Arabia"), ("AE", "UAE"), ("QA", "Qatar"),
                                        ("KW", "Kuwait"), ("BH", "Bahrain"), ("OM", "Oman"),
                                        ("EG", "Egypt"), ("JO", "Jordan"), ("LB", "Lebanon")
                                    };
                                }
                                @foreach (var (code, name) in countries)
                                {
                                    <div class="col-md-3 col-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input operating-country"
                                                   name="OperatingCountries" value="@code" id="country_@code"
                                                   @(Model.OperatingCountries.Contains(code) ? "checked" : "")>
                                            <label class="form-check-label" for="country_@code">@name</label>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section: Organization Type & Industry -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-industry me-2"></i>@L["Onboarding_StepA_OrgType_Header"]</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="OrganizationType" class="form-label">
                                    <span class="text-danger">*</span> @L["Onboarding_StepA_OrgType_Label"]
                                </label>
                                <select asp-for="OrganizationType" class="form-select" required id="orgTypeSelect">
                                    <option value="">@L["Onboarding_SelectType"]</option>
                                    <option value="enterprise">@L["OrgType_Enterprise"]</option>
                                    <option value="sme">@L["OrgType_SME"]</option>
                                    <option value="startup">@L["OrgType_Startup"]</option>
                                    <option value="government">@L["OrgType_Government"]</option>
                                    <option value="regulated_fi">@L["OrgType_RegulatedFI"]</option>
                                    <option value="fintech">@L["OrgType_Fintech"]</option>
                                    <option value="telecom">@L["OrgType_Telecom"]</option>
                                    <option value="healthcare">@L["OrgType_Healthcare"]</option>
                                    <option value="other">@L["OrgType_Other"]</option>
                                </select>
                                <span asp-validation-for="OrganizationType" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="IndustrySector" class="form-label">
                                    <span class="text-danger">*</span> @L["Onboarding_StepA_Industry_Label"]
                                </label>
                                <select asp-for="IndustrySector" class="form-select" required id="sectorSelect">
                                    <option value="">@L["Onboarding_SelectSector"]</option>
                                    <option value="Banking">@L["Industry_Banking"]</option>
                                    <option value="Insurance">@L["Industry_Insurance"]</option>
                                    <option value="Healthcare">@L["Industry_Healthcare"]</option>
                                    <option value="Telecom">@L["Industry_Telecom"]</option>
                                    <option value="Energy">@L["Industry_Energy"]</option>
                                    <option value="Government">@L["Industry_Government"]</option>
                                    <option value="Retail">@L["Industry_Retail"]</option>
                                    <option value="Technology">@L["Industry_Technology"]</option>
                                    <option value="Manufacturing">@L["Industry_Manufacturing"]</option>
                                    <option value="Education">@L["Industry_Education"]</option>
                                    <option value="RealEstate">@L["Industry_RealEstate"]</option>
                                    <option value="Transportation">@L["Industry_Transportation"]</option>
                                    <option value="Other">@L["Industry_Other"]</option>
                                </select>
                                <span asp-validation-for="IndustrySector" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@L["Onboarding_StepA_BusinessLines_Label"]</label>
                            <div class="row">
                                @{
                                    var businessLines = new[] {
                                        "retail", "corporate", "payments", "lending", "wealth",
                                        "insurance", "investment", "telecom_services", "ict_services"
                                    };
                                }
                                @foreach (var bl in businessLines)
                                {
                                    <div class="col-md-3 col-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input"
                                                   name="BusinessLines" value="@bl" id="bl_@bl"
                                                   @(Model.BusinessLines.Contains(bl) ? "checked" : "")>
                                            <label class="form-check-label" for="bl_@bl">
                                                @System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(bl.Replace("_", " ").ToLower())
                                            </label>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section: Communication & Verification -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>@L["Onboarding_StepA_Communication_Header"]</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="PrimaryLanguage" class="form-label">
                                    @L["Onboarding_StepA_PrimaryLanguage_Label"]
                                </label>
                                <select asp-for="PrimaryLanguage" class="form-select">
                                    <option value="bilingual">@L["Language_Bilingual"]</option>
                                    <option value="english">@L["Language_EnglishOnly"]</option>
                                    <option value="arabic">@L["Language_ArabicOnly"]</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="DomainVerificationMethod" class="form-label">
                                    @L["Onboarding_StepA_DomainVerification_Label"]
                                </label>
                                <select asp-for="DomainVerificationMethod" class="form-select">
                                    <option value="admin_email">@L["DomainVerification_AdminEmail"]</option>
                                    <option value="dns_txt">@L["DomainVerification_DNS"]</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@L["Onboarding_StepA_EmailDomains_Label"]</label>
                            <div id="emailDomainsContainer">
                                @if (Model.CorporateEmailDomains.Any())
                                {
                                    foreach (var domain in Model.CorporateEmailDomains)
                                    {
                                        <div class="input-group mb-2 email-domain-row">
                                            <span class="input-group-text">@@</span>
                                            <input type="text" class="form-control" name="CorporateEmailDomains"
                                                   value="@domain" placeholder="@L["Onboarding_StepA_EmailDomain_Placeholder"]">
                                            <button type="button" class="btn btn-outline-danger remove-domain">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="input-group mb-2 email-domain-row">
                                        <span class="input-group-text">@@</span>
                                        <input type="text" class="form-control" name="CorporateEmailDomains"
                                               placeholder="@L["Onboarding_StepA_EmailDomain_Placeholder"]">
                                        <button type="button" class="btn btn-outline-danger remove-domain">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                }
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addEmailDomain">
                                <i class="fas fa-plus me-1"></i> @L["Onboarding_StepA_AddDomain"]
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section: Data Residency -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-database me-2"></i>@L["Onboarding_StepA_DataResidency_Header"]</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="hasDataResidency"
                                   asp-for="HasDataResidencyRequirement">
                            <label class="form-check-label" for="hasDataResidency">
                                <strong>@L["Onboarding_StepA_DataResidency_Label"]</strong>
                            </label>
                            <small class="text-muted d-block">
                                @L["Onboarding_StepA_DataResidency_Help"]
                            </small>
                        </div>

                        <div id="dataResidencyCountries" style="display: @(Model.HasDataResidencyRequirement ? "block" : "none");">
                            <label class="form-label">@L["Onboarding_StepA_DataResidencyCountries_Label"]</label>
                            <div class="row">
                                @foreach (var (code, name) in countries)
                                {
                                    <div class="col-md-3 col-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input"
                                                   name="DataResidencyCountries" value="@code" id="dr_@code"
                                                   @(Model.DataResidencyCountries.Contains(code) ? "checked" : "")>
                                            <label class="form-check-label" for="dr_@code">@name</label>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <div>
                        <a href="@Url.Action("Index", "Dashboard")" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-times me-1"></i> @L["Button_Cancel"]
                        </a>
                    </div>
                    <div>
                        <a href="@Url.Action("SaveAndExit", "OnboardingWizard", new { tenantId = ViewBag.TenantId })"
                           class="btn btn-warning me-2"
                           onclick="return confirm('@L["Onboarding_SaveAndExit_Confirm"]');">
                            <i class="fas fa-save me-1"></i> @L["Button_SaveContinueLater"]
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            @L["Button_SaveContinueToStepB"]
                            <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="~/css/wizard-enhancements.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/wizard-enterprise-theme.css" asp-append-version="true" />
    <script src="~/js/wizard-autosave.js" asp-append-version="true"></script>
    <script src="~/js/wizard-validation.js" asp-append-version="true"></script>
    <script src="~/js/wizard-helpers.js" asp-append-version="true"></script>
    <script src="~/js/wizard-file-upload.js" asp-append-version="true"></script>

    <script>
        // Initialize auto-save
        const autoSave = new WizardAutoSave('stepAForm', '@tenantId', 'StepA');

        // Initialize helpers (already auto-initialized but we can access instance)
        const helpers = new WizardHelpers();

        // Toggle data residency countries visibility
        document.getElementById('hasDataResidency').addEventListener('change', function() {
            document.getElementById('dataResidencyCountries').style.display = this.checked ? 'block' : 'none';
        });

        // Add email domain
        document.getElementById('addEmailDomain').addEventListener('click', function() {
            const container = document.getElementById('emailDomainsContainer');
            const row = document.createElement('div');
            row.className = 'input-group mb-2 email-domain-row';
            row.innerHTML = `
                <span class="input-group-text">@@</span>
                <input type="text" class="form-control" name="CorporateEmailDomains"
                       placeholder="company.com" data-validate="domain">
                <button type="button" class="btn btn-outline-danger remove-domain">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(row);

            // Attach validation to new domain input
            const newInput = row.querySelector('input');
            const validation = new WizardValidation();
            validation.attachValidation(newInput, 'domain');
        });

        // Remove email domain
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-domain')) {
                const row = e.target.closest('.email-domain-row');
                if (document.querySelectorAll('.email-domain-row').length > 1) {
                    row.remove();
                } else {
                    row.querySelector('input').value = '';
                }
            }
        });

        // Validation display
        const validationSummary = document.querySelector('[data-valmsg-summary]');
        if (validationSummary && validationSummary.textContent.trim()) {
            validationSummary.style.display = 'block';
        }

        // Add validation attributes to email domain fields
        document.querySelectorAll('input[name="CorporateEmailDomains"]').forEach(input => {
            input.setAttribute('data-validate', 'domain');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S to trigger auto-save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                autoSave.performAutoSave();
            }

            // Ctrl+Right Arrow to go to next step
            if (e.ctrlKey && e.key === 'ArrowRight') {
                e.preventDefault();
                document.querySelector('button[type="submit"]').click();
            }
        });

        // Clear local storage on successful form submission
        document.getElementById('stepAForm').addEventListener('submit', function() {
            autoSave.clearLocalStorage();
        });
    </script>
}
