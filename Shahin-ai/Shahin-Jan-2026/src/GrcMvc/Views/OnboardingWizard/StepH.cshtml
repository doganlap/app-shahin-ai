@model StepHTeamsRolesDto
@using GrcMvc.Models.DTOs
@{
    ViewData["Title"] = "Teams, Roles & Access - Onboarding Wizard";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var summary = ViewData["WizardSummary"] as WizardSummaryDto;
    var tenantId = summary?.TenantId ?? Guid.Empty;
    var availableRoles = ViewData["AvailableRoles"] as List<object> ?? new List<object>();
}

<div class="d-flex">
    @await Html.PartialAsync("_WizardSidebar", summary)

    <div class="flex-grow-1 p-4">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-user-friends text-primary me-2"></i>
                        Step H: Teams, Roles & Access
                    </h2>
                    <p class="text-muted mb-0">
                        الفرق والأدوار والوصول | Questions 61-70 • So workflow "recognizes" people
                    </p>
                </div>
                <span class="badge bg-primary fs-6">Step 8 of 12</span>
            </div>

            <form asp-action="StepH" asp-route-tenantId="@tenantId" method="post">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="All" class="alert alert-danger" role="alert" style="display: none;"></div>

                <!-- Org Admins -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Organization Admins (Q61) <span class="text-warning">*</span></h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Who will be the primary administrators for this organization?</p>
                        <div id="orgAdminsContainer">
                            @if (Model.OrgAdmins.Any())
                            {
                                for (int i = 0; i < Model.OrgAdmins.Count; i++)
                                {
                                    <div class="row mb-2 admin-row">
                                        <div class="col-md-5">
                                            <input type="text" class="form-control" name="OrgAdmins[@i].Name" 
                                                   value="@Model.OrgAdmins[i].Name" placeholder="Full Name" required>
                                        </div>
                                        <div class="col-md-5">
                                            <input type="email" class="form-control" name="OrgAdmins[@i].Email" 
                                                   value="@Model.OrgAdmins[i].Email" placeholder="Email" required>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-danger remove-admin">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="row mb-2 admin-row">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" name="OrgAdmins[0].Name" 
                                               placeholder="Full Name" required>
                                    </div>
                                    <div class="col-md-5">
                                        <input type="email" class="form-control" name="OrgAdmins[0].Email" 
                                               placeholder="Email" required>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-danger remove-admin" disabled>
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addAdminBtn">
                            <i class="fas fa-plus me-1"></i> Add Another Admin
                        </button>
                    </div>
                </div>

                <!-- Create Teams Now -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Teams Setup (Q62-64)</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="createTeamsNow" 
                                   asp-for="CreateTeamsNow">
                            <label class="form-check-label" for="createTeamsNow">
                                <strong>Create teams now during onboarding</strong>
                            </label>
                            <small class="text-muted d-block">
                                Define team structure for workflow routing (you can also do this later)
                            </small>
                        </div>

                        <div id="teamsSection" style="display: @(Model.CreateTeamsNow ? "block" : "none");">
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Suggested Teams:</strong> Risk Ops, Security, IT Ops, App Owners, Procurement, Compliance, Internal Audit
                            </div>

                            <div id="teamsContainer">
                                @if (Model.TeamList.Any())
                                {
                                    for (int i = 0; i < Model.TeamList.Count; i++)
                                    {
                                        var team = Model.TeamList[i];
                                        <div class="card mb-3 team-card">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-3 mb-2">
                                                        <label class="form-label small">Team Name</label>
                                                        <input type="text" class="form-control" name="TeamList[@i].TeamName" 
                                                               value="@team.TeamName" placeholder="e.g., Security Ops">
                                                    </div>
                                                    <div class="col-md-3 mb-2">
                                                        <label class="form-label small">Team Type</label>
                                                        <select class="form-select" name="TeamList[@i].TeamType">
                                                            <option value="Operational" selected="@(team.TeamType == "Operational")">Operational</option>
                                                            <option value="Governance" selected="@(team.TeamType == "Governance")">Governance</option>
                                                            <option value="Project" selected="@(team.TeamType == "Project")">Project</option>
                                                            <option value="External" selected="@(team.TeamType == "External")">External</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3 mb-2">
                                                        <label class="form-label small">Team Owner Email</label>
                                                        <input type="email" class="form-control" name="TeamList[@i].TeamOwnerEmail" 
                                                               value="@team.TeamOwnerEmail" placeholder="owner@company.com">
                                                    </div>
                                                    <div class="col-md-2 mb-2">
                                                        <label class="form-label small">Backup Owner</label>
                                                        <input type="email" class="form-control" name="TeamList[@i].BackupOwnerEmail" 
                                                               value="@team.BackupOwnerEmail" placeholder="backup@company.com">
                                                    </div>
                                                    <div class="col-md-1 mb-2 d-flex align-items-end">
                                                        <button type="button" class="btn btn-outline-danger remove-team">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            <button type="button" class="btn btn-outline-success" id="addTeamBtn">
                                <i class="fas fa-plus me-1"></i> Add Team
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Role Catalog -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-user-tag me-2"></i>Role Catalog (Q65)</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Which roles will you use in your organization?</p>
                        <div class="row">
                            @{
                                var roles = new[] {
                                    ("CONTROL_OWNER", "Control Owner", "مالك الضابط", "Owns and maintains control effectiveness"),
                                    ("EVIDENCE_CUSTODIAN", "Evidence Custodian", "أمين الأدلة", "Collects and uploads evidence"),
                                    ("APPROVER", "Approver", "معتمد", "Reviews and approves submissions"),
                                    ("ASSESSOR_TESTER", "Assessor/Tester", "مُقيّم/مختبر", "Tests control effectiveness"),
                                    ("REMEDIATION_OWNER", "Remediation Owner", "مالك المعالجة", "Fixes findings and gaps"),
                                    ("VIEWER_AUDITOR", "Viewer/Auditor", "مشاهد/مدقق", "Read-only access for auditors")
                                };
                            }
                            @foreach (var (code, name, nameAr, desc) in roles)
                            {
                                <div class="col-md-6 mb-3">
                                    <div class="form-check card p-3 @(Model.SelectedRoleCatalog.Contains(code) ? "border-primary bg-light" : "")">
                                        <input type="checkbox" class="form-check-input" 
                                               name="SelectedRoleCatalog" value="@code" id="role_@code"
                                               @(Model.SelectedRoleCatalog.Contains(code) ? "checked" : "")>
                                        <label class="form-check-label" for="role_@code">
                                            <strong>@name</strong> <small class="text-muted">(@nameAr)</small>
                                            <small class="text-muted d-block">@desc</small>
                                        </label>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- RACI Mapping -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>RACI Mapping (Q66)</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="raciMappingNeeded" 
                                   asp-for="RaciMappingNeeded">
                            <label class="form-check-label" for="raciMappingNeeded">
                                <strong>Define RACI mapping per control family/system</strong>
                            </label>
                            <small class="text-muted d-block">
                                Map Responsible/Accountable/Consulted/Informed per scope
                            </small>
                        </div>
                        
                        <div id="raciSection" style="display: @(Model.RaciMappingNeeded ? "block" : "none");">
                            <div class="alert alert-secondary">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Tip:</strong> You can define detailed RACI mappings after initial setup in the Admin section.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications & Escalation -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Notifications & Escalation (Q69-70)</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="NotificationPreference" class="form-label">Notification Channel</label>
                                <select asp-for="NotificationPreference" class="form-select">
                                    <option value="email">Email Only</option>
                                    <option value="teams">Microsoft Teams Only</option>
                                    <option value="both">Both Email + Teams</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="EscalationDaysOverdue" class="form-label">Escalate After (Days Overdue)</label>
                                <input type="number" asp-for="EscalationDaysOverdue" class="form-control" min="1" max="30">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="EscalationTarget" class="form-label">Escalate To</label>
                                <select asp-for="EscalationTarget" class="form-select">
                                    <option value="manager">Direct Manager</option>
                                    <option value="team_lead">Team Lead</option>
                                    <option value="department_head">Department Head</option>
                                    <option value="ciso">CISO</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="@Url.Action("StepG", new { tenantId })" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back to Step G
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg">
                        Continue to Step I: Workflow & Cadence
                        <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var adminIndex = @(Model.OrgAdmins.Count > 0 ? Model.OrgAdmins.Count : 1);
        var teamIndex = @(Model.TeamList.Count > 0 ? Model.TeamList.Count : 0);

        // Toggle teams section
        document.getElementById('createTeamsNow').addEventListener('change', function() {
            document.getElementById('teamsSection').style.display = this.checked ? 'block' : 'none';
        });

        // Toggle RACI section
        document.getElementById('raciMappingNeeded').addEventListener('change', function() {
            document.getElementById('raciSection').style.display = this.checked ? 'block' : 'none';
        });

        // Add admin
        document.getElementById('addAdminBtn').addEventListener('click', function() {
            const container = document.getElementById('orgAdminsContainer');
            const row = document.createElement('div');
            row.className = 'row mb-2 admin-row';
            row.innerHTML = `
                <div class="col-md-5">
                    <input type="text" class="form-control" name="OrgAdmins[${adminIndex}].Name" placeholder="Full Name" required>
                </div>
                <div class="col-md-5">
                    <input type="email" class="form-control" name="OrgAdmins[${adminIndex}].Email" placeholder="Email" required>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger remove-admin"><i class="fas fa-times"></i></button>
                </div>
            `;
            container.appendChild(row);
            adminIndex++;
        });

        // Add team
        document.getElementById('addTeamBtn').addEventListener('click', function() {
            const container = document.getElementById('teamsContainer');
            const card = document.createElement('div');
            card.className = 'card mb-3 team-card';
            card.innerHTML = `
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <label class="form-label small">Team Name</label>
                            <input type="text" class="form-control" name="TeamList[${teamIndex}].TeamName" placeholder="e.g., Security Ops">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label small">Team Type</label>
                            <select class="form-select" name="TeamList[${teamIndex}].TeamType">
                                <option value="Operational">Operational</option>
                                <option value="Governance">Governance</option>
                                <option value="Project">Project</option>
                                <option value="External">External</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label small">Team Owner Email</label>
                            <input type="email" class="form-control" name="TeamList[${teamIndex}].TeamOwnerEmail" placeholder="owner@company.com">
                        </div>
                        <div class="col-md-2 mb-2">
                            <label class="form-label small">Backup Owner</label>
                            <input type="email" class="form-control" name="TeamList[${teamIndex}].BackupOwnerEmail" placeholder="backup@company.com">
                        </div>
                        <div class="col-md-1 mb-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger remove-team"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
            teamIndex++;
        });

        // Remove handlers
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-admin')) {
                const rows = document.querySelectorAll('.admin-row');
                if (rows.length > 1) {
                    e.target.closest('.admin-row').remove();
                }
            }
            if (e.target.closest('.remove-team')) {
                e.target.closest('.team-card').remove();
            }
        });
    </script>
}
