@*
    Onboarding Wizard Progress Widget for Dashboard
    Shows completion status, current step, and progress percentage
*@
@model dynamic

@{
    var onboardingStatus = ViewBag.OnboardingStatus as string ?? "NOT_STARTED";
    var onboardingUrl = ViewBag.OnboardingUrl as string ?? "/OnboardingWizard";
    var tenantId = ViewBag.TenantId as Guid? ?? Guid.Empty;

    // Calculate progress from database (this will come from the controller)
    var currentStep = ViewBag.OnboardingCurrentStep as int? ?? 1;
    var completedSteps = ViewBag.OnboardingCompletedSteps as int? ?? 0;
    var totalSteps = 12;
    var progressPercent = Math.Round((double)completedSteps / totalSteps * 100, 0);

    var isCompleted = onboardingStatus == "COMPLETED";
    var isInProgress = onboardingStatus == "IN_PROGRESS";
    var isNotStarted = onboardingStatus == "NOT_STARTED";

    var statusColor = isCompleted ? "green" : isInProgress ? "blue" : "orange";
    var statusIcon = isCompleted ? "bi-check-circle-fill" : isInProgress ? "bi-arrow-repeat" : "bi-clock-history";
    var statusText = isCompleted ? "Completed" : isInProgress ? "In Progress" : "Not Started";
    var statusTextAr = isCompleted ? "مكتمل" : isInProgress ? "قيد التنفيذ" : "لم يبدأ";
}

@if (!isCompleted)
{
    <!-- Onboarding Progress Widget -->
    <div class="dash-panel onboarding-widget" style="margin-bottom: 24px; border: 2px solid var(--wizard-accent-@statusColor); position: relative; overflow: hidden;">
        <!-- Animated Background Gradient -->
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(16,185,129,0.05) 0%, rgba(59,130,246,0.05) 100%); opacity: 0.5; animation: pulse 3s ease-in-out infinite;"></div>

        <div class="panel-header" style="position: relative; z-index: 1; background: rgba(16,185,129,0.1);">
            <h5 class="panel-title">
                <span class="panel-title-icon @statusColor">
                    <i class="bi bi-clipboard-check-fill"></i>
                </span>
                <span data-i18n-en="Organization Onboarding" data-i18n-ar="إعداد المنظمة">Organization Onboarding</span>
            </h5>
            <div style="display: flex; align-items: center; gap: 12px;">
                <span class="dash-badge dash-badge-@statusColor">
                    <i class="bi @statusIcon"></i>
                    <span data-i18n-en="@statusText" data-i18n-ar="@statusTextAr">@statusText</span>
                </span>
                <span class="dash-badge dash-badge-primary">
                    @progressPercent%
                </span>
            </div>
        </div>

        <div class="panel-body" style="position: relative; z-index: 1;">
            @if (isNotStarted)
            {
                <!-- Not Started State -->
                <div style="text-align: center; padding: 20px 0;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 16px; background: var(--wizard-gradient-warning); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 30px rgba(245,158,11,0.4); animation: pulse 2s ease-in-out infinite;">
                        <i class="bi bi-rocket-takeoff-fill" style="font-size: 2.5rem; color: white;"></i>
                    </div>
                    <h4 style="color: var(--dash-text-primary); margin-bottom: 8px;">
                        <span data-i18n-en="Ready to Get Started?" data-i18n-ar="هل أنت مستعد للبدء؟">Ready to Get Started?</span>
                    </h4>
                    <p style="color: var(--dash-text-secondary); margin-bottom: 24px; max-width: 500px; margin-left: auto; margin-right: auto;">
                        <span data-i18n-en="Complete the 12-step onboarding wizard to set up your organization profile, compliance frameworks, and GRC system configuration."
                              data-i18n-ar="أكمل معالج الإعداد المكون من 12 خطوة لإعداد ملف تعريف مؤسستك وأطر الامتثال وتكوين نظام GRC.">
                            Complete the 12-step onboarding wizard to set up your organization profile, compliance frameworks, and GRC system configuration.
                        </span>
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <a href="@onboardingUrl" class="btn btn-lg" style="background: var(--wizard-gradient-primary); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; box-shadow: var(--wizard-glow-primary); transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                            <i class="bi bi-play-circle-fill"></i>
                            <span data-i18n-en="Start Onboarding" data-i18n-ar="ابدأ الإعداد">Start Onboarding</span>
                        </a>
                        <button class="btn btn-outline" style="border: 1px solid var(--wizard-border); color: var(--dash-text-primary); background: transparent; padding: 12px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px;" onclick="showOnboardingDetails()">
                            <i class="bi bi-info-circle"></i>
                            <span data-i18n-en="Learn More" data-i18n-ar="اعرف المزيد">Learn More</span>
                        </button>
                    </div>
                </div>
            }
            else
            {
                <!-- In Progress State -->
                <div>
                    <!-- Progress Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: var(--dash-text-secondary); font-size: 0.875rem;">
                                <span data-i18n-en="Step @currentStep of @totalSteps" data-i18n-ar="الخطوة @currentStep من @totalSteps">
                                    Step @currentStep of @totalSteps
                                </span>
                            </span>
                            <span style="color: var(--wizard-accent-primary); font-weight: 600; font-size: 1.125rem;">
                                @progressPercent%
                            </span>
                        </div>
                        <div class="progress-bar-bg" style="height: 12px; background: var(--wizard-bg-tertiary); border-radius: 8px; overflow: hidden; position: relative;">
                            <div class="progress-bar-fill" style="height: 100%; width: @progressPercent%; background: var(--wizard-gradient-primary); border-radius: 8px; transition: width 0.6s ease; position: relative; overflow: hidden;">
                                <!-- Animated shine effect -->
                                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shine 2s infinite;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Steps Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        @for (int i = 1; i <= Math.Min(6, totalSteps); i++)
                        {
                            var stepCompleted = i <= completedSteps;
                            var stepCurrent = i == currentStep;
                            var stepLocked = i > currentStep;
                            var stepClass = stepCompleted ? "completed" : stepCurrent ? "current" : "locked";
                            var stepIconClass = stepCompleted ? "bi-check-circle-fill" : stepCurrent ? "bi-arrow-right-circle-fill" : "bi-circle";
                            var stepColor = stepCompleted ? "var(--wizard-accent-primary)" : stepCurrent ? "var(--wizard-accent-secondary)" : "var(--dash-text-tertiary)";

                            <div class="onboarding-step-card @stepClass" style="background: var(--wizard-bg-tertiary); border: 1px solid var(--wizard-border); border-radius: 8px; padding: 12px; text-align: center; transition: all 0.3s ease; @(stepCurrent ? "border-color: var(--wizard-accent-secondary); box-shadow: 0 0 20px rgba(59,130,246,0.3);" : "")">
                                <div style="font-size: 1.5rem; color: @stepColor; margin-bottom: 4px;">
                                    <i class="bi @stepIconClass"></i>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--dash-text-secondary); font-weight: 500;">
                                    Step @i
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Current Step Info -->
                    <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 48px; height: 48px; background: var(--wizard-gradient-secondary); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: var(--wizard-glow-secondary);">
                                <i class="bi bi-lightning-charge-fill" style="font-size: 1.5rem; color: white;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="color: var(--dash-text-primary); font-weight: 600; margin-bottom: 4px;">
                                    <span data-i18n-en="You're Making Great Progress!" data-i18n-ar="أنت تحرز تقدمًا رائعًا!">
                                        You're Making Great Progress!
                                    </span>
                                </div>
                                <div style="color: var(--dash-text-secondary); font-size: 0.875rem;">
                                    <span data-i18n-en="@completedSteps steps completed. Keep going to unlock your full GRC capabilities."
                                          data-i18n-ar="@completedSteps خطوات مكتملة. استمر لفتح قدرات GRC الكاملة.">
                                        @completedSteps steps completed. Keep going to unlock your full GRC capabilities.
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <a href="@onboardingUrl" class="btn" style="flex: 1; min-width: 180px; background: var(--wizard-gradient-primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; box-shadow: var(--wizard-glow-primary); transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="bi bi-play-fill"></i>
                            <span data-i18n-en="Continue Onboarding" data-i18n-ar="متابعة الإعداد">Continue Onboarding</span>
                        </a>
                        <a href="@(onboardingUrl)/Summary/@tenantId" class="btn btn-outline" style="border: 1px solid var(--wizard-border); color: var(--dash-text-primary); background: transparent; padding: 12px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="bi bi-list-check"></i>
                            <span data-i18n-en="View Summary" data-i18n-ar="عرض الملخص">View Summary</span>
                        </a>
                        <button class="btn btn-outline" style="border: 1px solid var(--wizard-border); color: var(--dash-text-secondary); background: transparent; padding: 12px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px;" onclick="saveAndExitOnboarding('@tenantId')">
                            <i class="bi bi-save"></i>
                            <span data-i18n-en="Save & Exit" data-i18n-ar="حفظ والخروج">Save & Exit</span>
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
}

<style>
@@keyframes pulse {
    0%, 100% { opacity: 0.5; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.02); }
}

@@keyframes shine {
    0% { left: -100%; }
    100% { left: 100%; }
}

.onboarding-widget .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3) !important;
}

.onboarding-widget .btn-outline:hover {
    background: var(--wizard-bg-tertiary);
    border-color: var(--wizard-border-hover);
}

.onboarding-step-card:hover:not(.locked) {
    transform: translateY(-2px);
    border-color: var(--wizard-border-hover) !important;
}

.onboarding-step-card.completed {
    border-color: var(--wizard-accent-primary) !important;
}
</style>

<script>
function showOnboardingDetails() {
    const message = `
الإعداد الشامل للمنظمة | Comprehensive Organization Setup

The onboarding wizard helps you:
✓ Set up organization profile and identity
✓ Define compliance objectives and frameworks
✓ Configure regulatory requirements
✓ Establish risk tolerance and scope
✓ Set up data classification and controls
✓ Configure user roles and permissions

Estimated time: 45-60 minutes
Can be completed in multiple sessions with auto-save
    `;
    alert(message);
}

async function saveAndExitOnboarding(tenantId) {
    if (!confirm('Save your progress and exit onboarding? You can continue later.')) return;

    try {
        const response = await fetch(\`/OnboardingWizard/SaveAndExit/\${tenantId}\`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            }
        });

        if (response.ok) {
            alert('Progress saved successfully!');
            window.location.reload();
        } else {
            alert('Failed to save progress. Please try again.');
        }
    } catch (error) {
        console.error('Save error:', error);
        alert('An error occurred. Please try again.');
    }
}
</script>
