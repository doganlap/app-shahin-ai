@{
    ViewData["Title"] = "Submit Evidence - GRC System";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4 mb-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <h1 class="h3">
                        <i class="fas fa-file-upload"></i> Submit Control Evidence
                    </h1>
                    <p class="text-muted">Upload documentation to demonstrate control compliance</p>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Evidence Details</h5>
                </div>

                <div class="card-body">
                    <form id="evidenceForm" enctype="multipart/form-data">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <span class="text-danger">*</span> Control ID
                                </label>
                                <input type="text" class="form-control" id="controlId" name="controlId"
                                    placeholder="e.g., AC-1.1" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">
                                    <span class="text-danger">*</span> Baseline
                                </label>
                                <select class="form-select" id="baseline" name="baseline" required>
                                    <option value="">-- Select Baseline --</option>
                                    <option value="BL_SAMA">SAMA - Banking</option>
                                    <option value="BL_PDPL">PDPL - Data Protection</option>
                                    <option value="BL_NRA">NRA - Cybersecurity</option>
                                    <option value="BL_MOI">MOI - Interior</option>
                                    <option value="BL_CMA">CMA - Capital Markets</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <span class="text-danger">*</span> Evidence Title
                            </label>
                            <input type="text" class="form-control" id="title" name="title"
                                placeholder="Brief description of the evidence (e.g., Access Control Policy v2.1)"
                                required>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Evidence Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"
                                placeholder="Additional details about this evidence..."></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <span class="text-danger">*</span> Evidence Type
                                </label>
                                <select class="form-select" id="evidenceType" name="evidenceType" required>
                                    <option value="">-- Select Type --</option>
                                    <option value="Policy">Policy Document</option>
                                    <option value="Procedure">Procedure Manual</option>
                                    <option value="Screenshot">System Screenshot</option>
                                    <option value="Report">Assessment Report</option>
                                    <option value="Log">System Log / Audit Trail</option>
                                    <option value="Certificate">Certificate / Compliance</option>
                                    <option value="Attestation">Attestation / Sign-off</option>
                                    <option value="Other">Other Documentation</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-4">
                                <label class="form-label">Effective Date</label>
                                <input type="date" class="form-control" id="effectiveDate" name="effectiveDate">
                            </div>
                        </div>

                        <!-- File Upload -->
                        <div class="mb-4">
                            <label class="form-label">
                                <span class="text-danger">*</span> Upload File(s)
                            </label>
                            <div class="card border-dashed" id="dropZone"
                                style="border: 2px dashed #007bff; padding: 40px; text-align: center; cursor: pointer;">
                                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                <p class="mb-2"><strong>Drag and drop files here</strong></p>
                                <p class="text-muted mb-3">or click to select files</p>
                                <input type="file" id="fileInput" name="files" multiple hidden>
                                <small class="text-muted d-block">
                                    Supported: PDF, Word, Excel, Images, ZIP (Max 10MB per file)
                                </small>
                            </div>
                            <div id="fileList" class="mt-3"></div>
                        </div>

                        <!-- Metadata -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label">Submitted By</label>
                                <input type="text" class="form-control" id="submittedBy" name="submittedBy"
                                    placeholder="Your name or role" value="">
                            </div>

                            <div class="col-md-6 mb-4">
                                <label class="form-label">Department</label>
                                <input type="text" class="form-control" id="department" name="department"
                                    placeholder="e.g., Compliance, IT Security">
                            </div>
                        </div>

                        <!-- Review Notes -->
                        <div class="mb-4">
                            <label class="form-label">Reviewer Notes (Optional)</label>
                            <textarea class="form-control" id="reviewNotes" name="reviewNotes" rows="2"
                                placeholder="Notes for the approver..."></textarea>
                        </div>

                        <!-- Confirmation -->
                        <div class="alert alert-info">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmAccuracy" required>
                                <label class="form-check-label" for="confirmAccuracy">
                                    I confirm this evidence accurately demonstrates compliance with the control
                                    requirements
                                </label>
                            </div>
                        </div>

                        <!-- Submit -->
                        <div class="d-grid gap-2 d-sm-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="history.back()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-upload"></i> Submit Evidence
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Box -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-info-circle text-info"></i> Tips for Good Evidence
                            </h5>
                            <ul class="small mb-0">
                                <li>Include current date on documents</li>
                                <li>Ensure documents are clearly readable</li>
                                <li>Include full context (don't crop screenshots)</li>
                                <li>Use official letterhead where applicable</li>
                                <li>Include approver signatures/names</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-clock text-warning"></i> Review Process
                            </h5>
                            <ul class="small mb-0">
                                <li>Evidence submitted for review</li>
                                <li>Control owner reviews (1-2 days)</li>
                                <li>Compliance manager approves/rejects</li>
                                <li>Feedback provided if revision needed</li>
                                <li>Final sign-off recorded</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const form = document.getElementById('evidenceForm');
    let selectedFiles = [];

    // Drag and drop functionality
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = '#f0f8ff';
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.backgroundColor = 'transparent';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = 'transparent';
        const files = e.dataTransfer.files;
        handleFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        selectedFiles = Array.from(files);
        displayFileList();
    }

    function displayFileList() {
        if (selectedFiles.length === 0) {
            fileList.innerHTML = '';
            return;
        }

        fileList.innerHTML = `
        <div class="alert alert-success">
            <strong>${selectedFiles.length} file(s) selected:</strong>
            <ul class="mt-2 mb-0">
                ${selectedFiles.map((f, i) => `
                    <li>${f.name} (${(f.size / 1024 / 1024).toFixed(2)} MB) 
                        <button type="button" class="btn-close btn-sm" onclick="removeFile(${i})" style="float: right;"></button>
                    </li>
                `).join('')}
            </ul>
        </div>
    `;
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        displayFileList();
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (selectedFiles.length === 0) {
            alert('Please select at least one file to upload');
            return;
        }

        if (!document.getElementById('confirmAccuracy').checked) {
            alert('Please confirm the accuracy of the evidence');
            return;
        }

        // Create FormData
        const formData = new FormData();
        formData.append('controlId', document.getElementById('controlId').value);
        formData.append('baseline', document.getElementById('baseline').value);
        formData.append('title', document.getElementById('title').value);
        formData.append('description', document.getElementById('description').value);
        formData.append('evidenceType', document.getElementById('evidenceType').value);
        formData.append('effectiveDate', document.getElementById('effectiveDate').value);
        formData.append('submittedBy', document.getElementById('submittedBy').value);
        formData.append('department', document.getElementById('department').value);
        formData.append('reviewNotes', document.getElementById('reviewNotes').value);

        selectedFiles.forEach(file => {
            formData.append('files', file);
        });

        try {
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            const response = await fetch('/api/evidence/submit', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                alert('Evidence submitted successfully!');
                window.location.href = '/Evidence/Details?evidenceId=' + result.id;
            } else {
                const error = await response.text();
                alert('Error submitting evidence: ' + error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-upload"></i> Submit Evidence';
            }
        } catch (error) {
            alert('Error: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-upload"></i> Submit Evidence';
        }
    });
</script>