@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<SharedResource> L
@model GrcMvc.Services.Interfaces.ResilienceDashboardDto
@{
    ViewData["Title"] = "Resilience Dashboard";
    Layout = "_Layout";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-shield-check"></i> @L["Resilience_Dashboard"]</h2>
            <p class="text-muted">@L["Resilience_DashboardSubtitle"]</p>
        </div>
        <div class="col text-end">
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create Initiative
            </a>
            <a asp-action="BIA" class="btn btn-outline-secondary">
                <i class="bi bi-diagram-3"></i> Business Impact Analysis
            </a>
            <a asp-action="Drills" class="btn btn-outline-info">
                <i class="bi bi-clipboard-check"></i> Resilience Drills
            </a>
        </div>
    </div>

    <!-- Key Resilience Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Overall Resilience</h6>
                            <h2 class="card-title mb-0">@Model.OverallResilienceScore.ToString("F0")%</h2>
                            <small class="opacity-75">@Model.OverallMaturity</small>
                        </div>
                        <i class="bi bi-shield-check display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Business Continuity</h6>
                            <h2 class="card-title mb-0">@Model.BusinessContinuity.OverallScore.ToString("F0")%</h2>
                            <small class="opacity-75">@Model.BusinessContinuity.MaturityLevel</small>
                        </div>
                        <i class="bi bi-arrow-repeat display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Disaster Recovery</h6>
                            <h2 class="card-title mb-0">@Model.DisasterRecovery.OverallScore.ToString("F0")%</h2>
                            <small class="opacity-75">@Model.DisasterRecovery.ReadinessLevel</small>
                        </div>
                        <i class="bi bi-hdd-network display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Incident Response</h6>
                            <h2 class="card-title mb-0">@Model.IncidentResponse.OpenIncidents</h2>
                            <small>Open Incidents</small>
                        </div>
                        <i class="bi bi-exclamation-triangle display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resilience Components Grid -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Business Continuity Management</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>BIA Coverage</span>
                            <strong>@Model.BusinessContinuity.BiaScore.ToString("F0")%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" role="progressbar"
                                 style="width: @Model.BusinessContinuity.BiaScore%"
                                 aria-valuenow="@Model.BusinessContinuity.BiaScore"
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>BCP Score</span>
                            <strong>@Model.BusinessContinuity.BcpScore.ToString("F0")%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: @Model.BusinessContinuity.BcpScore%"
                                 aria-valuenow="@Model.BusinessContinuity.BcpScore"
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Testing & Drills</span>
                            <strong>@Model.BusinessContinuity.TestingScore.ToString("F0")%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-primary" role="progressbar"
                                 style="width: @Model.BusinessContinuity.TestingScore%"
                                 aria-valuenow="@Model.BusinessContinuity.TestingScore"
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Training & Awareness</span>
                            <strong>@Model.BusinessContinuity.TrainingScore.ToString("F0")%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-warning" role="progressbar"
                                 style="width: @Model.BusinessContinuity.TrainingScore%"
                                 aria-valuenow="@Model.BusinessContinuity.TrainingScore"
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <h6 class="text-muted small mb-1">Critical Processes</h6>
                                    <h4 class="mb-0">@Model.BusinessContinuity.CriticalProcessesIdentified</h4>
                                    <small class="text-muted">Identified</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <h6 class="text-muted small mb-1">BCP Coverage</h6>
                                    <h4 class="mb-0">@Model.BusinessContinuity.CriticalProcessesCovered</h4>
                                    <small class="text-muted">Covered</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        @if (Model.BusinessContinuity.LastBcpTestDate.HasValue)
                        {
                            <div class="alert alert-info mb-2">
                                <small>
                                    <i class="bi bi-calendar-check"></i> Last BCP Test:
                                    @Model.BusinessContinuity.LastBcpTestDate.Value.ToShortDateString()
                                </small>
                            </div>
                        }
                        @if (Model.BusinessContinuity.NextBcpTestDate.HasValue)
                        {
                            var daysUntilTest = (Model.BusinessContinuity.NextBcpTestDate.Value - DateTime.UtcNow).Days;
                            var alertClass = daysUntilTest <= 7 ? "alert-danger" : (daysUntilTest <= 30 ? "alert-warning" : "alert-success");
                            <div class="alert @alertClass mb-0">
                                <small>
                                    <i class="bi bi-calendar3"></i> Next BCP Test:
                                    @Model.BusinessContinuity.NextBcpTestDate.Value.ToShortDateString()
                                    (@daysUntilTest days)
                                </small>
                            </div>
                        }
                    </div>

                    <div class="mt-3 text-center">
                        <a asp-action="Plans" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-file-text"></i> View BCP Plans
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-hdd-network"></i> Disaster Recovery Readiness</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>RTO Compliance</span>
                            <strong>@Model.DisasterRecovery.RtoCompliance.ToString("F0")%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-primary" role="progressbar"
                                 style="width: @Model.DisasterRecovery.RtoCompliance%"
                                 aria-valuenow="@Model.DisasterRecovery.RtoCompliance"
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>RPO Compliance</span>
                            <strong>@Model.DisasterRecovery.RpoCompliance.ToString("F0")%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" role="progressbar"
                                 style="width: @Model.DisasterRecovery.RpoCompliance%"
                                 aria-valuenow="@Model.DisasterRecovery.RpoCompliance"
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Backup Score</span>
                            <strong>@Model.DisasterRecovery.BackupScore.ToString("F0")%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: @Model.DisasterRecovery.BackupScore%"
                                 aria-valuenow="@Model.DisasterRecovery.BackupScore"
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Failover Score</span>
                            <strong>@Model.DisasterRecovery.FailoverScore.ToString("F0")%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-warning" role="progressbar"
                                 style="width: @Model.DisasterRecovery.FailoverScore%"
                                 aria-valuenow="@Model.DisasterRecovery.FailoverScore"
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <h6 class="text-muted small mb-1">Critical Systems</h6>
                                    <h4 class="mb-0">@Model.DisasterRecovery.TotalCriticalSystems</h4>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <h6 class="text-muted small mb-1">DR Plans</h6>
                                    <h4 class="mb-0">@Model.DisasterRecovery.SystemsWithDrPlan</h4>
                                    <small class="text-muted">With Plans</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="border rounded p-3 text-center bg-light">
                                    <h6 class="text-muted small mb-1">Average RTO</h6>
                                    <h4 class="mb-0">@Model.DisasterRecovery.AverageRtoHours.ToString("F1")h</h4>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center bg-light">
                                    <h6 class="text-muted small mb-1">Average RPO</h6>
                                    <h4 class="mb-0">@Model.DisasterRecovery.AverageRpoHours.ToString("F1")h</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        @if (Model.DisasterRecovery.LastDrTestDate.HasValue)
                        {
                            <div class="alert alert-info mb-2">
                                <small>
                                    <i class="bi bi-calendar-check"></i> Last DR Test:
                                    @Model.DisasterRecovery.LastDrTestDate.Value.ToShortDateString()
                                </small>
                            </div>
                        }
                        @if (Model.DisasterRecovery.NextDrTestDate.HasValue)
                        {
                            var daysUntilTest = (Model.DisasterRecovery.NextDrTestDate.Value - DateTime.UtcNow).Days;
                            var alertClass = daysUntilTest <= 7 ? "alert-danger" : (daysUntilTest <= 30 ? "alert-warning" : "alert-success");
                            <div class="alert @alertClass mb-0">
                                <small>
                                    <i class="bi bi-calendar3"></i> Next DR Test:
                                    @Model.DisasterRecovery.NextDrTestDate.Value.ToShortDateString()
                                    (@daysUntilTest days)
                                </small>
                            </div>
                        }
                    </div>

                    <div class="mt-3 text-center">
                        <a asp-action="RTO_RPO" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-clock-history"></i> View RTO/RPO
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incident Response & Recommendations -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Incident Response Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-4">
                            <div class="text-center p-3 border rounded">
                                <h3 class="mb-0 text-primary">@Model.IncidentResponse.TotalIncidents</h3>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-3 border rounded">
                                <h3 class="mb-0 text-warning">@Model.IncidentResponse.OpenIncidents</h3>
                                <small class="text-muted">Open</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-3 border rounded">
                                <h3 class="mb-0 text-danger">@Model.IncidentResponse.CriticalIncidents</h3>
                                <small class="text-muted">Critical</small>
                            </div>
                        </div>
                    </div>

                    <div class="list-group list-group-flush mb-3">
                        <div class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-clock"></i> Avg Response Time</span>
                            <strong>@Model.IncidentResponse.AverageResponseTimeHours.ToString("F1")h</strong>
                        </div>
                        <div class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-hourglass"></i> Avg Resolution Time</span>
                            <strong>@Model.IncidentResponse.AverageResolutionTimeHours.ToString("F1")h</strong>
                        </div>
                        <div class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-graph-up"></i> MTTR</span>
                            <strong>@Model.IncidentResponse.MttrHours.ToString("F1")h</strong>
                        </div>
                        <div class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-search"></i> MTTD</span>
                            <strong>@Model.IncidentResponse.MttdHours.ToString("F1")h</strong>
                        </div>
                    </div>

                    <div class="alert alert-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <i class="bi bi-calendar3"></i>
                                This Month: @Model.IncidentResponse.IncidentsThisMonth incidents
                            </span>
                            <span class="badge @GetTrendBadgeClass(Model.IncidentResponse.Trend)">
                                @Model.IncidentResponse.Trend
                            </span>
                        </div>
                    </div>

                    <div class="text-center">
                        <a asp-action="Incidents" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-list"></i> View All Incidents
                        </a>
                        <a asp-action="Monitoring" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-activity"></i> Monitoring Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Resilience Recommendations</h5>
                </div>
                <div class="card-body">
                    @if (Model.Recommendations.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var recommendation in Model.Recommendations)
                            {
                                var priorityBadge = recommendation.Priority switch
                                {
                                    "Critical" => "bg-danger",
                                    "High" => "bg-warning",
                                    "Medium" => "bg-info",
                                    _ => "bg-secondary"
                                };

                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                        <h6 class="mb-1">
                                            <i class="bi bi-arrow-right-circle"></i> @recommendation.Area
                                        </h6>
                                        <span class="badge @priorityBadge">@recommendation.Priority</span>
                                    </div>
                                    <p class="mb-1">@recommendation.Recommendation</p>
                                    <small class="text-muted">
                                        <i class="bi bi-graph-up"></i> Impact: @recommendation.Impact
                                    </small>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-check-circle display-1 text-success opacity-25"></i>
                            <p class="text-muted mt-3">No recommendations at this time. Your resilience posture is strong!</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Resilience Scores Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Resilience Score Breakdown</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="text-center p-4 border rounded">
                                <h6 class="text-muted mb-3">Cyber Resilience</h6>
                                <h2 class="mb-0">@Model.CyberResilienceScore.ToString("F0")%</h2>
                                <small class="text-muted">Protection & Recovery from Cyber Incidents</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-4 border rounded">
                                <h6 class="text-muted mb-3">Operational Resilience</h6>
                                <h2 class="mb-0">@Model.OperationalResilienceScore.ToString("F0")%</h2>
                                <small class="text-muted">Business Process Continuity</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-4 border rounded bg-primary text-white">
                                <h6 class="mb-3 opacity-75">Overall Maturity</h6>
                                <h2 class="mb-0">@Model.OverallMaturity</h2>
                                <small class="opacity-75">Current Maturity Level</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a asp-action="BIA" class="btn btn-outline-primary w-100">
                                <i class="bi bi-diagram-3 d-block mb-2" style="font-size: 2rem;"></i>
                                Business Impact Analysis
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a asp-action="RTO_RPO" class="btn btn-outline-info w-100">
                                <i class="bi bi-clock-history d-block mb-2" style="font-size: 2rem;"></i>
                                RTO/RPO Assessment
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a asp-action="Drills" class="btn btn-outline-success w-100">
                                <i class="bi bi-clipboard-check d-block mb-2" style="font-size: 2rem;"></i>
                                Manage Drills
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a asp-action="CreateIncident" class="btn btn-outline-warning w-100">
                                <i class="bi bi-exclamation-triangle d-block mb-2" style="font-size: 2rem;"></i>
                                Report Incident
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Info -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Dashboard Info:</strong>
                Generated: @Model.GeneratedAt.ToString("g") |
                Overall Resilience Score: @Model.OverallResilienceScore.ToString("F1")% |
                Maturity: @Model.OverallMaturity
            </div>
        </div>
    </div>
</div>

@functions {
    private string GetTrendBadgeClass(string trend)
    {
        return trend switch
        {
            "Improving" => "bg-success",
            "Stable" => "bg-info",
            "Deteriorating" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}

@section Scripts {
    <script>
        // Auto-refresh dashboard every 5 minutes
        setTimeout(function() {
            location.reload();
        }, 300000);
    </script>
}

@section Styles {
    <style>
        .progress {
            background-color: #e9ecef;
        }

        .card {
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
        }
    </style>
}
