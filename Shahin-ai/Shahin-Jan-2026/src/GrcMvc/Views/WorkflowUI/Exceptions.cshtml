@{
    ViewData["Title"] = "Exception Workflows";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3">
                <i class="fas fa-exclamation-circle text-warning me-2"></i>Exception Workflows
            </h1>
            <p class="text-muted">Manage control exceptions and waivers</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newExceptionModal">
                <i class="fas fa-plus"></i> Request Exception
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h3 id="pendingReviewCount">0</h3><small>Pending Review</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3 id="approvedCount">0</h3><small>Approved</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h3 id="expiringSoonCount">0</h3><small>Expiring Soon</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <h3 id="expiredCount">0</h3><small>Expired</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Exceptions Table -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Exception Requests</h5>
            <div>
                <select class="form-select form-select-sm d-inline-block w-auto" id="exceptionFilter" onchange="loadExceptionData()">
                    <option value="">All Status</option>
                    <option value="Pending">Pending Review</option>
                    <option value="Approved">Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Exception ID</th>
                            <th>Control</th>
                            <th>Requested By</th>
                            <th>Expiry Date</th>
                            <th>Status</th>
                            <th>Risk Level</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="exceptionsTableBody">
                        <tr>
                            <td colspan="7" class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Loading exceptions...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- New Exception Request Modal -->
<div class="modal fade" id="newExceptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Request Control Exception</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newExceptionForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Control ID <span class="text-danger">*</span></label>
                            <select class="form-select" id="exceptionControlId" required>
                                <option value="">Select a control...</option>
                                <!-- Dynamically loaded -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Control Title</label>
                            <input type="text" class="form-control" id="exceptionControlTitle" readonly placeholder="Auto-filled from control">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Risk Level <span class="text-danger">*</span></label>
                            <select class="form-select" id="exceptionRiskLevel" required>
                                <option value="">Select risk level...</option>
                                <option value="Low">Low - Minimal impact</option>
                                <option value="Medium">Medium - Moderate impact</option>
                                <option value="High">High - Significant impact</option>
                                <option value="Critical">Critical - Severe impact</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Exception Duration <span class="text-danger">*</span></label>
                            <select class="form-select" id="exceptionDuration" required onchange="calculateExpiryDate()">
                                <option value="">Select duration...</option>
                                <option value="30">30 Days</option>
                                <option value="90">90 Days (Quarter)</option>
                                <option value="180">180 Days (Half Year)</option>
                                <option value="365">1 Year</option>
                                <option value="custom">Custom Date</option>
                            </select>
                        </div>
                    </div>
                    <div class="row" id="customDateRow" style="display:none;">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Custom Expiry Date</label>
                            <input type="date" class="form-control" id="exceptionCustomDate" min="">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Justification <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="exceptionJustification" rows="4" required
                                  placeholder="Explain why this exception is needed, what compensating controls are in place, and the plan to remediate..."></textarea>
                        <small class="text-muted">Minimum 50 characters required</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Compensating Controls</label>
                        <textarea class="form-control" id="exceptionCompensating" rows="2" 
                                  placeholder="Describe any compensating controls that mitigate the risk..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitExceptionRequest()">
                    <i class="fas fa-paper-plane"></i> Submit Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Approve/Reject Exception Modal -->
<div class="modal fade" id="reviewExceptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Review Exception Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reviewExceptionId">
                <div id="exceptionDetails">
                    <!-- Loaded dynamically -->
                </div>
                <hr>
                <div class="mb-3">
                    <label class="form-label">Review Comments</label>
                    <textarea class="form-control" id="reviewComments" rows="3" 
                              placeholder="Add your review comments..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="rejectException()">
                    <i class="fas fa-times"></i> Reject
                </button>
                <button type="button" class="btn btn-success" onclick="approveException()">
                    <i class="fas fa-check"></i> Approve
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    async function loadExceptionData() {
        try {
            const response = await fetch('/api/workflows/exceptions');
            if (!response.ok) throw new Error('Failed to load exceptions');
            
            const data = await response.json();
            
            // Update KPI cards
            document.getElementById('pendingReviewCount').textContent = data.stats?.pendingReview || 0;
            document.getElementById('approvedCount').textContent = data.stats?.approved || 0;
            document.getElementById('expiringSoonCount').textContent = data.stats?.expiringSoon || 0;
            document.getElementById('expiredCount').textContent = data.stats?.expired || 0;
            
            // Update table
            const tbody = document.getElementById('exceptionsTableBody');
            const filter = document.getElementById('exceptionFilter').value;
            let exceptions = data.exceptions || [];
            
            if (filter) {
                exceptions = exceptions.filter(e => e.status === filter);
            }
            
            if (exceptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No exceptions found</td></tr>';
            } else {
                tbody.innerHTML = exceptions.map(e => `
                    <tr>
                        <td><a href="/WorkflowUI/ExceptionDetail/${e.id}">${e.exceptionId}</a></td>
                        <td><code>${e.controlId}</code></td>
                        <td>${e.requestedBy}</td>
                        <td>${formatDate(e.expiryDate)}</td>
                        <td>${getStatusBadge(e.status)}</td>
                        <td>${getRiskBadge(e.riskLevel)}</td>
                        <td>
                            ${e.status === 'Pending' ? `
                                <button class="btn btn-sm btn-success me-1" onclick="showReviewModal('${e.id}')" title="Review">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                            ` : ''}
                            <a href="/WorkflowUI/ExceptionDetail/${e.id}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                `).join('');
            }
            
        } catch (error) {
            console.error('Error loading exception data:', error);
            document.getElementById('exceptionsTableBody').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">Error loading data</td></tr>';
        }
    }
    
    function getStatusBadge(status) {
        const badges = {
            'Pending': 'bg-warning',
            'Submitted': 'bg-warning',
            'Approved': 'bg-success',
            'Rejected': 'bg-danger',
            'Expired': 'bg-secondary'
        };
        return `<span class="badge ${badges[status] || 'bg-secondary'}">${status}</span>`;
    }
    
    function getRiskBadge(risk) {
        const badges = {
            'Critical': 'bg-danger',
            'High': 'bg-warning text-dark',
            'Medium': 'bg-info',
            'Low': 'bg-success'
        };
        return `<span class="badge ${badges[risk] || 'bg-secondary'}">${risk}</span>`;
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function calculateExpiryDate() {
        const duration = document.getElementById('exceptionDuration').value;
        const customRow = document.getElementById('customDateRow');
        const customDateInput = document.getElementById('exceptionCustomDate');
        
        if (duration === 'custom') {
            customRow.style.display = 'block';
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            customDateInput.min = tomorrow.toISOString().split('T')[0];
        } else {
            customRow.style.display = 'none';
        }
    }
    
    async function submitExceptionRequest() {
        const controlId = document.getElementById('exceptionControlId').value;
        const controlTitle = document.getElementById('exceptionControlTitle').value;
        const riskLevel = document.getElementById('exceptionRiskLevel').value;
        const duration = document.getElementById('exceptionDuration').value;
        const justification = document.getElementById('exceptionJustification').value;
        
        // Validation
        if (!controlId || !riskLevel || !duration || !justification) {
            alert('Please fill all required fields');
            return;
        }
        
        if (justification.length < 50) {
            alert('Justification must be at least 50 characters');
            return;
        }
        
        // Calculate expiry date
        let expiryDate;
        if (duration === 'custom') {
            expiryDate = document.getElementById('exceptionCustomDate').value;
            if (!expiryDate) {
                alert('Please select a custom expiry date');
                return;
            }
        } else {
            const days = parseInt(duration);
            const date = new Date();
            date.setDate(date.getDate() + days);
            expiryDate = date.toISOString();
        }
        
        try {
            const response = await fetch('/api/workflows/exceptions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    controlId: controlId || null,
                    controlTitle,
                    riskLevel,
                    justification,
                    expiryDate
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                bootstrap.Modal.getInstance(document.getElementById('newExceptionModal')).hide();
                document.getElementById('newExceptionForm').reset();
                loadExceptionData();
                alert(`Exception request ${result.exceptionNumber} submitted successfully`);
            } else {
                const error = await response.json();
                alert(error.error || 'Error submitting exception request');
            }
        } catch (error) {
            console.error('Error submitting exception:', error);
            alert('Error submitting exception request');
        }
    }
    
    function showReviewModal(exceptionId) {
        document.getElementById('reviewExceptionId').value = exceptionId;
        document.getElementById('reviewComments').value = '';
        new bootstrap.Modal(document.getElementById('reviewExceptionModal')).show();
    }
    
    async function approveException() {
        const exceptionId = document.getElementById('reviewExceptionId').value;
        
        try {
            const response = await fetch(`/api/workflows/exceptions/${exceptionId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('reviewExceptionModal')).hide();
                loadExceptionData();
                alert('Exception approved');
            }
        } catch (error) {
            console.error('Error approving exception:', error);
        }
    }
    
    async function rejectException() {
        const exceptionId = document.getElementById('reviewExceptionId').value;
        const reason = document.getElementById('reviewComments').value;
        
        try {
            const response = await fetch(`/api/workflows/exceptions/${exceptionId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason })
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('reviewExceptionModal')).hide();
                loadExceptionData();
                alert('Exception rejected');
            }
        } catch (error) {
            console.error('Error rejecting exception:', error);
        }
    }
    
    // Load controls for dropdown
    async function loadControlsForDropdown() {
        try {
            const response = await fetch('/api/seed/controls?pageSize=100');
            const data = await response.json();
            
            const select = document.getElementById('exceptionControlId');
            (data.controls || []).forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = `${c.controlNumber} - ${c.title?.substring(0, 50)}`;
                option.dataset.title = c.title;
                select.appendChild(option);
            });
            
            select.addEventListener('change', function() {
                const selected = this.options[this.selectedIndex];
                document.getElementById('exceptionControlTitle').value = selected.dataset.title || '';
            });
        } catch (error) {
            console.error('Error loading controls:', error);
        }
    }
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadExceptionData();
        loadControlsForDropdown();
    });
</script>
}
