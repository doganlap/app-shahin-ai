@{
    ViewData["Title"] = "Edit Control - Shahin MAP";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var controlId = ViewBag.ControlId ?? Guid.Empty;
}

<div class="container-fluid mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard")">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Controls")">Controls</a></li>
            <li class="breadcrumb-item active">Edit Control</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3">
                <i class="fas fa-edit text-warning me-2"></i>
                Edit Control
            </h1>
            <p class="text-muted">Modify control details and requirements</p>
        </div>
    </div>

    <form asp-action="Edit" method="post" id="editControlForm">
        <input type="hidden" name="Id" value="@controlId" />

        <div class="row">
            <!-- Main Form -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><span class="text-danger">*</span> Control Number</label>
                                <input type="text" class="form-control" name="ControlNumber" id="ControlNumber" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><span class="text-danger">*</span> Framework</label>
                                <select class="form-select" name="FrameworkCode" id="FrameworkCode" required>
                                    <option value="">-- Select Framework --</option>
                                    <option value="NCA-ECC">NCA ECC 2:2024</option>
                                    <option value="SAMA-CSF">SAMA CSF</option>
                                    <option value="PDPL">PDPL</option>
                                    <option value="NCA-CSCC">NCA CSCC</option>
                                    <option value="ISO27001">ISO 27001</option>
                                    <option value="CUSTOM">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><span class="text-danger">*</span> Domain</label>
                                <select class="form-select" name="Domain" id="Domain" required>
                                    <option value="">-- Select Domain --</option>
                                    <option value="GOV">Governance</option>
                                    <option value="DEF">Defense</option>
                                    <option value="RES">Resilience</option>
                                    <option value="TP">Third Party</option>
                                    <option value="IC">Industrial Control</option>
                                    <option value="DATA">Data Protection</option>
                                    <option value="ACCESS">Access Control</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Control Type</label>
                                <select class="form-select" name="ControlType" id="ControlType">
                                    <option value="Preventive">Preventive</option>
                                    <option value="Detective">Detective</option>
                                    <option value="Corrective">Corrective</option>
                                    <option value="Compensating">Compensating</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control Details -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Control Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label"><span class="text-danger">*</span> Title (English)</label>
                            <input type="text" class="form-control" name="TitleEn" id="TitleEn" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Title (Arabic)</label>
                            <input type="text" class="form-control" name="TitleAr" id="TitleAr" dir="rtl">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><span class="text-danger">*</span> Requirement (English)</label>
                            <textarea class="form-control" name="RequirementEn" id="RequirementEn" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Requirement (Arabic)</label>
                            <textarea class="form-control" name="RequirementAr" id="RequirementAr" rows="4" dir="rtl"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Implementation Guidance -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-book me-2"></i>Implementation Guidance</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Implementation Guidance</label>
                            <textarea class="form-control" name="ImplementationGuidanceEn" id="ImplementationGuidanceEn" rows="4"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Evidence Requirements</label>
                            <textarea class="form-control" name="EvidenceRequirements" id="EvidenceRequirements" rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Mappings -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-link me-2"></i>Framework Mappings</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ISO 27001 Mapping</label>
                            <input type="text" class="form-control" name="MappingIso27001" id="MappingIso27001">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">NIST CSF Mapping</label>
                            <input type="text" class="form-control" name="MappingNist" id="MappingNist">
                        </div>
                    </div>
                </div>

                <!-- Maturity -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-layer-group me-2"></i>Maturity Level</h6>
                    </div>
                    <div class="card-body">
                        <select class="form-select" name="MaturityLevel" id="MaturityLevel">
                            <option value="1">Level 1 - Initial</option>
                            <option value="2">Level 2 - Managed</option>
                            <option value="3">Level 3 - Defined</option>
                            <option value="4">Level 4 - Quantitatively Managed</option>
                            <option value="5">Level 5 - Optimizing</option>
                        </select>
                    </div>
                </div>

                <!-- Status -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Status</h6>
                    </div>
                    <div class="card-body">
                        <select class="form-select" name="Status" id="Status">
                            <option value="Active">Active</option>
                            <option value="Draft">Draft</option>
                            <option value="Deprecated">Deprecated</option>
                            <option value="Retired">Retired</option>
                        </select>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <button type="submit" class="btn btn-warning w-100 mb-2">
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                        <a href="@Url.Action("Details", "Controls", new { id = controlId })" class="btn btn-outline-primary w-100 mb-2">
                            <i class="fas fa-eye me-2"></i>View Details
                        </a>
                        <a href="@Url.Action("Index", "Controls")" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
<script>
    $(document).ready(function() {
        loadControlData();

        $('#editControlForm').on('submit', function(e) {
            e.preventDefault();

            var formData = $(this).serialize();

            $.post('@Url.Action("Edit", "Controls")', formData)
                .done(function(response) {
                    if (response.success) {
                        window.location.href = '@Url.Action("Details", "Controls", new { id = controlId })';
                    } else {
                        alert(response.message || 'Error saving changes');
                    }
                })
                .fail(function() {
                    alert('Error saving changes. Please try again.');
                });
        });
    });

    function loadControlData() {
        var controlId = '@controlId';
        if (!controlId || controlId === '00000000-0000-0000-0000-000000000000') {
            return;
        }

        $.get('/api/controls/' + controlId)
            .done(function(data) {
                populateForm(data);
            })
            .fail(function() {
                alert('Failed to load control data');
            });
    }

    function populateForm(data) {
        $('#ControlNumber').val(data.controlNumber);
        $('#FrameworkCode').val(data.frameworkCode);
        $('#Domain').val(data.domain);
        $('#ControlType').val(data.controlType);
        $('#TitleEn').val(data.titleEn);
        $('#TitleAr').val(data.titleAr);
        $('#RequirementEn').val(data.requirementEn);
        $('#RequirementAr').val(data.requirementAr);
        $('#ImplementationGuidanceEn').val(data.implementationGuidanceEn);
        $('#EvidenceRequirements').val(data.evidenceRequirements);
        $('#MappingIso27001').val(data.mappingIso27001);
        $('#MappingNist').val(data.mappingNist);
        $('#MaturityLevel').val(data.maturityLevel || '3');
        $('#Status').val(data.status || 'Active');
    }
</script>
}
