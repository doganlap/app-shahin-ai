@using GrcMvc.Services.Interfaces
@model MigrationStatistics
@{
    ViewData["Title"] = "Migration Metrics";
    var days = ViewData["Days"] as int? ?? 7;
}

<div class="container-fluid py-4">
    <h1>Architecture Migration Metrics</h1>
    <p class="text-muted">Monitoring progress from legacy services to enhanced implementation</p>
    
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <h5 class="card-title">Total Calls</h5>
                    <h2 class="text-primary">@Model.TotalCalls</h2>
                    <small class="text-muted">Last @days days</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <h5 class="card-title">Enhanced Usage</h5>
                    <h2 class="text-success">@Model.EnhancedCalls (@((Model.TotalCalls > 0 ? (Model.EnhancedCalls / (double)Model.TotalCalls * 100) : 0).ToString("F1"))%)</h2>
                    <small class="text-muted">Success Rate: @Model.EnhancedSuccessRate.ToString("F1")%</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <h5 class="card-title">Legacy Usage</h5>
                    <h2 class="text-warning">@Model.LegacyCalls (@((Model.TotalCalls > 0 ? (Model.LegacyCalls / (double)Model.TotalCalls * 100) : 0).ToString("F1"))%)</h2>
                    <small class="text-muted">Success Rate: @Model.LegacySuccessRate.ToString("F1")%</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body">
                    <h5 class="card-title">Consistency Checks</h5>
                    <h2 class="text-info">@Model.ConsistencyChecks</h2>
                    <small class="text-@(Model.ConsistencyFailures > 0 ? "danger" : "success")">
                        Failures: @Model.ConsistencyFailures
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Performance Comparison</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Implementation</th>
                                <th>Avg Duration (ms)</th>
                                <th>Calls</th>
                                <th>Success Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="badge bg-success">Enhanced</span></td>
                                <td>@Model.EnhancedAverageDurationMs.ToString("F2")</td>
                                <td>@Model.EnhancedCalls</td>
                                <td>@Model.EnhancedSuccessRate.ToString("F1")%</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-warning">Legacy</span></td>
                                <td>@Model.LegacyAverageDurationMs.ToString("F2")</td>
                                <td>@Model.LegacyCalls</td>
                                <td>@Model.LegacySuccessRate.ToString("F1")%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Calls by Method</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Method</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var kvp in Model.CallsByMethod.OrderByDescending(x => x.Value).Take(10))
                            {
                                <tr>
                                    <td>@kvp.Key</td>
                                    <td>@kvp.Value</td>
                                </tr>
                            }
                            @if (!Model.CallsByMethod.Any())
                            {
                                <tr>
                                    <td colspan="2" class="text-center text-muted">No data yet</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Migration Status</h5>
                </div>
                <div class="card-body">
                    @{
                        var enhancedPercentage = Model.TotalCalls > 0 ? (Model.EnhancedCalls / (double)Model.TotalCalls * 100) : 0;
                        var statusColor = enhancedPercentage switch
                        {
                            >= 90 => "success",
                            >= 50 => "info",
                            >= 10 => "warning",
                            _ => "secondary"
                        };
                        var statusText = enhancedPercentage switch
                        {
                            >= 90 => "Near Complete",
                            >= 50 => "In Progress",
                            >= 10 => "Canary Testing",
                            _ => "Legacy Mode"
                        };
                    }
                    
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-@statusColor" role="progressbar" 
                             style="width: @enhancedPercentage.ToString("F1")%"
                             aria-valuenow="@enhancedPercentage" aria-valuemin="0" aria-valuemax="100">
                            @enhancedPercentage.ToString("F1")% Enhanced
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <strong>Status:</strong> <span class="badge bg-@statusColor">@statusText</span>
                        <br/>
                        <small class="text-muted">
                            @if (enhancedPercentage < 10)
                            {
                                <text>System is using legacy code. Enable feature flags to start migration.</text>
                            }
                            else if (enhancedPercentage < 50)
                            {
                                <text>Canary deployment in progress. Monitor metrics before increasing percentage.</text>
                            }
                            else if (enhancedPercentage < 90)
                            {
                                <text>Migration is progressing well. Continue monitoring before full rollout.</text>
                            }
                            else
                            {
                                <text>Migration nearly complete! Ready for legacy code cleanup.</text>
                            }
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-4">
        <a href="?days=1" class="btn btn-sm btn-outline-primary">Last 24h</a>
        <a href="?days=7" class="btn btn-sm btn-outline-primary">Last 7 days</a>
        <a href="?days=30" class="btn btn-sm btn-outline-primary">Last 30 days</a>
        <a href="/platform-admin/v2/dashboard" class="btn btn-sm btn-outline-secondary">Back to V2 Dashboard</a>
    </div>
</div>

<script>
    // Auto-refresh metrics every 30 seconds
    setInterval(() => {
        fetch('/platform-admin/migration-metrics/api/stats?days=@days')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // In production, update the UI dynamically instead of full page reload
                    location.reload();
                }
            })
            .catch(err => console.error('Failed to refresh metrics:', err));
    }, 30000);
</script>
