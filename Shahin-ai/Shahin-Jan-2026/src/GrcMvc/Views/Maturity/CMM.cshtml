@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<SharedResource> L
@model GrcMvc.Services.Interfaces.GrcMaturityScoreDto
@{
    ViewData["Title"] = "Capability Maturity Model (CMM)";
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-bar-chart-steps"></i> Capability Maturity Model (CMM)</h2>
            <p class="text-muted">Visualize GRC maturity progression across the 5-level CMM framework</p>
        </div>
        <div class="col text-end">
            <a asp-action="Dimensions" class="btn btn-outline-secondary">
                <i class="bi bi-grid-3x3-gap"></i> Dimensions View
            </a>
            <a asp-action="Roadmap" class="btn btn-outline-primary">
                <i class="bi bi-map"></i> Improvement Roadmap
            </a>
        </div>
    </div>

    <!-- CMM Level Description -->
    @{
        var overallScore = (Model.ProcessMaturity + Model.PeopleMaturity + Model.TechnologyMaturity + Model.GovernanceMaturity + Model.CultureMaturity) / 5.0m;
        var currentLevel = overallScore >= 4.5m ? 5 : overallScore >= 3.5m ? 4 : overallScore >= 2.5m ? 3 : overallScore >= 1.5m ? 2 : 1;
    }

    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-primary d-flex align-items-center">
                <div class="flex-grow-1">
                    <h4 class="mb-1"><i class="bi bi-trophy"></i> Current Maturity Level: <strong>Level @currentLevel</strong></h4>
                    <p class="mb-0">@GetLevelDescription(currentLevel)</p>
                </div>
                <div class="text-end">
                    <h1 class="display-3 mb-0">@overallScore.ToString("F2")</h1>
                    <small class="text-muted">Overall Score</small>
                </div>
            </div>
        </div>
    </div>

    <!-- CMM Levels Visualization -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-ladder"></i> CMM Levels Progression</h5>
                </div>
                <div class="card-body">
                    <!-- Level 5 - Optimizing -->
                    <div class="row mb-3 @(currentLevel >= 5 ? "border border-success border-3 rounded p-2" : "")">
                        <div class="col-md-2 text-center">
                            <div class="badge @(currentLevel >= 5 ? "bg-success" : "bg-secondary") py-2 px-3" style="font-size: 1.2rem;">
                                Level 5
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h5 class="@(currentLevel >= 5 ? "text-success" : "")">
                                <i class="bi bi-star-fill"></i> Optimizing
                            </h5>
                            <p class="small text-muted mb-0">Continuous improvement culture</p>
                        </div>
                        <div class="col-md-7">
                            <ul class="small mb-0">
                                <li>Proactive risk identification using advanced analytics</li>
                                <li>Continuous process optimization and innovation</li>
                                <li>Predictive compliance monitoring</li>
                                <li>Industry leadership in GRC practices</li>
                            </ul>
                            @if (currentLevel >= 5)
                            {
                                <span class="badge bg-success mt-2"><i class="bi bi-check-circle"></i> You are here!</span>
                            }
                        </div>
                    </div>

                    <!-- Level 4 - Managed -->
                    <div class="row mb-3 @(currentLevel == 4 ? "border border-info border-3 rounded p-2" : "")">
                        <div class="col-md-2 text-center">
                            <div class="badge @(currentLevel >= 4 ? "bg-info" : "bg-secondary") py-2 px-3" style="font-size: 1.2rem;">
                                Level 4
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h5 class="@(currentLevel >= 4 ? "text-info" : "")">
                                <i class="bi bi-graph-up"></i> Managed
                            </h5>
                            <p class="small text-muted mb-0">Quantitatively managed processes</p>
                        </div>
                        <div class="col-md-7">
                            <ul class="small mb-0">
                                <li>Metrics-driven GRC management</li>
                                <li>Real-time monitoring and dashboards</li>
                                <li>Process performance baselines established</li>
                                <li>Data-driven decision making</li>
                            </ul>
                            @if (currentLevel == 4)
                            {
                                <span class="badge bg-info mt-2"><i class="bi bi-check-circle"></i> You are here!</span>
                            }
                        </div>
                    </div>

                    <!-- Level 3 - Defined -->
                    <div class="row mb-3 @(currentLevel == 3 ? "border border-primary border-3 rounded p-2" : "")">
                        <div class="col-md-2 text-center">
                            <div class="badge @(currentLevel >= 3 ? "bg-primary" : "bg-secondary") py-2 px-3" style="font-size: 1.2rem;">
                                Level 3
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h5 class="@(currentLevel >= 3 ? "text-primary" : "")">
                                <i class="bi bi-file-earmark-text"></i> Defined
                            </h5>
                            <p class="small text-muted mb-0">Standardized processes</p>
                        </div>
                        <div class="col-md-7">
                            <ul class="small mb-0">
                                <li>Documented and standardized GRC processes</li>
                                <li>Organization-wide framework adoption</li>
                                <li>Integrated GRC activities across departments</li>
                                <li>Training and awareness programs established</li>
                            </ul>
                            @if (currentLevel == 3)
                            {
                                <span class="badge bg-primary mt-2"><i class="bi bi-check-circle"></i> You are here!</span>
                            }
                        </div>
                    </div>

                    <!-- Level 2 - Repeatable -->
                    <div class="row mb-3 @(currentLevel == 2 ? "border border-warning border-3 rounded p-2" : "")">
                        <div class="col-md-2 text-center">
                            <div class="badge @(currentLevel >= 2 ? "bg-warning text-dark" : "bg-secondary") py-2 px-3" style="font-size: 1.2rem;">
                                Level 2
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h5 class="@(currentLevel >= 2 ? "text-warning" : "")">
                                <i class="bi bi-arrow-repeat"></i> Repeatable
                            </h5>
                            <p class="small text-muted mb-0">Basic project management</p>
                        </div>
                        <div class="col-md-7">
                            <ul class="small mb-0">
                                <li>Basic GRC processes exist but not standardized</li>
                                <li>Reactive risk and compliance management</li>
                                <li>Success depends on individual efforts</li>
                                <li>Some documentation and tracking in place</li>
                            </ul>
                            @if (currentLevel == 2)
                            {
                                <span class="badge bg-warning text-dark mt-2"><i class="bi bi-check-circle"></i> You are here!</span>
                            }
                        </div>
                    </div>

                    <!-- Level 1 - Initial -->
                    <div class="row @(currentLevel == 1 ? "border border-danger border-3 rounded p-2" : "")">
                        <div class="col-md-2 text-center">
                            <div class="badge @(currentLevel >= 1 ? "bg-danger" : "bg-secondary") py-2 px-3" style="font-size: 1.2rem;">
                                Level 1
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h5 class="@(currentLevel >= 1 ? "text-danger" : "")">
                                <i class="bi bi-exclamation-triangle"></i> Initial
                            </h5>
                            <p class="small text-muted mb-0">Ad-hoc and chaotic</p>
                        </div>
                        <div class="col-md-7">
                            <ul class="small mb-0">
                                <li>No formal GRC processes</li>
                                <li>Reactive, firefighting approach</li>
                                <li>Unpredictable outcomes</li>
                                <li>Success depends on heroic individual efforts</li>
                            </ul>
                            @if (currentLevel == 1)
                            {
                                <span class="badge bg-danger mt-2"><i class="bi bi-check-circle"></i> You are here!</span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dimension Breakdown by CMM Level -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-grid"></i> Dimension Scores by CMM Level</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center">
                            <thead class="table-light">
                                <tr>
                                    <th>Dimension</th>
                                    <th>Current Score</th>
                                    <th>Level 1<br/>(0-1.5)</th>
                                    <th>Level 2<br/>(1.5-2.5)</th>
                                    <th>Level 3<br/>(2.5-3.5)</th>
                                    <th>Level 4<br/>(3.5-4.5)</th>
                                    <th>Level 5<br/>(4.5-5.0)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-start"><i class="bi bi-diagram-3 text-primary"></i> Process</td>
                                    <td><strong>@Model.ProcessMaturity.ToString("F2")</strong></td>
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var inRange = Model.ProcessMaturity >= (i - 1) * 1.0m + (i == 1 ? 0 : 0.5m) && Model.ProcessMaturity < i * 1.0m + (i == 5 ? 0.5m : 0.5m);
                                        <td class="@(inRange ? "bg-primary text-white" : "")">
                                            @if (inRange) { <i class="bi bi-check-circle"></i> }
                                        </td>
                                    }
                                </tr>
                                <tr>
                                    <td class="text-start"><i class="bi bi-people text-success"></i> People</td>
                                    <td><strong>@Model.PeopleMaturity.ToString("F2")</strong></td>
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var inRange = Model.PeopleMaturity >= (i - 1) * 1.0m + (i == 1 ? 0 : 0.5m) && Model.PeopleMaturity < i * 1.0m + (i == 5 ? 0.5m : 0.5m);
                                        <td class="@(inRange ? "bg-success text-white" : "")">
                                            @if (inRange) { <i class="bi bi-check-circle"></i> }
                                        </td>
                                    }
                                </tr>
                                <tr>
                                    <td class="text-start"><i class="bi bi-cpu text-info"></i> Technology</td>
                                    <td><strong>@Model.TechnologyMaturity.ToString("F2")</strong></td>
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var inRange = Model.TechnologyMaturity >= (i - 1) * 1.0m + (i == 1 ? 0 : 0.5m) && Model.TechnologyMaturity < i * 1.0m + (i == 5 ? 0.5m : 0.5m);
                                        <td class="@(inRange ? "bg-info text-white" : "")">
                                            @if (inRange) { <i class="bi bi-check-circle"></i> }
                                        </td>
                                    }
                                </tr>
                                <tr>
                                    <td class="text-start"><i class="bi bi-shield-check text-warning"></i> Governance</td>
                                    <td><strong>@Model.GovernanceMaturity.ToString("F2")</strong></td>
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var inRange = Model.GovernanceMaturity >= (i - 1) * 1.0m + (i == 1 ? 0 : 0.5m) && Model.GovernanceMaturity < i * 1.0m + (i == 5 ? 0.5m : 0.5m);
                                        <td class="@(inRange ? "bg-warning text-dark" : "")">
                                            @if (inRange) { <i class="bi bi-check-circle"></i> }
                                        </td>
                                    }
                                </tr>
                                <tr>
                                    <td class="text-start"><i class="bi bi-heart text-danger"></i> Culture</td>
                                    <td><strong>@Model.CultureMaturity.ToString("F2")</strong></td>
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var inRange = Model.CultureMaturity >= (i - 1) * 1.0m + (i == 1 ? 0 : 0.5m) && Model.CultureMaturity < i * 1.0m + (i == 5 ? 0.5m : 0.5m);
                                        <td class="@(inRange ? "bg-danger text-white" : "")">
                                            @if (inRange) { <i class="bi bi-check-circle"></i> }
                                        </td>
                                    }
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Dimension Comparison</h6>
                </div>
                <div class="card-body">
                    <canvas id="dimensionChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-pie-chart"></i> Maturity Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Dimension Comparison Chart
        const dimCtx = document.getElementById('dimensionChart').getContext('2d');
        new Chart(dimCtx, {
            type: 'bar',
            data: {
                labels: ['Process', 'People', 'Technology', 'Governance', 'Culture'],
                datasets: [{
                    label: 'Maturity Score',
                    data: [
                        @Model.ProcessMaturity,
                        @Model.PeopleMaturity,
                        @Model.TechnologyMaturity,
                        @Model.GovernanceMaturity,
                        @Model.CultureMaturity
                    ],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(255, 99, 132, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 5
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // Distribution Chart
        const distCtx = document.getElementById('distributionChart').getContext('2d');
        new Chart(distCtx, {
            type: 'doughnut',
            data: {
                labels: ['Process', 'People', 'Technology', 'Governance', 'Culture'],
                datasets: [{
                    data: [
                        @Model.ProcessMaturity,
                        @Model.PeopleMaturity,
                        @Model.TechnologyMaturity,
                        @Model.GovernanceMaturity,
                        @Model.CultureMaturity
                    ],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(255, 99, 132, 0.7)'
                    ]
                }]
            },
            options: {
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    </script>
}

@functions {
    private string GetLevelDescription(int level)
    {
        return level switch
        {
            5 => "Your organization has achieved optimizing maturity with continuous improvement and innovation in GRC practices.",
            4 => "Your organization manages GRC quantitatively with metrics-driven processes and real-time monitoring.",
            3 => "Your organization has defined and standardized GRC processes across the enterprise.",
            2 => "Your organization has repeatable GRC processes but they are not yet standardized organization-wide.",
            _ => "Your organization's GRC processes are ad-hoc and unpredictable. Focus on establishing basic processes."
        };
    }
}
