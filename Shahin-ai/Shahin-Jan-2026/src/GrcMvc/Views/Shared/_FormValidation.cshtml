@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<SharedResource> L

<style>
/* Enhanced form validation styles */
.form-control.is-invalid,
.form-select.is-invalid {
    border-color: var(--bs-danger);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1rem;
    padding-right: 2.5rem;
}

.form-control.is-valid,
.form-select.is-valid {
    border-color: var(--bs-success);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1rem;
    padding-right: 2.5rem;
}

.invalid-feedback {
    display: none;
    font-size: 0.875rem;
    color: var(--bs-danger);
    margin-top: 0.25rem;
}

.form-control.is-invalid ~ .invalid-feedback,
.form-select.is-invalid ~ .invalid-feedback,
.was-validated .form-control:invalid ~ .invalid-feedback,
.was-validated .form-select:invalid ~ .invalid-feedback {
    display: block;
}

/* Field guidance tooltip */
.field-hint {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.field-hint i {
    margin-right: 0.25rem;
}

/* Required field indicator */
.required-field::after {
    content: " *";
    color: var(--bs-danger);
}

/* Character counter */
.char-counter {
    font-size: 0.75rem;
    color: #6c757d;
    text-align: right;
    margin-top: 0.25rem;
}

.char-counter.warning {
    color: var(--bs-warning);
}

.char-counter.danger {
    color: var(--bs-danger);
}

/* Password strength indicator */
.password-strength {
    height: 4px;
    border-radius: 2px;
    margin-top: 0.5rem;
    background: #e9ecef;
    overflow: hidden;
}

.password-strength-bar {
    height: 100%;
    transition: width 0.3s, background-color 0.3s;
}

.password-strength.weak .password-strength-bar { width: 25%; background: var(--bs-danger); }
.password-strength.fair .password-strength-bar { width: 50%; background: var(--bs-warning); }
.password-strength.good .password-strength-bar { width: 75%; background: var(--bs-info); }
.password-strength.strong .password-strength-bar { width: 100%; background: var(--bs-success); }

/* Form section styling */
.form-section {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.form-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--bs-primary);
}

/* Inline validation messages */
.validation-summary-errors {
    padding: 1rem;
    margin-bottom: 1.5rem;
    background: #fff5f5;
    border: 1px solid #feb2b2;
    border-radius: 0.5rem;
}

.validation-summary-errors ul {
    margin: 0;
    padding-left: 1.5rem;
}

.validation-summary-errors li {
    color: var(--bs-danger);
    margin-bottom: 0.25rem;
}
</style>

<script>
// Form Validation Helper
window.GrcFormValidation = {
    messages: {
        required: '@Html.Raw(L["Validation_Required"].Value)',
        email: '@Html.Raw(L["Validation_InvalidEmail"].Value)',
        phone: '@Html.Raw(L["Validation_InvalidPhone"].Value)',
        minLength: '@Html.Raw(L["Validation_MinLength"].Value)',
        maxLength: '@Html.Raw(L["Validation_MaxLength"].Value)',
        passwordMismatch: '@Html.Raw(L["Validation_PasswordMismatch"].Value)',
        invalidFormat: '@Html.Raw(L["Validation_InvalidFormat"].Value)'
    },

    // Initialize validation on a form
    init: function(formSelector) {
        const form = document.querySelector(formSelector);
        if (!form) return;

        // Add required field indicators
        form.querySelectorAll('[required]').forEach(field => {
            const label = form.querySelector(`label[for="${field.id}"]`);
            if (label && !label.classList.contains('required-field')) {
                label.classList.add('required-field');
            }
        });

        // Real-time validation
        form.querySelectorAll('input, textarea, select').forEach(field => {
            field.addEventListener('blur', () => this.validateField(field));
            field.addEventListener('input', () => {
                // Remove invalid state on input
                if (field.classList.contains('is-invalid')) {
                    this.validateField(field);
                }
            });
        });

        // Character counters
        form.querySelectorAll('[data-max-length]').forEach(field => {
            this.addCharCounter(field);
        });

        // Password strength
        form.querySelectorAll('input[type="password"][data-strength]').forEach(field => {
            this.addPasswordStrength(field);
        });

        // Form submission validation
        form.addEventListener('submit', (e) => {
            if (!this.validateForm(form)) {
                e.preventDefault();
                e.stopPropagation();
                
                // Focus first invalid field
                const firstInvalid = form.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            form.classList.add('was-validated');
        });
    },

    validateField: function(field) {
        let isValid = true;
        let message = '';

        // Required
        if (field.hasAttribute('required') && !field.value.trim()) {
            isValid = false;
            message = this.messages.required;
        }
        // Email
        else if (field.type === 'email' && field.value && !this.isValidEmail(field.value)) {
            isValid = false;
            message = this.messages.email;
        }
        // Phone
        else if (field.type === 'tel' && field.value && !this.isValidPhone(field.value)) {
            isValid = false;
            message = this.messages.phone;
        }
        // Min length
        else if (field.minLength > 0 && field.value.length < field.minLength) {
            isValid = false;
            message = this.messages.minLength.replace('{0}', field.minLength);
        }
        // Max length
        else if (field.maxLength > 0 && field.value.length > field.maxLength) {
            isValid = false;
            message = this.messages.maxLength.replace('{0}', field.maxLength);
        }
        // Pattern
        else if (field.pattern && field.value && !new RegExp(field.pattern).test(field.value)) {
            isValid = false;
            message = field.title || this.messages.invalidFormat;
        }
        // Password confirmation
        else if (field.dataset.confirm) {
            const originalField = document.querySelector(field.dataset.confirm);
            if (originalField && field.value !== originalField.value) {
                isValid = false;
                message = this.messages.passwordMismatch;
            }
        }

        // Update UI
        field.classList.toggle('is-invalid', !isValid);
        field.classList.toggle('is-valid', isValid && field.value);

        // Update feedback message
        let feedback = field.nextElementSibling;
        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
            feedback = document.createElement('div');
            feedback.classList.add('invalid-feedback');
            field.parentNode.insertBefore(feedback, field.nextSibling);
        }
        feedback.textContent = message;

        return isValid;
    },

    validateForm: function(form) {
        let isValid = true;
        form.querySelectorAll('input, textarea, select').forEach(field => {
            if (!this.validateField(field)) {
                isValid = false;
            }
        });
        return isValid;
    },

    addCharCounter: function(field) {
        const maxLength = parseInt(field.dataset.maxLength);
        const counter = document.createElement('div');
        counter.className = 'char-counter';
        field.parentNode.appendChild(counter);

        const updateCounter = () => {
            const remaining = maxLength - field.value.length;
            counter.textContent = `${field.value.length} / ${maxLength}`;
            counter.classList.toggle('warning', remaining < maxLength * 0.2);
            counter.classList.toggle('danger', remaining < maxLength * 0.1);
        };

        field.addEventListener('input', updateCounter);
        updateCounter();
    },

    addPasswordStrength: function(field) {
        const container = document.createElement('div');
        container.className = 'password-strength';
        container.innerHTML = '<div class="password-strength-bar"></div>';
        field.parentNode.appendChild(container);

        const updateStrength = () => {
            const strength = this.getPasswordStrength(field.value);
            container.className = 'password-strength ' + strength;
        };

        field.addEventListener('input', updateStrength);
    },

    getPasswordStrength: function(password) {
        if (!password) return '';
        let score = 0;
        if (password.length >= 8) score++;
        if (password.length >= 12) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/[a-z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[^A-Za-z0-9]/.test(password)) score++;

        if (score <= 2) return 'weak';
        if (score <= 3) return 'fair';
        if (score <= 4) return 'good';
        return 'strong';
    },

    isValidEmail: function(email) {
        return /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/.test(email);
    },

    isValidPhone: function(phone) {
        return /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/.test(phone);
    }
};

// Auto-initialize forms with data-validate attribute
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('form[data-validate]').forEach(form => {
        GrcFormValidation.init('#' + form.id);
    });
});
</script>
