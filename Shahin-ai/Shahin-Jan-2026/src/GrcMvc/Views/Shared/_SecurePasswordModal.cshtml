@*
    Secure Password Modal - One-time password display
    Used by V2 controllers to show generated passwords securely
    (Replaces insecure TempData password exposure)
*@
@using Microsoft.AspNetCore.Mvc.Localization
@using GrcMvc.Resources
@inject IHtmlLocalizer<SharedResource> L

@{
    var generatedPassword = ViewData["GeneratedPassword"] as string;
    var showModal = ViewData["ShowPasswordModal"] as bool? ?? false;
    var userName = ViewData["UserName"] as string ?? "User";
    var userEmail = ViewData["UserEmail"] as string ?? "";
}

@if (showModal && !string.IsNullOrEmpty(generatedPassword))
{
    <div class="modal fade show" id="securePasswordModal" tabindex="-1" aria-labelledby="securePasswordModalLabel" 
         style="display: block; background-color: rgba(0,0,0,0.5);" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="securePasswordModalLabel">
                        <i class="bi bi-shield-lock"></i> @L["Shared_Password_Generated"]
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>@L["Shared_Password_Important"]:</strong> @L["Shared_Password_OneTimeNotice"]
                    </div>

                    @if (!string.IsNullOrEmpty(userName) || !string.IsNullOrEmpty(userEmail))
                    {
                        <div class="mb-3">
                            <strong>@L["Shared_Password_User"]:</strong> @userName
                            @if (!string.IsNullOrEmpty(userEmail))
                            {
                                <br/><small class="text-muted">@userEmail</small>
                            }
                        </div>
                    }

                    <div class="input-group mb-3">
                        <input type="text" class="form-control font-monospace" id="generatedPasswordField"
                               value="@generatedPassword" readonly
                               style="font-size: 1.1rem; letter-spacing: 1px;">
                        <button class="btn btn-outline-primary" type="button" id="copyPasswordBtn"
                                onclick="copyPassword()">
                            <i class="bi bi-clipboard"></i> @L["Shared_Password_Copy"]
                        </button>
                    </div>

                    <div id="copySuccess" class="alert alert-success d-none">
                        <i class="bi bi-check-circle"></i> @L["Shared_Password_CopiedSuccess"]
                    </div>

                    <div class="small text-muted">
                        <i class="bi bi-info-circle"></i>
                        @L["Shared_Password_ChangeRequirement"]
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">
                        <i class="bi bi-x-lg"></i> @L["Close"]
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function copyPassword() {
            const passwordField = document.getElementById('generatedPasswordField');
            const copyBtn = document.getElementById('copyPasswordBtn');
            const copySuccess = document.getElementById('copySuccess');
            
            navigator.clipboard.writeText(passwordField.value).then(() => {
                copySuccess.classList.remove('d-none');
                copyBtn.innerHTML = '<i class="bi bi-check"></i> Copied!';
                copyBtn.classList.remove('btn-outline-primary');
                copyBtn.classList.add('btn-success');
                
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
                    copyBtn.classList.remove('btn-success');
                    copyBtn.classList.add('btn-outline-primary');
                }, 3000);
            }).catch(err => {
                passwordField.select();
                document.execCommand('copy');
                copySuccess.classList.remove('d-none');
            });
        }
        
        function closePasswordModal() {
            const modal = document.getElementById('securePasswordModal');
            const passwordField = document.getElementById('generatedPasswordField');
            
            if (passwordField) {
                passwordField.value = '********';
            }
            
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        let passwordCopied = false;
        document.getElementById('copyPasswordBtn')?.addEventListener('click', () => {
            passwordCopied = true;
        });
        
        window.addEventListener('beforeunload', (e) => {
            if (!passwordCopied && document.getElementById('securePasswordModal')?.style.display === 'block') {
                e.preventDefault();
                e.returnValue = 'You have not copied the password yet. Are you sure you want to leave?';
            }
        });
        
        setTimeout(() => {
            closePasswordModal();
            alert('Password modal closed for security. If you did not copy the password, you will need to reset it again.');
        }, 300000);
    </script>
}
