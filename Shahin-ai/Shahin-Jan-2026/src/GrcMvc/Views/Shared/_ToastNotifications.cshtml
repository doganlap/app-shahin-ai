@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<SharedResource> L

<!-- Toast Container -->
<div id="toast-container" aria-live="polite" aria-atomic="true" 
     class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
</div>

<!-- Toast Template -->
<template id="toast-template">
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
        <div class="toast-header">
            <i class="bi me-2 toast-icon"></i>
            <strong class="me-auto toast-title"></strong>
            <small class="text-muted toast-time">@L["Toast_Info"]</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</template>

<script>
// Toast Notification System
window.GrcToast = {
    container: null,
    template: null,

    init: function() {
        this.container = document.getElementById('toast-container');
        this.template = document.getElementById('toast-template');
    },

    show: function(type, title, message, duration = 5000) {
        if (!this.container || !this.template) {
            this.init();
        }

        const toastClone = this.template.content.cloneNode(true);
        const toast = toastClone.querySelector('.toast');
        const icon = toast.querySelector('.toast-icon');
        const titleEl = toast.querySelector('.toast-title');
        const body = toast.querySelector('.toast-body');
        const time = toast.querySelector('.toast-time');

        // Set content
        titleEl.textContent = title;
        body.textContent = message;
        time.textContent = '@L["Toast_Info"]';

        // Set type-specific styling
        switch(type) {
            case 'success':
                toast.classList.add('border-success');
                icon.classList.add('bi-check-circle-fill', 'text-success');
                break;
            case 'error':
                toast.classList.add('border-danger');
                icon.classList.add('bi-x-circle-fill', 'text-danger');
                break;
            case 'warning':
                toast.classList.add('border-warning');
                icon.classList.add('bi-exclamation-triangle-fill', 'text-warning');
                break;
            case 'info':
            default:
                toast.classList.add('border-info');
                icon.classList.add('bi-info-circle-fill', 'text-info');
                break;
        }

        // Set duration
        toast.setAttribute('data-bs-delay', duration);

        // Add to container
        this.container.appendChild(toast);

        // Initialize and show
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        // Remove from DOM after hidden
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });

        return bsToast;
    },

    success: function(message, title = '@L["Toast_Success"]') {
        return this.show('success', title, message);
    },

    error: function(message, title = '@L["Toast_Error"]') {
        return this.show('error', title, message, 8000);
    },

    warning: function(message, title = '@L["Toast_Warning"]') {
        return this.show('warning', title, message, 6000);
    },

    info: function(message, title = '@L["Toast_Info"]') {
        return this.show('info', title, message);
    }
};

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', function() {
    GrcToast.init();

    // Check for flash messages from server
    const flashSuccess = '@TempData["SuccessMessage"]';
    const flashError = '@TempData["ErrorMessage"]';
    const flashWarning = '@TempData["WarningMessage"]';
    const flashInfo = '@TempData["InfoMessage"]';

    if (flashSuccess && flashSuccess !== '') {
        GrcToast.success(flashSuccess);
    }
    if (flashError && flashError !== '') {
        GrcToast.error(flashError);
    }
    if (flashWarning && flashWarning !== '') {
        GrcToast.warning(flashWarning);
    }
    if (flashInfo && flashInfo !== '') {
        GrcToast.info(flashInfo);
    }
});

// Global AJAX error handler
$(document).ajaxError(function(event, jqXHR, settings, thrownError) {
    let message = '@L["Toast_OperationFailed"]';
    
    if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
        message = jqXHR.responseJSON.message;
    } else if (jqXHR.status === 401) {
        message = '@L["Error_401_Message"]';
    } else if (jqXHR.status === 403) {
        message = '@L["Error_403_Message"]';
    } else if (jqXHR.status === 404) {
        message = '@L["Error_404_Message"]';
    }

    GrcToast.error(message);
});

// Global fetch error interceptor
const originalFetch = window.fetch;
window.fetch = async function(...args) {
    try {
        const response = await originalFetch.apply(this, args);
        
        if (!response.ok && response.status >= 400) {
            // Clone response to read body
            const clonedResponse = response.clone();
            try {
                const errorData = await clonedResponse.json();
                if (errorData.message) {
                    GrcToast.error(errorData.message);
                }
            } catch {
                // Response is not JSON, show generic error
                if (response.status >= 500) {
                    GrcToast.error('@L["Toast_OperationFailed"]');
                }
            }
        }
        
        return response;
    } catch (error) {
        GrcToast.error('@L["Toast_OperationFailed"]');
        throw error;
    }
};
</script>

<style>
#toast-container .toast {
    min-width: 300px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
#toast-container .toast.border-success { border-left: 4px solid var(--bs-success) !important; }
#toast-container .toast.border-danger { border-left: 4px solid var(--bs-danger) !important; }
#toast-container .toast.border-warning { border-left: 4px solid var(--bs-warning) !important; }
#toast-container .toast.border-info { border-left: 4px solid var(--bs-info) !important; }
</style>
