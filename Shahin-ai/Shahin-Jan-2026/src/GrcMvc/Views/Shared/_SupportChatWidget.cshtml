@* Support Chat Widget - AI-Powered User Assistance *@
@using Microsoft.AspNetCore.Mvc.Localization
@using GrcMvc.Resources
@inject IHtmlLocalizer<SharedResource> L

<!-- Floating Chat Button -->
<div id="supportChatButton" class="position-fixed" style="bottom: 20px; right: 20px; z-index: 9999;">
    <button class="btn btn-primary btn-lg rounded-circle shadow-lg" onclick="toggleSupportChat()"
            style="width: 60px; height: 60px;" title="@L["Shared_Chat_Help"]">
        <i class="fas fa-headset fa-lg" id="chatIcon"></i>
    </button>
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="chatBadge" style="display: none;">
        1
    </span>
</div>

<!-- Chat Window -->
<div id="supportChatWindow" class="position-fixed shadow-lg rounded"
     style="bottom: 90px; right: 20px; width: 380px; height: 500px; z-index: 9998; display: none; background: white; border: 1px solid #ddd;">

    <!-- Chat Header -->
    <div class="bg-primary text-white p-3 rounded-top d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <div class="bg-white rounded-circle p-2 me-2">
                <i class="fas fa-robot text-primary"></i>
            </div>
            <div>
                <strong>@L["Shared_Chat_Assistant"]</strong>
                <small class="d-block opacity-75">@L["Shared_Chat_Online"]</small>
            </div>
        </div>
        <div>
            <button class="btn btn-sm btn-outline-light me-1" onclick="escalateToHuman()" title="@L["Shared_Chat_TransferHuman"]">
                <i class="fas fa-user"></i>
            </button>
            <button class="btn btn-sm btn-outline-light" onclick="toggleSupportChat()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Chat Messages -->
    <div id="chatMessages" class="p-3" style="height: 350px; overflow-y: auto; background: #f8f9fa;">
        <!-- Messages will be inserted here -->
    </div>

    <!-- Quick Actions -->
    <div class="border-top p-2 bg-light">
        <div class="d-flex flex-wrap gap-1">
            <button class="btn btn-outline-secondary btn-sm" onclick="sendQuickMessage('@L["Shared_Chat_QuickToS"]')">
                <i class="fas fa-file-contract me-1"></i>@L["Shared_Chat_QuickToS"]
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="sendQuickMessage('@L["Shared_Chat_QuickPrivacy"]')">
                <i class="fas fa-shield-alt me-1"></i>@L["Shared_Chat_QuickPrivacy"]
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="sendQuickMessage('@L["Shared_Chat_QuickStart"]')">
                <i class="fas fa-play me-1"></i>@L["Shared_Chat_QuickStart"]
            </button>
        </div>
    </div>

    <!-- Chat Input -->
    <div class="border-top p-2">
        <div class="input-group">
            <input type="text" id="chatInput" class="form-control" placeholder="@L["Shared_Chat_InputPlaceholder"]"
                   onkeypress="if(event.key === 'Enter') sendMessage()">
            <button class="btn btn-primary" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- Terms of Service Modal -->
<div class="modal fade" id="tosModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-file-contract me-2"></i>@L["Shared_Chat_ToS"]</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 60vh;">
                <div class="mb-4">
                    <h4>Terms of Service</h4>
                    <p class="text-muted">Version 1.0 | Effective Date: January 1, 2026</p>
                </div>

                <h5>1. Acceptance of Terms</h5>
                <p>By accessing and using the GRC Management System ("Service"), you agree to be bound by these Terms of Service. If you do not agree to these terms, please do not use the Service.</p>

                <h5>2. Account Responsibilities</h5>
                <p>You are responsible for maintaining the confidentiality of your account credentials and for all activities that occur under your account. You must immediately notify us of any unauthorized use.</p>

                <h5>3. Data Protection Compliance</h5>
                <p>You agree to comply with all applicable data protection laws, including the Saudi Personal Data Protection Law (PDPL). You must ensure that any data you enter into the system is collected and processed lawfully.</p>

                <h5>4. Acceptable Use</h5>
                <p>The Service must be used only for legitimate GRC (Governance, Risk, and Compliance) purposes. Prohibited activities include:</p>
                <ul>
                    <li>Unauthorized access attempts</li>
                    <li>Data misuse or unauthorized sharing</li>
                    <li>Violation of any applicable laws or regulations</li>
                    <li>Interference with service operation</li>
                </ul>

                <h5>5. Intellectual Property</h5>
                <p>All platform content, features, and functionality are protected by intellectual property laws. You may not copy, modify, or distribute any part of the Service without authorization.</p>

                <h5>6. Service Availability</h5>
                <p>We strive for 99.9% uptime but may perform scheduled maintenance. We are not liable for any temporary unavailability.</p>

                <h5>7. Termination</h5>
                <p>Either party may terminate the agreement with 30 days written notice. Upon termination, your access will be revoked and data will be handled according to our data retention policy.</p>

                <h5>8. Limitation of Liability</h5>
                <p>The Service is provided "as is" without warranties of any kind. We shall not be liable for any indirect, incidental, or consequential damages.</p>

                <h5>9. Governing Law</h5>
                <p>These terms are governed by the laws of the Kingdom of Saudi Arabia. Any disputes shall be resolved in the courts of Riyadh.</p>

                <hr class="my-4">

                <h4 class="text-end" dir="rtl">Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©</h4>
                <p class="text-end text-muted" dir="rtl">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0 | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø±ÙŠØ§Ù†: 1 ÙŠÙ†Ø§ÙŠØ± 2026</p>

                <h5 class="text-end" dir="rtl">1. Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø´Ø±ÙˆØ·</h5>
                <p class="text-end" dir="rtl">Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙˆÙƒÙ…Ø© ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„ ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ØŒ ÙØ¥Ù†Ùƒ ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø© Ù‡Ø°Ù‡.</p>

                <h5 class="text-end" dir="rtl">2. Ù…Ø³Ø¤ÙˆÙ„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h5>
                <p class="text-end" dir="rtl">Ø£Ù†Øª Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø³Ø±ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯ Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªÙŠ ØªØªÙ… ØªØ­Øª Ø­Ø³Ø§Ø¨Ùƒ.</p>

                <h5 class="text-end" dir="rtl">3. Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
                <p class="text-end" dir="rtl">Ø£Ù†Øª ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Ù†ÙŠÙ† Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù…ÙˆÙ„ Ø¨Ù‡Ø§ØŒ Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ù†Ø¸Ø§Ù… Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ (PDPL).</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@L["Close"]</button>
            </div>
        </div>
    </div>
</div>

<!-- Privacy Policy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-shield-alt me-2"></i>@L["Shared_Chat_PrivacyPolicy"]</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 60vh;">
                <div class="mb-4">
                    <h4>Privacy Policy</h4>
                    <p class="text-muted">Version 1.0 | Effective Date: January 1, 2026</p>
                </div>

                <h5>1. Data Collection</h5>
                <p>We collect only the data necessary for providing GRC services:</p>
                <ul>
                    <li><strong>Account Information:</strong> Name, email, organization details</li>
                    <li><strong>Organization Profile:</strong> Sector, size, compliance maturity</li>
                    <li><strong>Compliance Data:</strong> Assessment results, evidence, control status</li>
                    <li><strong>Usage Data:</strong> Login times, feature usage for improvement</li>
                </ul>

                <h5>2. Data Processing</h5>
                <p>Your data is processed in the Kingdom of Saudi Arabia and stored on secure, encrypted servers. We implement:</p>
                <ul>
                    <li>AES-256 encryption at rest</li>
                    <li>TLS 1.3 encryption in transit</li>
                    <li>Role-based access controls</li>
                    <li>Regular security audits</li>
                </ul>

                <h5>3. Data Sharing</h5>
                <p>We do not sell your data. Third-party sharing is limited to:</p>
                <ul>
                    <li>Cloud infrastructure providers (under strict DPA)</li>
                    <li>Regulatory authorities (when legally required)</li>
                    <li>Auditors (with your consent)</li>
                </ul>

                <h5>4. Your Rights (PDPL Compliance)</h5>
                <p>Under PDPL, you have the right to:</p>
                <ul>
                    <li><strong>Access:</strong> Request a copy of your personal data</li>
                    <li><strong>Correction:</strong> Request correction of inaccurate data</li>
                    <li><strong>Deletion:</strong> Request deletion of your data</li>
                    <li><strong>Portability:</strong> Receive your data in a portable format</li>
                    <li><strong>Objection:</strong> Object to certain processing activities</li>
                </ul>

                <h5>5. Data Retention</h5>
                <p>Data is retained as long as your account is active, plus 7 years for regulatory compliance purposes. After this period, data is securely deleted.</p>

                <h5>6. Contact</h5>
                <p>For privacy inquiries, contact our Data Protection Officer at: dpo@grc-system.sa</p>

                <hr class="my-4">

                <h4 class="text-end" dir="rtl">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</h4>
                <p class="text-end text-muted" dir="rtl">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0 | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø±ÙŠØ§Ù†: 1 ÙŠÙ†Ø§ÙŠØ± 2026</p>

                <h5 class="text-end" dir="rtl">1. Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
                <p class="text-end" dir="rtl">Ù†Ø¬Ù…Ø¹ ÙÙ‚Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù„ØªÙ‚Ø¯ÙŠÙ… Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø­ÙˆÙƒÙ…Ø© ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„.</p>

                <h5 class="text-end" dir="rtl">2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
                <p class="text-end" dir="rtl">ØªØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§ Ø¹Ù„Ù‰ Ø®ÙˆØ§Ø¯Ù… Ù…Ø´ÙØ±Ø© ÙˆØ¢Ù…Ù†Ø©.</p>

                <h5 class="text-end" dir="rtl">3. Ø­Ù‚ÙˆÙ‚Ùƒ (Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ù„Ù†Ø¸Ø§Ù… PDPL)</h5>
                <p class="text-end" dir="rtl">Ø¨Ù…ÙˆØ¬Ø¨ Ù†Ø¸Ø§Ù… Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©ØŒ Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø­Ù‚ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ ÙˆØ§Ù„ØªØµØ­ÙŠØ­ ÙˆØ§Ù„Ø­Ø°Ù ÙˆÙ†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@L["Close"]</button>
            </div>
        </div>
    </div>
</div>

<style>
    #supportChatWindow {
        animation: slideUp 0.3s ease-out;
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chat-message {
        max-width: 85%;
        margin-bottom: 10px;
        padding: 10px 15px;
        border-radius: 15px;
        animation: fadeIn 0.3s ease-out;
    }

    .chat-message.user {
        background: #0d6efd;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 5px;
    }

    .chat-message.agent {
        background: white;
        border: 1px solid #ddd;
        margin-right: auto;
        border-bottom-left-radius: 5px;
    }

    .chat-message.system {
        background: #fff3cd;
        border: 1px solid #ffc107;
        margin: 0 auto;
        text-align: center;
        font-size: 0.85rem;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .typing-indicator {
        display: flex;
        gap: 5px;
        padding: 10px;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #999;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @@keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }
</style>

<script>
    let conversationId = null;
    let chatOpen = false;

    function toggleSupportChat() {
        const chatWindow = document.getElementById('supportChatWindow');
        const chatIcon = document.getElementById('chatIcon');
        const chatBadge = document.getElementById('chatBadge');

        chatOpen = !chatOpen;
        chatWindow.style.display = chatOpen ? 'block' : 'none';
        chatIcon.className = chatOpen ? 'fas fa-times fa-lg' : 'fas fa-headset fa-lg';
        chatBadge.style.display = 'none';

        if (chatOpen && !conversationId) {
            startConversation();
        }
    }

    async function startConversation() {
        try {
            const response = await fetch('/api/support/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                const data = await response.json();
                conversationId = data.id;
                loadMessages();
            } else {
                // Fallback: show welcome message locally
                addMessage('agent', getWelcomeMessage());
            }
        } catch (error) {
            addMessage('agent', getWelcomeMessage());
        }
    }

    function getWelcomeMessage() {
        return `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… GRC! ğŸ‘‹

Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠØŒ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:
â€¢ ÙÙ‡Ù… Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆØ³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©
â€¢ Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
â€¢ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙƒ

ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ`;
    }

    function addMessage(type, content) {
        const messagesDiv = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${type}`;
        // XSS Prevention: Use textContent to safely render user input
        // For newlines, split and append text nodes with <br> elements
        const lines = content.split('\n');
        lines.forEach((line, index) => {
            messageDiv.appendChild(document.createTextNode(line));
            if (index < lines.length - 1) {
                messageDiv.appendChild(document.createElement('br'));
            }
        });
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTypingIndicator() {
        const messagesDiv = document.getElementById('chatMessages');
        const indicator = document.createElement('div');
        indicator.id = 'typingIndicator';
        indicator.className = 'typing-indicator';
        indicator.innerHTML = '<span></span><span></span><span></span>';
        messagesDiv.appendChild(indicator);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        input.value = '';
        addMessage('user', message);
        showTypingIndicator();

        try {
            const response = await fetch('/api/support/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ conversationId, content: message })
            });

            hideTypingIndicator();

            if (response.ok) {
                const data = await response.json();
                addMessage('agent', data.agentResponse);
            } else {
                // Fallback: local response
                const localResponse = getLocalResponse(message);
                addMessage('agent', localResponse);
            }
        } catch (error) {
            hideTypingIndicator();
            const localResponse = getLocalResponse(message);
            addMessage('agent', localResponse);
        }
    }

    function sendQuickMessage(message) {
        document.getElementById('chatInput').value = message;
        sendMessage();
    }

    function getLocalResponse(message) {
        const lower = message.toLowerCase();

        if (lower.includes('Ø´Ø±ÙˆØ·') || lower.includes('terms') || lower.includes('service')) {
            return `ğŸ“‹ Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø© ØªØºØ·ÙŠ:
â€¢ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
â€¢ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ù„Ù€ PDPL
â€¢ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…
â€¢ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø§Ù„ÙÙƒØ±ÙŠØ©

Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©" ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.`;
        }

        if (lower.includes('Ø®ØµÙˆØµÙŠØ©') || lower.includes('privacy') || lower.includes('Ø¨ÙŠØ§Ù†Ø§Øª')) {
            return `ğŸ”’ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©:
â€¢ Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙÙ‚Ø·
â€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ÙØ±Ø© ÙˆÙ…Ø­Ù…ÙŠØ©
â€¢ Ø­Ù‚ÙˆÙ‚Ùƒ Ù…Ø­ÙÙˆØ¸Ø© ÙˆÙÙ‚ PDPL
â€¢ Ù„Ø§ Ù†Ø¨ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£Ø¨Ø¯Ø§Ù‹

Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©".`;
        }

        if (lower.includes('Ø¨Ø¯Ø¡') || lower.includes('start') || lower.includes('ÙƒÙŠÙ')) {
            return `ğŸ“ Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…:
1. Ø£ÙƒÙ…Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
2. ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©
3. Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ù…Ù„Ù Ø§Ù„Ù…Ù†Ø¸Ù…Ø©
4. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø·Ø± Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©
5. Ø£Ù†Ø´Ø¦ Ø®Ø·Ø© Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„

Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªØ³ØªØºØ±Ù‚ Ø­ÙˆØ§Ù„ÙŠ 15 Ø¯Ù‚ÙŠÙ‚Ø©.`;
        }

        return `Ø´ÙƒØ±Ø§Ù‹ Ù„Ø³Ø¤Ø§Ù„Ùƒ! ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:
â€¢ Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©
â€¢ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©
â€¢ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
â€¢ Ø§Ù„Ø£Ø·Ø± Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠØ©

Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ø£Ø¯Ù†Ø§Ù‡.`;
    }

    async function escalateToHuman() {
        addMessage('system', 'Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¨Ø´Ø±ÙŠ...');

        try {
            const response = await fetch('/api/support/escalate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ conversationId, reason: 'User requested human agent' })
            });

            if (response.ok) {
                addMessage('agent', 'ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¥Ù„Ù‰ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù…. Ø³ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø£Ø­Ø¯ Ù…Ù…Ø«Ù„ÙŠ Ø§Ù„Ø¯Ø¹Ù… Ù‚Ø±ÙŠØ¨Ø§Ù‹. ğŸ“');
            }
        } catch (error) {
            addMessage('agent', 'Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¨Ø´Ø±ÙŠØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¥Ù„Ù‰: support@grc-system.sa');
        }
    }

    async function loadMessages() {
        if (!conversationId) return;

        try {
            const response = await fetch(`/api/support/messages/${conversationId}`);
            if (response.ok) {
                const messages = await response.json();
                const messagesDiv = document.getElementById('chatMessages');
                messagesDiv.innerHTML = '';
                messages.forEach(msg => addMessage(msg.senderType.toLowerCase(), msg.content));
            }
        } catch (error) {
        }
    }
</script>
