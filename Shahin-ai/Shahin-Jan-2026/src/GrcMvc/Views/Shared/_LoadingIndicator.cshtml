@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<SharedResource> L

<!-- Global Loading Overlay -->
<div id="loading-overlay" class="loading-overlay d-none">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">@L["Loading"]</span>
        </div>
        <p class="loading-text mb-0">@L["Loading"]</p>
    </div>
</div>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loading-content {
    text-align: center;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.loading-text {
    color: var(--bs-primary);
    font-weight: 500;
}

/* Button loading states */
.btn-loading {
    position: relative;
    pointer-events: none;
}

.btn-loading .btn-text {
    opacity: 0;
}

.btn-loading::after {
    content: "";
    position: absolute;
    width: 1rem;
    height: 1rem;
    top: 50%;
    left: 50%;
    margin-left: -0.5rem;
    margin-top: -0.5rem;
    border: 2px solid currentColor;
    border-radius: 50%;
    border-right-color: transparent;
    animation: btn-spinner 0.75s linear infinite;
}

@@keyframes btn-spinner {
    to { transform: rotate(360deg); }
}

/* Inline spinner for inputs */
.input-loading {
    position: relative;
}

.input-loading::after {
    content: "";
    position: absolute;
    right: 10px;
    top: 50%;
    margin-top: -8px;
    width: 16px;
    height: 16px;
    border: 2px solid #ccc;
    border-radius: 50%;
    border-right-color: transparent;
    animation: btn-spinner 0.75s linear infinite;
}

/* Skeleton loading */
.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 4px;
}

@@keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.skeleton-text {
    height: 1em;
    margin-bottom: 0.5em;
}

.skeleton-text.short { width: 40%; }
.skeleton-text.medium { width: 70%; }
.skeleton-text.long { width: 100%; }

.skeleton-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
}

.skeleton-card {
    height: 150px;
    border-radius: 8px;
}
</style>

<script>
// Loading Indicator Functions
window.GrcLoading = {
    overlay: null,
    text: null,

    init: function() {
        this.overlay = document.getElementById('loading-overlay');
        this.text = this.overlay?.querySelector('.loading-text');
    },

    show: function(message = '@L["Loading"]') {
        if (!this.overlay) this.init();
        if (this.overlay) {
            if (this.text) this.text.textContent = message;
            this.overlay.classList.remove('d-none');
        }
    },

    hide: function() {
        if (!this.overlay) this.init();
        if (this.overlay) {
            this.overlay.classList.add('d-none');
        }
    },

    // Button loading state
    setButtonLoading: function(button, loading = true, text = null) {
        if (!button) return;
        
        if (loading) {
            button.classList.add('btn-loading');
            button.disabled = true;
            if (text) {
                button.dataset.originalText = button.innerHTML;
                // XSS Prevention: Use DOM methods instead of innerHTML with interpolation
                const span = document.createElement('span');
                span.className = 'btn-text';
                span.textContent = text; // Safe: textContent escapes HTML
                button.innerHTML = '';
                button.appendChild(span);
            }
        } else {
            button.classList.remove('btn-loading');
            button.disabled = false;
            if (button.dataset.originalText) {
                button.innerHTML = button.dataset.originalText;
                delete button.dataset.originalText;
            }
        }
    },

    // Form submission with loading
    submitWithLoading: function(form, buttonSelector = 'button[type="submit"]') {
        const button = form.querySelector(buttonSelector);
        this.setButtonLoading(button, true, '@L["Processing"]');
        return true;
    }
};

// Auto-attach to forms with data-loading attribute
document.addEventListener('DOMContentLoaded', function() {
    GrcLoading.init();

    // Forms with data-loading attribute
    document.querySelectorAll('form[data-loading]').forEach(form => {
        form.addEventListener('submit', function() {
            GrcLoading.submitWithLoading(this);
        });
    });

    // Links with data-loading attribute
    document.querySelectorAll('a[data-loading]').forEach(link => {
        link.addEventListener('click', function() {
            GrcLoading.show(this.dataset.loading || '@L["Loading"]');
        });
    });
});

// Show loading on page navigation
window.addEventListener('beforeunload', function() {
    // Only show if navigating away (not form submission)
    if (!document.querySelector('form:focus-within')) {
        GrcLoading.show('@L["Loading"]');
    }
});
</script>
