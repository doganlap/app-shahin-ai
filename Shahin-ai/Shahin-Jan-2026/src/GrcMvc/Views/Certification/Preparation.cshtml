@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<SharedResource> L
@model GrcMvc.Models.ViewModels.Certification.PreparationPlanViewModel
@{
    ViewData["Title"] = "Certification Preparation";
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-list-check"></i> Certification Preparation Plan</h2>
            @if (!string.IsNullOrEmpty(Model.CertificationName))
            {
                <p class="text-muted">Preparing for: <strong>@Model.CertificationName (@Model.Standard)</strong></p>
            }
            else
            {
                <p class="text-muted">General certification preparation planning</p>
            }
        </div>
        <div class="col text-end">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Certifications
            </a>
            <a asp-action="Readiness" class="btn btn-outline-info">
                <i class="bi bi-clipboard-check"></i> Assess Readiness
            </a>
        </div>
    </div>

    <!-- Preparation Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-primary">
                <div class="card-body">
                    <h5>Overall Preparation Progress</h5>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-primary" role="progressbar"
                             style="width: @((Model.CompletedTasks * 100.0 / Math.Max(Model.TotalTasks, 1)).ToString("F0"))%">
                            @Model.CompletedTasks / @Model.TotalTasks Tasks Complete
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3 text-center">
                            <h4 class="text-primary">@((Model.CompletedTasks * 100.0 / Math.Max(Model.TotalTasks, 1)).ToString("F0"))%</h4>
                            <small class="text-muted">Completion</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h4 class="text-success">@Model.CompletedTasks</h4>
                            <small class="text-muted">Completed</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h4 class="text-warning">@Model.InProgressTasks</h4>
                            <small class="text-muted">In Progress</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h4 class="text-danger">@Model.OverdueTasks</h4>
                            <small class="text-muted">Overdue</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preparation Phases -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Preparation Phases</h5>
                </div>
                <div class="card-body">
                    <!-- Phase 1: Gap Analysis -->
                    <div class="card mb-3">
                        <div class="card-header @(Model.CurrentPhase >= 1 ? "bg-primary text-white" : "bg-light")">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-1-circle"></i> Phase 1: Gap Analysis
                                    @if (Model.CurrentPhase > 1) { <i class="bi bi-check-circle ms-2"></i> }
                                </h6>
                                <span class="badge @(Model.Phase1Progress >= 100 ? "bg-success" : "bg-warning text-dark")">
                                    @Model.Phase1Progress% Complete
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">Identify current state vs. certification requirements</p>
                            <ul class="small">
                                <li>Review certification standard/framework documentation</li>
                                <li>Conduct current state assessment</li>
                                <li>Document gaps and deficiencies</li>
                                <li>Prioritize remediation activities</li>
                            </ul>
                            @if (Model.CurrentPhase == 1)
                            {
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" style="width: @Model.Phase1Progress%">@Model.Phase1Progress%</div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Phase 2: Remediation -->
                    <div class="card mb-3">
                        <div class="card-header @(Model.CurrentPhase >= 2 ? "bg-primary text-white" : "bg-light")">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-2-circle"></i> Phase 2: Remediation & Implementation
                                    @if (Model.CurrentPhase > 2) { <i class="bi bi-check-circle ms-2"></i> }
                                </h6>
                                <span class="badge @(Model.Phase2Progress >= 100 ? "bg-success" : "bg-warning text-dark")">
                                    @Model.Phase2Progress% Complete
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">Address identified gaps and implement required controls</p>
                            <ul class="small">
                                <li>Implement missing policies and procedures</li>
                                <li>Deploy required technical controls</li>
                                <li>Update processes to meet requirements</li>
                                <li>Conduct training and awareness</li>
                            </ul>
                            @if (Model.CurrentPhase == 2)
                            {
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" style="width: @Model.Phase2Progress%">@Model.Phase2Progress%</div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Phase 3: Evidence Collection -->
                    <div class="card mb-3">
                        <div class="card-header @(Model.CurrentPhase >= 3 ? "bg-primary text-white" : "bg-light")">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-3-circle"></i> Phase 3: Evidence Collection
                                    @if (Model.CurrentPhase > 3) { <i class="bi bi-check-circle ms-2"></i> }
                                </h6>
                                <span class="badge @(Model.Phase3Progress >= 100 ? "bg-success" : "bg-warning text-dark")">
                                    @Model.Phase3Progress% Complete
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">Gather and organize audit evidence</p>
                            <ul class="small">
                                <li>Collect documentation and records</li>
                                <li>Capture screenshots and configurations</li>
                                <li>Prepare evidence repository</li>
                                <li>Cross-reference evidence to requirements</li>
                            </ul>
                            @if (Model.CurrentPhase == 3)
                            {
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" style="width: @Model.Phase3Progress%">@Model.Phase3Progress%</div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Phase 4: Internal Audit -->
                    <div class="card mb-3">
                        <div class="card-header @(Model.CurrentPhase >= 4 ? "bg-primary text-white" : "bg-light")">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-4-circle"></i> Phase 4: Internal Audit
                                    @if (Model.CurrentPhase > 4) { <i class="bi bi-check-circle ms-2"></i> }
                                </h6>
                                <span class="badge @(Model.Phase4Progress >= 100 ? "bg-success" : "bg-warning text-dark")">
                                    @Model.Phase4Progress% Complete
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">Conduct mock audit to verify readiness</p>
                            <ul class="small">
                                <li>Perform internal assessment</li>
                                <li>Identify remaining issues</li>
                                <li>Conduct remediation review</li>
                                <li>Verify evidence completeness</li>
                            </ul>
                            @if (Model.CurrentPhase == 4)
                            {
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" style="width: @Model.Phase4Progress%">@Model.Phase4Progress%</div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Phase 5: Certification Audit -->
                    <div class="card">
                        <div class="card-header @(Model.CurrentPhase >= 5 ? "bg-success text-white" : "bg-light")">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-5-circle"></i> Phase 5: External Certification Audit
                                    @if (Model.CurrentPhase > 5) { <i class="bi bi-trophy ms-2"></i> }
                                </h6>
                                <span class="badge @(Model.Phase5Progress >= 100 ? "bg-success" : "bg-warning text-dark")">
                                    @Model.Phase5Progress% Complete
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">Host external auditor and achieve certification</p>
                            <ul class="small">
                                <li>Schedule certification audit</li>
                                <li>Coordinate with auditor</li>
                                <li>Support audit activities</li>
                                <li>Address audit findings</li>
                                <li>Receive certification</li>
                            </ul>
                            @if (Model.CurrentPhase == 5)
                            {
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" style="width: @Model.Phase5Progress%">@Model.Phase5Progress%</div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Checklist -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-check2-square"></i> Preparation Checklist</h5>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="bi bi-plus-circle"></i> Add Task
                    </button>
                </div>
                <div class="card-body p-0">
                    @if (Model.Tasks?.Any() == true)
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var task in Model.Tasks.OrderBy(t => t.DueDate))
                            {
                                var statusClass = task.Status switch
                                {
                                    "Completed" => "list-group-item-success",
                                    "InProgress" => "list-group-item-info",
                                    "Overdue" => "list-group-item-danger",
                                    _ => ""
                                };

                                <div class="list-group-item @statusClass">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" @(task.Status == "Completed" ? "checked" : "")
                                                       onchange="toggleTask('@task.Id')">
                                                <label class="form-check-label @(task.Status == "Completed" ? "text-decoration-line-through" : "")">
                                                    <strong>@task.Name</strong>
                                                    @if (!string.IsNullOrEmpty(task.Description))
                                                    {
                                                        <br /><small class="text-muted">@task.Description</small>
                                                    }
                                                </label>
                                            </div>
                                            <div class="mt-2">
                                                <span class="badge bg-light text-dark">Phase @task.Phase</span>
                                                @if (!string.IsNullOrEmpty(task.AssignedTo))
                                                {
                                                    <span class="badge bg-info"><i class="bi bi-person"></i> @task.AssignedTo</span>
                                                }
                                                @if (task.DueDate.HasValue)
                                                {
                                                    var daysUntilDue = (task.DueDate.Value - DateTime.UtcNow).Days;
                                                    var dueBadge = daysUntilDue < 0 ? "bg-danger" :
                                                                  daysUntilDue <= 7 ? "bg-warning text-dark" : "bg-secondary";
                                                    <span class="badge @dueBadge">
                                                        <i class="bi bi-calendar"></i> Due: @task.DueDate.Value.ToShortDateString()
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge @GetStatusBadge(task.Status)">@task.Status</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-check2-square display-4 text-muted opacity-25"></i>
                            <p class="text-muted mt-3">No preparation tasks defined yet</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                                <i class="bi bi-plus-circle"></i> Add First Task
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Add Preparation Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="AddPreparationTask" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Task Title *</label>
                        <input type="text" class="form-control" name="Title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="Description" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phase *</label>
                            <select class="form-select" name="Phase" required>
                                <option value="1">Phase 1 - Gap Analysis</option>
                                <option value="2">Phase 2 - Remediation</option>
                                <option value="3">Phase 3 - Evidence Collection</option>
                                <option value="4">Phase 4 - Internal Audit</option>
                                <option value="5">Phase 5 - Certification Audit</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Assigned To</label>
                            <input type="text" class="form-control" name="AssignedTo">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" name="DueDate">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function toggleTask(taskId) {
            // TODO: Submit task completion toggle
            console.log('Toggle task: ' + taskId);
        }
    </script>
}

@functions {
    private string GetStatusBadge(string status)
    {
        return status switch
        {
            "Completed" => "bg-success",
            "InProgress" => "bg-info",
            "Overdue" => "bg-danger",
            "Pending" => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }
}
