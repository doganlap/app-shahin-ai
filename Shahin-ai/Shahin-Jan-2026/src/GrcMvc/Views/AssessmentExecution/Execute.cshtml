@{
    ViewData["Title"] = ViewData["Title"] ?? "Execute Assessment";
    Layout = "_Layout";
    var assessmentId = ViewData["AssessmentId"];
    var assessmentName = ViewData["AssessmentName"] ?? "Assessment";
}

<div class="container-fluid mt-3" id="assessmentExecutionApp">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Assessment" asp-action="Index">Assessments</a></li>
                    <li class="breadcrumb-item active" id="assessmentName">@assessmentName</li>
                </ol>
            </nav>
            <h2>
                <i class="bi bi-clipboard-check text-primary me-2"></i>
                <span id="headerTitle">@assessmentName</span>
            </h2>
            <p class="text-muted mb-0" id="frameworkInfo">Loading framework information...</p>
        </div>
        <div class="col-md-4 text-end">
            <a asp-controller="Assessment" asp-action="Details" asp-route-id="@assessmentId" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i> Back to Details
            </a>
            <button class="btn btn-success" onclick="exportAssessment()" title="Export to Excel">
                <i class="bi bi-file-earmark-excel"></i> Export
            </button>
        </div>
    </div>

    <!-- Overall Progress Card -->
    <div class="card shadow-sm mb-4" id="progressCard">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-2">Overall Progress</h5>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-success" id="overallProgressBar" role="progressbar" style="width: 0%">
                            <span id="overallProgressText">0%</span>
                        </div>
                    </div>
                    <small class="text-muted mt-1 d-block" id="progressSummary">Loading...</small>
                </div>
                <div class="col-md-6">
                    <div class="row text-center">
                        <div class="col-3">
                            <h4 id="completedCount" class="text-success mb-0">0</h4>
                            <small class="text-muted">Completed</small>
                        </div>
                        <div class="col-3">
                            <h4 id="inProgressCount" class="text-info mb-0">0</h4>
                            <small class="text-muted">In Progress</small>
                        </div>
                        <div class="col-3">
                            <h4 id="pendingCount" class="text-warning mb-0">0</h4>
                            <small class="text-muted">Pending</small>
                        </div>
                        <div class="col-3">
                            <h4 id="overallScore" class="text-primary mb-0">-</h4>
                            <small class="text-muted">Avg Score</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="loadingIndicator" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading assessment data...</p>
    </div>

    <!-- Domain Sections -->
    <div id="domainsContainer" style="display: none;">
        <!-- Dynamically populated -->
    </div>
</div>

<!-- Evidence Upload Modal -->
<div class="modal fade" id="evidenceUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-upload me-2"></i>Upload Evidence</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="evidenceRequirementId" />
                <div class="mb-3">
                    <label class="form-label">Title <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="evidenceTitle" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="evidenceDescription" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">File <span class="text-danger">*</span></label>
                    <input type="file" class="form-control" id="evidenceFile" required />
                    <small class="text-muted">Max file size: 10MB</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadEvidence()">
                    <i class="bi bi-upload"></i> Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notes Modal -->
<div class="modal fade" id="notesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-sticky me-2"></i>Notes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="notesRequirementId" />
                <div class="mb-3">
                    <textarea class="form-control" id="newNoteContent" rows="3" placeholder="Add a new note..."></textarea>
                </div>
                <button class="btn btn-primary btn-sm mb-3" onclick="saveNote()">
                    <i class="bi bi-save"></i> Save Note
                </button>
                <hr/>
                <h6>Notes History</h6>
                <div id="notesHistory">
                    <p class="text-muted">No notes yet</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scoring Guide Modal -->
<div class="modal fade" id="scoringGuideModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-star me-2"></i>Scoring Guide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="scoringGuideContent">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const assessmentId = '@assessmentId';
    let assessmentData = null;

    // Status options with colors
    const statusOptions = {
        'NotStarted': { label: 'Not Started', color: 'secondary', icon: 'bi-circle' },
        'InProgress': { label: 'In Progress', color: 'info', icon: 'bi-arrow-repeat' },
        'Compliant': { label: 'Compliant', color: 'success', icon: 'bi-check-circle-fill' },
        'PartiallyCompliant': { label: 'Partially Compliant', color: 'warning', icon: 'bi-exclamation-circle' },
        'NonCompliant': { label: 'Non-Compliant', color: 'danger', icon: 'bi-x-circle-fill' },
        'NotApplicable': { label: 'Not Applicable', color: 'dark', icon: 'bi-dash-circle' }
    };

    document.addEventListener('DOMContentLoaded', loadAssessmentData);

    async function loadAssessmentData() {
        try {
            const response = await fetch(`/api/assessment-execution/${assessmentId}`);
            if (!response.ok) throw new Error('Failed to load assessment');

            assessmentData = await response.json();
            renderAssessment(assessmentData);
            updateProgress(assessmentData);

            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('domainsContainer').style.display = 'block';

        } catch (error) {
            console.error('Error loading assessment:', error);
            document.getElementById('loadingIndicator').innerHTML =
                '<div class="alert alert-danger">Failed to load assessment data. Please try again.</div>';
        }
    }

    function renderAssessment(data) {
        // Update header
        document.getElementById('assessmentName').textContent = data.name;
        document.getElementById('headerTitle').textContent = data.name;
        document.getElementById('frameworkInfo').textContent =
            `${data.frameworkName || data.frameworkCode || 'Unknown Framework'} - ${data.totalRequirements} Requirements`;

        // Group requirements by domain
        const domainGroups = {};
        data.requirements.forEach(req => {
            const domain = req.domain || 'Other';
            if (!domainGroups[domain]) {
                domainGroups[domain] = [];
            }
            domainGroups[domain].push(req);
        });

        // Render domain sections
        const container = document.getElementById('domainsContainer');
        container.innerHTML = '';

        const domains = Object.keys(domainGroups).sort();
        domains.forEach((domain, index) => {
            const domainProgress = data.domains.find(d => d.domainCode === domain) || {};
            container.innerHTML += renderDomainSection(domain, domainGroups[domain], domainProgress, index === 0);
        });
    }

    function renderDomainSection(domain, requirements, progress, expanded) {
        const progressPct = progress.progress || 0;
        const collapseId = `collapse-${domain.replace(/[^a-zA-Z0-9]/g, '-')}`;
        const progressColor = progressPct >= 80 ? 'success' : progressPct >= 50 ? 'warning' : 'secondary';

        return `
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-light" style="cursor: pointer;"
                     data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-folder me-2 text-primary"></i>${domain}
                            <span class="badge bg-secondary ms-2">${requirements.length} requirements</span>
                        </h5>
                        <div class="d-flex align-items-center">
                            <div class="progress me-3" style="width: 150px; height: 20px;">
                                <div class="progress-bar bg-${progressColor}" style="width: ${progressPct}%">${progressPct.toFixed(0)}%</div>
                            </div>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                    </div>
                </div>
                <div id="${collapseId}" class="collapse ${expanded ? 'show' : ''}">
                    <div class="card-body">
                        ${requirements.map(req => renderRequirementCard(req)).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function renderRequirementCard(req) {
        const status = statusOptions[req.status] || statusOptions['NotStarted'];
        const hasGuidance = req.implementationGuidance || req.bestPractices || req.commonGaps;

        return `
            <div class="card mb-3 border-start border-4 border-${status.color}" id="req-${req.id}">
                <div class="card-header bg-${status.color} bg-opacity-10">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <strong class="text-${status.color}">${req.controlNumber}</strong>
                            <span class="ms-2">${req.controlTitle}</span>
                        </div>
                        <div class="col-md-6 text-end">
                            <select class="form-select form-select-sm d-inline-block w-auto"
                                    onchange="updateStatus('${req.id}', this.value)">
                                ${Object.keys(statusOptions).map(s =>
                                    `<option value="${s}" ${req.status === s ? 'selected' : ''}>${statusOptions[s].label}</option>`
                                ).join('')}
                            </select>
                            <span class="badge bg-${status.color} ms-2">
                                <i class="bi ${status.icon}"></i>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Requirement Text -->
                            <div class="mb-3">
                                <h6 class="text-muted">Requirement</h6>
                                <p>${req.requirementText || '<em>No requirement text</em>'}</p>
                            </div>

                            ${hasGuidance ? `
                            <!-- Implementation Guidance - Collapsible -->
                            <div class="accordion accordion-flush mb-3" id="guidance-${req.id}">
                                <div class="accordion-item border-0">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed p-2 bg-light rounded" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#guidance-content-${req.id}">
                                            <i class="bi bi-lightbulb text-warning me-2"></i>Implementation Guidance
                                        </button>
                                    </h2>
                                    <div id="guidance-content-${req.id}" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            ${req.implementationGuidance ? `<p>${req.implementationGuidance}</p>` : ''}
                                            ${req.bestPractices ? `<hr/><strong>Best Practices:</strong><br/><p>${req.bestPractices}</p>` : ''}
                                            ${req.commonGaps ? `<hr/><strong>Common Gaps:</strong><br/><p class="text-danger">${req.commonGaps}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>

                        <div class="col-md-4">
                            <!-- Score Input -->
                            <div class="mb-3">
                                <label class="form-label">Score (0-${req.maxScore})</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="score-${req.id}"
                                           min="0" max="${req.maxScore}" value="${req.score || ''}"
                                           onchange="updateScore('${req.id}')">
                                    <button class="btn btn-outline-info" type="button"
                                            onclick="showScoringGuide('${req.id}', '${encodeURIComponent(req.scoringGuideJson || '[]')}')"
                                            title="View Scoring Guide">
                                        <i class="bi bi-info-circle"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Score Rationale -->
                            <div class="mb-3">
                                <label class="form-label">Score Rationale</label>
                                <textarea class="form-control form-control-sm" id="rationale-${req.id}" rows="2"
                                          onchange="updateScore('${req.id}')">${req.scoreRationale || ''}</textarea>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="openEvidenceModal('${req.id}')">
                                    <i class="bi bi-paperclip"></i> Evidence
                                    <span class="badge bg-primary">${req.evidenceCount || 0}</span>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="openNotesModal('${req.id}')">
                                    <i class="bi bi-sticky"></i> Notes
                                    <span class="badge bg-secondary">${req.notesCount || 0}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function updateProgress(data) {
        const pct = data.overallProgress || 0;
        const progressColor = pct >= 80 ? 'bg-success' : pct >= 50 ? 'bg-warning' : 'bg-secondary';

        const bar = document.getElementById('overallProgressBar');
        bar.style.width = `${pct}%`;
        bar.className = `progress-bar ${progressColor}`;
        document.getElementById('overallProgressText').textContent = `${pct.toFixed(0)}%`;

        document.getElementById('overallScore').textContent =
            data.overallScore ? `${data.overallScore.toFixed(0)}%` : '-';

        document.getElementById('completedCount').textContent = data.completedRequirements || 0;
        document.getElementById('inProgressCount').textContent = data.inProgressRequirements || 0;
        document.getElementById('pendingCount').textContent = data.pendingRequirements || 0;

        document.getElementById('progressSummary').textContent =
            `${data.completedRequirements || 0} of ${data.totalRequirements || 0} requirements completed`;
    }

    async function updateStatus(requirementId, status) {
        try {
            const response = await fetch(`/api/assessment-execution/requirement/${requirementId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });

            if (!response.ok) throw new Error('Failed to update status');

            showToast('success', 'Status updated successfully');
            await refreshProgress();

        } catch (error) {
            console.error('Error updating status:', error);
            showToast('error', 'Failed to update status');
        }
    }

    async function updateScore(requirementId) {
        const scoreInput = document.getElementById(`score-${requirementId}`);
        const rationaleInput = document.getElementById(`rationale-${requirementId}`);
        const score = parseInt(scoreInput.value) || 0;
        const rationale = rationaleInput.value;

        try {
            const response = await fetch(`/api/assessment-execution/requirement/${requirementId}/score`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ score, scoreRationale: rationale })
            });

            if (!response.ok) throw new Error('Failed to update score');

            showToast('success', 'Score updated successfully');
            await refreshProgress();

        } catch (error) {
            console.error('Error updating score:', error);
            showToast('error', 'Failed to update score');
        }
    }

    async function refreshProgress() {
        const response = await fetch(`/api/assessment-execution/${assessmentId}/progress`);
        if (response.ok) {
            const progress = await response.json();
            updateProgress({ ...assessmentData, ...progress });
        }
    }

    function openEvidenceModal(requirementId) {
        document.getElementById('evidenceRequirementId').value = requirementId;
        document.getElementById('evidenceTitle').value = '';
        document.getElementById('evidenceDescription').value = '';
        document.getElementById('evidenceFile').value = '';
        new bootstrap.Modal(document.getElementById('evidenceUploadModal')).show();
    }

    async function uploadEvidence() {
        const requirementId = document.getElementById('evidenceRequirementId').value;
        const title = document.getElementById('evidenceTitle').value;
        const file = document.getElementById('evidenceFile').files[0];

        if (!title || !file) {
            showToast('warning', 'Please provide a title and select a file');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('title', title);
        formData.append('description', document.getElementById('evidenceDescription').value);

        try {
            const response = await fetch(`/api/assessment-execution/requirement/${requirementId}/evidence`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Failed to upload evidence');
            }

            bootstrap.Modal.getInstance(document.getElementById('evidenceUploadModal')).hide();
            showToast('success', 'Evidence uploaded successfully');
            await loadAssessmentData();

        } catch (error) {
            console.error('Error uploading evidence:', error);
            showToast('error', error.message || 'Failed to upload evidence');
        }
    }

    function openNotesModal(requirementId) {
        document.getElementById('notesRequirementId').value = requirementId;
        document.getElementById('newNoteContent').value = '';
        loadNotes(requirementId);
        new bootstrap.Modal(document.getElementById('notesModal')).show();
    }

    async function loadNotes(requirementId) {
        try {
            const response = await fetch(`/api/assessment-execution/requirement/${requirementId}/notes`);
            if (!response.ok) throw new Error('Failed to load notes');

            const notes = await response.json();
            const container = document.getElementById('notesHistory');

            if (notes.length === 0) {
                container.innerHTML = '<p class="text-muted">No notes yet</p>';
            } else {
                container.innerHTML = notes.map(n => `
                    <div class="border-bottom pb-2 mb-2">
                        <small class="text-muted">${n.createdBy} - ${new Date(n.createdDate).toLocaleString()}</small>
                        <p class="mb-0">${n.content}</p>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading notes:', error);
        }
    }

    async function saveNote() {
        const requirementId = document.getElementById('notesRequirementId').value;
        const content = document.getElementById('newNoteContent').value;

        if (!content.trim()) {
            showToast('warning', 'Please enter a note');
            return;
        }

        try {
            const response = await fetch(`/api/assessment-execution/requirement/${requirementId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, noteType: 'General', isInternal: true })
            });

            if (!response.ok) throw new Error('Failed to save note');

            document.getElementById('newNoteContent').value = '';
            loadNotes(requirementId);
            showToast('success', 'Note saved successfully');
            await loadAssessmentData();

        } catch (error) {
            console.error('Error saving note:', error);
            showToast('error', 'Failed to save note');
        }
    }

    function showScoringGuide(requirementId, encodedGuide) {
        let guide = [];
        try {
            guide = JSON.parse(decodeURIComponent(encodedGuide));
        } catch (e) {
            guide = [];
        }

        const container = document.getElementById('scoringGuideContent');

        if (!guide || guide.length === 0) {
            container.innerHTML = `
                <p class="text-muted">No scoring guide available for this requirement.</p>
                <p>Default scoring criteria:</p>
                <ul>
                    <li><strong>80-100:</strong> Compliant - Fully implemented</li>
                    <li><strong>50-79:</strong> Partially Compliant - Partially implemented</li>
                    <li><strong>0-49:</strong> Non-Compliant - Not implemented or significant gaps</li>
                </ul>
            `;
        } else {
            container.innerHTML = `
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr><th>Score</th><th>Label</th><th>Criteria</th></tr>
                    </thead>
                    <tbody>
                        ${guide.map(g => `
                            <tr>
                                <td><strong>${g.score}</strong></td>
                                <td>${g.label || '-'}</td>
                                <td>${g.criteria || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        new bootstrap.Modal(document.getElementById('scoringGuideModal')).show();
    }

    function showToast(type, message) {
        // Create toast element
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        let container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }

        container.insertAdjacentHTML('beforeend', toastHtml);
        const toastEl = container.lastElementChild;
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        toast.show();

        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }

    function exportAssessment() {
        window.open(`/api/assessment/${assessmentId}/export?format=xlsx`, '_blank');
    }
</script>
}

<style>
    .card.border-success { border-left-color: var(--bs-success) !important; }
    .card.border-warning { border-left-color: var(--bs-warning) !important; }
    .card.border-danger { border-left-color: var(--bs-danger) !important; }
    .card.border-info { border-left-color: var(--bs-info) !important; }
    .card.border-secondary { border-left-color: var(--bs-secondary) !important; }
    .card.border-dark { border-left-color: var(--bs-dark) !important; }

    .accordion-button:not(.collapsed) {
        background-color: rgba(var(--bs-primary-rgb), 0.1);
    }

    .accordion-button:focus {
        box-shadow: none;
    }
</style>
