@page "/approvals/{ApprovalId:guid}/review"
@using GrcMvc.Models.DTOs
@using System.Text.Json
@inject IHttpContextAccessor HttpContextAccessor

@{
    var requestCulture = HttpContextAccessor.HttpContext?.Features.Get<IRequestCultureFeature>();
    var currentCulture = requestCulture?.RequestCulture?.UICulture?.Name ?? "ar";
    var dir = currentCulture == "ar" ? "rtl" : "ltr";
}

<PageTitle>@(currentCulture == "ar" ? "مراجعة الموافقة" : "Review Approval")</PageTitle>

<div dir="@dir" class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8">
            <h1 class="h3 mb-4">Review Approval</h1>

            @if (approval == null)
            {
                <div class="alert alert-warning">Approval not found</div>
            }
            else
            {
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">@approval.WorkflowName</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Status:</strong>
                                <span style="margin-left: 8px;">
                                    <StatusBadge Status="@approval.Status" />
                                </span>
                            </div>
                            <div class="col-md-6">
                                <strong>Priority:</strong>
                                <span class="badge bg-@GetPriorityColor(approval.Priority)"
                                    style="margin-left: 8px;">@approval.Priority</span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Submitted By:</strong>
                                <span style="margin-left: 8px;">@approval.SubmittedByName</span>
                            </div>
                            <div class="col-md-6">
                                <strong>Submitted Date:</strong>
                                <span style="margin-left: 8px;">@approval.SubmittedDate.ToString("MMM dd, yyyy")</span>
                            </div>
                        </div>

                        <hr />

                        <h6>Approval Type</h6>
                        <p>@approval.ApprovalType</p>

                        <h6>Description</h6>
                        <p>@approval.Description</p>
                    </div>
                </div>

                @if (approval.Status == "Pending")
                {
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Approval Decision</h5>
                        </div>
                        <div class="card-body">
                            <form @onsubmit="HandleApproval">
                                <div class="mb-3">
                                    <label for="comments" class="form-label">Comments</label>
                                    <textarea class="form-control" id="comments" rows="4" @bind="approvalComments"
                                placeholder="Add your feedback..."></textarea>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-success" @onclick="() => ApproveWorkflow()"
                                        disabled="@isProcessing">
                                        @if (isProcessing && lastAction == "approve")
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"
                                                aria-hidden="true"></span>
                                            <span>Approving...</span>
                                        }
                                        else
                                        {
                                            <span><i class="bi bi-check-circle"></i> Approve</span>
                                        }
                                    </button>
                                    <button type="button" class="btn btn-danger" @onclick="() => RejectWorkflow()"
                                        disabled="@isProcessing">
                                        @if (isProcessing && lastAction == "reject")
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"
                                                aria-hidden="true"></span>
                                            <span>Rejecting...</span>
                                        }
                                        else
                                        {
                                            <span><i class="bi bi-x-circle"></i> Reject</span>
                                        }
                                    </button>
                                </div>

                                @if (!string.IsNullOrEmpty(errorMessage))
                                {
                                    <div class="alert alert-danger mt-3">@errorMessage</div>
                                }

                                @if (!string.IsNullOrEmpty(successMessage))
                                {
                                    <div class="alert alert-success mt-3">@successMessage</div>
                                }
                            </form>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        This approval has already been <strong>@approval.Status</strong>.
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public Guid ApprovalId { get; set; }

    private ApprovalReviewDto? approval;
    private string approvalComments = string.Empty;
    private bool isProcessing = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private string lastAction = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadApproval();
    }

    private async Task LoadApproval()
    {
        try
        {
            var response = await Http.GetAsync($"/api/approvals/{ApprovalId}");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var apiResponse = System.Text.Json.JsonSerializer.Deserialize<GrcMvc.Models.ApiResponse<ApprovalReviewDto>>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (apiResponse?.Success == true && apiResponse.Data != null)
                {
                    approval = apiResponse.Data;
                }
            }
        }
        catch (Exception)
        {
            // Fall back to null - approval not found
        }
    }

    private async Task ApproveWorkflow()
    {
        lastAction = "approve";
        await SubmitDecision("Approved");
    }

    private async Task RejectWorkflow()
    {
        lastAction = "reject";
        await SubmitDecision("Rejected");
    }

    private async Task SubmitDecision(string decision)
    {
        if (approval == null)
            return;

        isProcessing = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            var endpoint = decision == "Approved" ? $"/api/approvals/{approval.Id}/approve" : $"/api/approvals/{approval.Id}/reject";
            var requestBody = new { comments = approvalComments, decision = decision };
            var json = JsonSerializer.Serialize(requestBody);
            var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
            
            var response = await Http.PostAsync(endpoint, content);
            if (response.IsSuccessStatusCode)
            {
                approval.Status = decision;
                successMessage = $"Approval {decision.ToLower()} successfully!";
            }
            else
            {
                errorMessage = $"Error submitting decision: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error submitting decision: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task HandleApproval()
    {
        // Form submission handler if needed
    }

    private string GetStatusColor(string status) => status switch
    {
        "Approved" => "success",
        "Rejected" => "danger",
        "Pending" => "warning",
        _ => "secondary"
    };

    private string GetPriorityColor(string priority) => priority switch
    {
        "Critical" => "danger",
        "High" => "warning",
        "Medium" => "info",
        "Low" => "secondary",
        _ => "secondary"
    };
}

@inject HttpClient Http
        "Rejected" => "danger",
        "Pending" => "warning",
        _ => "secondary"
    };

    private string GetPriorityColor(string priority) => priority switch
    {
        "Critical" => "danger",
        "High" => "warning",
        "Medium" => "info",
        "Low" => "secondary",
        _ => "secondary"
    };
}