@using GrcMvc.Models.DTOs
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IHttpContextAccessor HttpContextAccessor

@{
    var requestCulture = HttpContextAccessor.HttpContext?.Features.Get<IRequestCultureFeature>();
    var currentCulture = requestCulture?.RequestCulture?.UICulture?.Name ?? "ar";
    var dir = currentCulture == "ar" ? "rtl" : "ltr";
}

<div dir="@dir">
    <div class="text-center mb-5">
        <div class="mb-4">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
        </div>
        <h3 class="mb-3">Onboarding Complete!</h3>
        <p class="lead text-muted">Your GRC Management System is ready to use.</p>
    </div>

    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-header bg-success bg-opacity-10">
                    <h5 class="mb-0 text-success">
                        <i class="bi bi-check-circle"></i> What's Next
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-3">
                            <strong>1. Review Your Scope</strong>
                            <p class="text-muted small mb-0">Check the compliance frameworks and packages assigned to your organization.</p>
                        </li>
                        <li class="mb-3">
                            <strong>2. Create Risk Registry</strong>
                            <p class="text-muted small mb-0">Identify and catalog organizational risks relevant to your scope.</p>
                        </li>
                        <li class="mb-3">
                            <strong>3. Define Controls</strong>
                            <p class="text-muted small mb-0">Set up control measures to mitigate identified risks.</p>
                        </li>
                        <li>
                            <strong>4. Run Assessments</strong>
                            <p class="text-muted small mb-0">Execute assessments to evaluate control effectiveness.</p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-info">
                <div class="card-header bg-info bg-opacity-10">
                    <h5 class="mb-0 text-info">
                        <i class="bi bi-info-circle"></i> Your Scope Summary
                    </h5>
                </div>
                <div class="card-body">
                    @if (IsLoading)
                    {
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-info"></div>
                        </div>
                    }
                    else if (Scope != null)
                    {
                        <dl class="row">
                            <dt class="col-sm-6">Frameworks:</dt>
                            <dd class="col-sm-6">
                                <span class="badge bg-primary">@Scope.ApplicableFrameworks.Count</span>
                            </dd>
                            <dt class="col-sm-6">Packages:</dt>
                            <dd class="col-sm-6">
                                <span class="badge bg-info">@Scope.RecommendedPackages.Count</span>
                            </dd>
                            <dt class="col-sm-6">Templates:</dt>
                            <dd class="col-sm-6">
                                <span class="badge bg-warning">@Scope.ApplicableTemplates.Count</span>
                            </dd>
                            <dt class="col-sm-6">Audit Plans:</dt>
                            <dd class="col-sm-6">
                                <span class="badge bg-secondary">@Scope.AuditPackages.Count</span>
                            </dd>
                        </dl>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-info" role="alert">
        <i class="bi bi-lightbulb"></i>
        <strong>Pro Tip:</strong> Start by reviewing your assigned compliance frameworks in the Dashboard. You can then create your risk registry and control structure aligned with these frameworks.
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @ErrorMessage
        </div>
    }

    <div class="d-flex gap-2 mt-5">
        <button type="button" class="btn btn-outline-secondary" @onclick="() => OnBack.InvokeAsync()" disabled="@(IsSubmitting || IsLoading)">
            <i class="bi bi-arrow-left"></i> Back
        </button>
        <button type="button" class="btn btn-success btn-lg" @onclick="HandleCompleteOnboarding" disabled="@IsSubmitting">
            @if (IsSubmitting)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
                <span>Completing...</span>
            }
            else
            {
                <span><i class="bi bi-check-circle"></i> Go to Dashboard</span>
            }
        </button>
    </div>
</div>

@code {
    [Parameter]
    public Guid TenantId { get; set; }

    [Parameter]
    public EventCallback OnBack { get; set; }

    private OnboardingScopeDto? Scope;
    private bool IsLoading = true;
    private bool IsSubmitting = false;
    private string ErrorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadComplianceScope();
    }

    private async Task LoadComplianceScope()
    {
        IsLoading = true;

        try
        {
            var response = await Http.GetAsync($"/api/onboarding/derived-scope/{TenantId}");

            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                Scope = JsonSerializer.Deserialize<OnboardingScopeDto>(json);
            }
            else
            {
                // Mock data
                Scope = new OnboardingScopeDto
                {
                    TenantId = TenantId,
                    ApplicableFrameworks = new List<string> { "ISO 27001", "SOC 2 Type II", "NIST CSF" },
                    RecommendedPackages = new List<string> { "Information Security", "Access Control" },
                    ApplicableTemplatesList = new List<string> { "Risk Assessment", "Control Assessment" },
                    AuditPackages = new List<string> { "Annual Audit" }
                };
            }
        }
        catch
        {
            // Use mock data on error
            Scope = new OnboardingScopeDto
            {
                TenantId = TenantId,
                ApplicableFrameworks = new List<string> { "ISO 27001", "SOC 2 Type II" },
                RecommendedPackages = new List<string> { "Information Security", "Access Control" },
                ApplicableTemplatesList = new List<string> { "Risk Assessment" },
                AuditPackages = new List<string> { "Annual Audit" }
            };
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleCompleteOnboarding()
    {
        IsSubmitting = true;
        ErrorMessage = string.Empty;

        try
        {
            var response = await Http.PostAsJsonAsync($"/api/onboarding/complete/{TenantId}", new { userId = "current-user" });

            if (response.IsSuccessStatusCode)
            {
                // Navigate to dashboard
                await Task.Delay(1000);
                Navigation.NavigateTo("/dashboard", forceLoad: true);
            }
            else
            {
                var content = await response.Content.ReadAsStringAsync();
                ErrorMessage = $"Completion failed: {content}";
                IsSubmitting = false;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
            IsSubmitting = false;
        }
    }
}
