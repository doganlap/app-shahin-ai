@using GrcMvc.Application.Permissions
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Http
@inherits ComponentBase

@if (HasPermission(RequiredPermission))
{
    <button type="@ButtonType" 
            class="@CssClass" 
            disabled="@Disabled"
            @onclick="HandleClick"
            @attributes="AdditionalAttributes">
        @if (!string.IsNullOrEmpty(Icon))
        {
            <i class="@Icon me-1"></i>
        }
        @ChildContent
    </button>
}
else
{
    <button type="button" 
            class="@CssClass" 
            disabled="true"
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            title="@GetPermissionTooltip(RequiredPermission, ActionName ?? "perform this action")">
        @if (!string.IsNullOrEmpty(Icon))
        {
            <i class="@Icon me-1"></i>
        }
        @ChildContent
        @if (ShowLockIcon)
        {
            <i class="fas fa-lock ms-1"></i>
        }
    </button>
    
    @if (ShowRequestAccessButton)
    {
        <button type="button" 
                class="btn btn-sm btn-outline-secondary ms-2" 
                @onclick="() => RequestPermission(RequiredPermission)">
            <i class="fas fa-key me-1"></i> Request Access
        </button>
    }
}

@code {
    [Parameter] public string RequiredPermission { get; set; } = string.Empty;
    [Parameter] public string? ActionName { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public string ButtonType { get; set; } = "button";
    [Parameter] public string CssClass { get; set; } = "btn btn-primary";
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public string? Icon { get; set; }
    [Parameter] public bool ShowLockIcon { get; set; } = true;
    [Parameter] public bool ShowRequestAccessButton { get; set; } = true;
    [Parameter] public EventCallback OnClick { get; set; }
    [Parameter] public Dictionary<string, object>? AdditionalAttributes { get; set; }
    [Inject] protected IHttpContextAccessor HttpContextAccessor { get; set; } = null!;
    [Inject] protected NavigationManager Navigation { get; set; } = null!;

    private bool HasPermission(string permission)
    {
        return PermissionHelper.HasPermission(HttpContextAccessor.HttpContext, permission);
    }

    private string GetPermissionTooltip(string permission, string actionName)
    {
        if (HasPermission(permission))
            return string.Empty;

        var permissionName = permission.Split('.').Last();
        return $"You need '{permissionName}' permission to {actionName}. Contact your administrator to request access.";
    }

    private void RequestPermission(string permission)
    {
        Navigation.NavigateTo($"/admin/permissions/request?permission={permission}");
    }

    private async Task HandleClick()
    {
        if (!Disabled && HasPermission(RequiredPermission))
        {
            await OnClick.InvokeAsync();
        }
    }
}
