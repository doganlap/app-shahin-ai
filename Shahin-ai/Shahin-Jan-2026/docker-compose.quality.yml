# ============================================================
# Shahin GRC Quality Check Docker Compose
# Run: docker-compose -f docker-compose.quality.yml up --build
# ============================================================

version: '3.8'

services:
  # ============================================================
  # Quality Check Service - Full validation suite
  # ============================================================
  quality-check:
    build:
      context: .
      dockerfile: docker/Dockerfile.quality-check
    container_name: shahin-quality-check
    volumes:
      - ./src:/app/src:ro
      - ./scripts:/app/scripts:ro
      - ./quality-reports:/app/reports
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - VALIDATION_MODE=full
    command: ["./scripts/validate-all.sh"]

  # ============================================================
  # Build Validation Only - Quick check
  # ============================================================
  build-check:
    build:
      context: .
      dockerfile: docker/Dockerfile.quality-check
    container_name: shahin-build-check
    volumes:
      - ./src:/app/src:ro
      - ./scripts:/app/scripts:ro
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
    command: ["./scripts/validate-release.sh"]

  # ============================================================
  # Content Validation Only
  # ============================================================
  content-check:
    build:
      context: .
      dockerfile: docker/Dockerfile.quality-check
    container_name: shahin-content-check
    volumes:
      - ./src:/app/src:ro
      - ./scripts:/app/scripts:ro
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
    command: ["./scripts/validate-content.sh"]

  # ============================================================
  # Continuous Quality Monitor (for development)
  # ============================================================
  quality-monitor:
    build:
      context: .
      dockerfile: docker/Dockerfile.quality-check
    container_name: shahin-quality-monitor
    volumes:
      - ./src:/app/src:ro
      - ./scripts:/app/scripts:ro
    environment:
      - WATCH_MODE=true
    command: >
      bash -c "
        echo 'Quality Monitor Started - Press Ctrl+C to stop';
        while true; do
          echo '';
          echo '========== Quality Check: '$(date)' ==========';
          ./scripts/validate-all.sh || true;
          echo 'Next check in 5 minutes...';
          sleep 300;
        done
      "
