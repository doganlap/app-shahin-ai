version: '3.8'

# ══════════════════════════════════════════════════════════════════════════════
# SHAHIN AI GRC - PRODUCTION DOCKER COMPOSE
# ══════════════════════════════════════════════════════════════════════════════
# Purpose: Full production deployment with all layers
# Date: 2026-01-10
# Architecture:
#   - Nginx (Reverse Proxy & SSL Termination)
#   - GRC Application (ASP.NET Core)
#   - PostgreSQL (Primary Database)
#   - Redis (Caching & Sessions)
#   - Hangfire (Background Jobs)
# ══════════════════════════════════════════════════════════════════════════════

services:
  nginx:
    image: nginx:alpine
    container_name: shahin-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
      - ./src/GrcMvc/wwwroot:/var/www/static:ro
    networks:
      - shahin-network
    depends_on:
      - grc-app
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ════════════════════════════════════════════════════════════════════════════
  # 2. GRC APPLICATION - ASP.NET CORE
  # ════════════════════════════════════════════════════════════════════════════
  grc-app:
    build:
      context: ./src/GrcMvc
      dockerfile: Dockerfile.production
    image: shahin-ai/grc:latest
    container_name: shahin-grc-app
    restart: unless-stopped
    expose:
      - "5001"
    env_file:
      - .env.production.secure
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5001
      - AllowedHosts=shahin-ai.com;www.shahin-ai.com;portal.shahin-ai.com;app.shahin-ai.com;login.shahin-ai.com;localhost
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=grc_production;Username=grc_admin;Password=GrcProduction2026!;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100
      - ConnectionStrings__HangfireConnection=Host=postgres;Port=5432;Database=grc_production;Username=grc_admin;Password=GrcProduction2026!;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100
      - Redis__ConnectionString=redis:6379,abortConnect=false
      - Redis__Enabled=true
    volumes:
      - ./src/GrcMvc/certificates:/app/certificates:ro
      - grc-storage:/var/www/shahin-ai/storage
      - grc-logs:/var/log/grc
    networks:
      - shahin-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "https://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  # ════════════════════════════════════════════════════════════════════════════
  # 3. POSTGRESQL - PRIMARY DATABASE
  # ════════════════════════════════════════════════════════════════════════════
  postgres:
    image: postgres:15-alpine
    container_name: shahin-postgres
    restart: unless-stopped
    # SECURITY: Port removed - only accessible within Docker network
    # ports:
    #   - "5432:5432"
    environment:
      POSTGRES_DB: grc_production
      POSTGRES_USER: grc_admin
      POSTGRES_PASSWORD: GrcProduction2026!
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./backups:/backups
      - ./scripts/postgres/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - shahin-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d grc_production"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ════════════════════════════════════════════════════════════════════════════
  # 4. REDIS - CACHING & SESSION STORAGE
  # ════════════════════════════════════════════════════════════════════════════
  redis:
    image: redis:7-alpine
    container_name: shahin-redis
    restart: unless-stopped
    # SECURITY: Port removed - only accessible within Docker network
    # ports:
    #   - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD:-ShahinRedis2026} --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - shahin-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # ════════════════════════════════════════════════════════════════════════════
  # 5. HANGFIRE DASHBOARD (Optional - Separate Container for Monitoring)
  # ════════════════════════════════════════════════════════════════════════════
  # Uncomment if you want a dedicated Hangfire dashboard
  # hangfire-dashboard:
  #   build:
  #     context: ./src/GrcMvc
  #     dockerfile: Dockerfile.hangfire
  #   container_name: shahin-hangfire
  #   restart: unless-stopped
  #   ports:
  #     - "5002:5002"
  #   env_file:
  #     - .env.production.secure
  #   networks:
  #     - shahin-network
  #   depends_on:
  #     - postgres

  # ════════════════════════════════════════════════════════════════════════════
  # 6. BACKUP SERVICE - AUTOMATED DATABASE BACKUPS
  # ════════════════════════════════════════════════════════════════════════════
  backup:
    image: postgres:15-alpine
    container_name: shahin-backup
    restart: unless-stopped
    entrypoint: /backup/backup-entrypoint.sh
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: grc_production
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      BACKUP_SCHEDULE: "0 2 * * *"  # Daily at 2 AM
      BACKUP_RETENTION_DAYS: 30
    volumes:
      - ./backups:/backups
      - ./scripts/backup-entrypoint.sh:/backup/backup-entrypoint.sh:ro
    networks:
      - shahin-network
    depends_on:
      postgres:
        condition: service_healthy

# ══════════════════════════════════════════════════════════════════════════════
# NETWORKS
# ══════════════════════════════════════════════════════════════════════════════
networks:
  shahin-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ══════════════════════════════════════════════════════════════════════════════
# VOLUMES - PERSISTENT DATA STORAGE
# ══════════════════════════════════════════════════════════════════════════════
volumes:
  postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/shahin-ai/postgres

  redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/shahin-ai/redis

  grc-storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/www/shahin-ai/storage

  grc-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/log/shahin-ai

# ══════════════════════════════════════════════════════════════════════════════
# DEPLOYMENT INSTRUCTIONS
# ══════════════════════════════════════════════════════════════════════════════
#
# 1. Prerequisites:
#    - Docker Engine 24.0+
#    - Docker Compose 2.20+
#    - 8GB RAM minimum (16GB recommended)
#    - 50GB disk space
#
# 2. Initial Setup:
#    sudo mkdir -p /var/lib/shahin-ai/{postgres,redis}
#    sudo mkdir -p /var/www/shahin-ai/storage
#    sudo mkdir -p /var/log/shahin-ai
#    sudo chown -R 1000:1000 /var/lib/shahin-ai /var/www/shahin-ai /var/log/shahin-ai
#
# 3. Configure Environment:
#    cp .env.production.secure.template .env.production.secure
#    nano .env.production.secure  # Fill in all required values
#
# 4. Generate SSL Certificates:
#    cd src/GrcMvc/certificates
#    dotnet dev-certs https -ep aspnetapp.pfx -p "YOUR_CERT_PASSWORD"
#
# 5. Build and Start:
#    docker-compose -f docker-compose.production.yml build
#    docker-compose -f docker-compose.production.yml up -d
#
# 6. Run Migrations:
#    docker exec -it shahin-grc-app dotnet ef database update
#
# 7. Verify Health:
#    docker-compose -f docker-compose.production.yml ps
#    curl https://localhost/health
#
# 8. View Logs:
#    docker-compose -f docker-compose.production.yml logs -f grc-app
#
# 9. Stop:
#    docker-compose -f docker-compose.production.yml down
#
# 10. Backup:
#     docker exec shahin-backup /backup/backup-now.sh
#
# ══════════════════════════════════════════════════════════════════════════════
